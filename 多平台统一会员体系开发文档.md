# 📋 马术俱乐部多平台统一会员体系开发文档

## 📖 文档信息

| 项目名称 | 马术俱乐部多平台统一会员体系 |
|---------|---------------------------|
| 文档版本 | v1.0.0 |
| 创建时间 | 2025-01-20 |
| 更新时间 | 2025-01-20 |
| 文档状态 | 开发版 |

---

## 🎯 项目概述

### 项目目标
构建支持几百个微信小程序、APP及其他平台小程序的统一会员体系，实现跨平台数据完全一致，支撑100万会员规模。

### 核心特性
- ✅ **跨平台数据一致性**：用户在任何平台看到的数据完全相同
- ✅ **多应用支持**：支持几百个小程序/APP接入
- ✅ **自动账号合并**：基于手机号/unionId自动识别和合并账号
- ✅ **业务数据隔离**：不同俱乐部数据完全隔离
- ✅ **渐进式架构**：基于现有单体架构，支持后期微服务演进

### 技术栈
- **后端框架**：Spring Boot 3.x + MyBatis Plus
- **鉴权框架**：Sa-Token
- **数据库**：MySQL 8.0
- **缓存**：Redis 6.x
- **基础架构**：现有 smart-admin-api-java17-springboot3

---

## 🗄️ 数据库设计

### 表关系图
```
m_app_config (应用配置表)
    ↑ (app_id)
    |
m_platform_identity (平台身份绑定表)  
    ↑ (member_id)
    |
m_member (会员主表)
```

### 1. 扩展现有会员表（m_member）

```sql
-- 扩展现有 m_member 表
ALTER TABLE m_member ADD COLUMN platform_type VARCHAR(20) DEFAULT 'wechat_mini' COMMENT '注册平台类型';
ALTER TABLE m_member ADD COLUMN member_uuid VARCHAR(64) UNIQUE COMMENT '全局唯一标识UUID';

-- 添加索引
CREATE INDEX idx_member_uuid ON m_member(member_uuid);
CREATE INDEX idx_platform_type ON m_member(platform_type);  
CREATE INDEX idx_phone ON m_member(phone);
CREATE INDEX idx_union_id ON m_member(unionId);
```

### 2. 平台身份绑定表（m_platform_identity）

```sql
-- 平台身份映射表（核心表）
CREATE TABLE m_platform_identity (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    member_id BIGINT NOT NULL COMMENT '关联会员ID',
    platform_type ENUM('wechat_mini','alipay_mini','douyin_mini','qq_mini','app_ios','app_android','h5_web') NOT NULL COMMENT '平台类型',
    app_id VARCHAR(100) NOT NULL COMMENT '应用ID',
    platform_user_id VARCHAR(100) NOT NULL COMMENT '平台用户ID(openId等)',
    union_id VARCHAR(100) COMMENT '平台unionId',
    session_key VARCHAR(200) COMMENT '会话密钥（微信专用）',
    bind_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '绑定时间',
    last_login_time DATETIME COMMENT '最后登录时间',
    status TINYINT(1) DEFAULT 1 COMMENT '状态：1=正常，0=禁用',
    
    UNIQUE KEY uk_platform_user (platform_type, app_id, platform_user_id),
    INDEX idx_member_platform (member_id, platform_type),
    INDEX idx_union_id (union_id),
    FOREIGN KEY fk_member (member_id) REFERENCES m_member(member_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT '平台身份绑定表';
```

**字段说明**：
- `session_key`：微信小程序解密手机号等敏感信息专用，其他平台为NULL
- `union_id`：微信生态下多应用统一标识，支付宝等其他平台可能为NULL
- `platform_user_id`：各平台的用户唯一标识（openId、user_id等）

### 3. 应用配置表（m_app_config）

```sql
-- 应用配置表
CREATE TABLE m_app_config (
    app_id VARCHAR(100) PRIMARY KEY COMMENT '应用ID（小程序appid、APP包名等）',
    app_name VARCHAR(100) NOT NULL COMMENT '应用名称',
    platform_type VARCHAR(20) NOT NULL COMMENT '平台类型',
    app_secret VARCHAR(200) COMMENT '应用密钥',
    club_id BIGINT COMMENT '关联俱乐部ID（NULL表示全国通用）',
    business_domain VARCHAR(100) COMMENT '业务域（用于业务分类）',
    config_json TEXT COMMENT '平台特定配置（JSON格式）',
    status TINYINT(1) DEFAULT 1 COMMENT '应用状态：1=启用，0=禁用',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    
    INDEX idx_platform_type (platform_type),
    INDEX idx_club_id (club_id),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT '应用配置表';
```

### 4. 会员合并日志表（m_member_merge_log）

```sql
-- 会员合并日志表
CREATE TABLE m_member_merge_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    target_member_id BIGINT NOT NULL COMMENT '合并目标会员ID（保留）',
    source_member_id BIGINT NOT NULL COMMENT '合并来源会员ID（被合并）',
    merge_reason VARCHAR(200) COMMENT '合并原因',
    merge_data_json TEXT COMMENT '合并数据详情（JSON格式）',
    merge_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '合并时间',
    operator VARCHAR(50) COMMENT '操作人',
    
    INDEX idx_target_member (target_member_id),
    INDEX idx_source_member (source_member_id),
    INDEX idx_merge_time (merge_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT '会员合并日志';
```

---

## 📊 数据示例

### 示例场景设定
- **北京马术俱乐部**（club_id: 1001）：有微信小程序普通版、VIP版、支付宝小程序
- **上海马术俱乐部**（club_id: 1002）：有微信小程序、抖音小程序  
- **全国通用APP**（club_id: NULL）：iOS和Android版本

### 1. 应用配置数据（m_app_config）

```sql
INSERT INTO m_app_config VALUES 
-- 北京马术俱乐部应用
('wx_beijing_001', '北京马术俱乐部微信小程序', 'wechat_mini', 'wx_secret_001', 1001, 'beijing_club', 
 '{"theme":"blue","max_booking_days":30,"template_ids":["temp001","temp002"]}', 1, '2025-01-01 00:00:00'),

('wx_beijing_vip', '北京马术俱乐部VIP版', 'wechat_mini', 'wx_secret_vip', 1001, 'beijing_vip', 
 '{"theme":"gold","max_booking_days":60,"vip_features":["priority_booking","free_cancel"]}', 1, '2025-01-01 00:00:00'),

('ali_beijing_001', '北京马术俱乐部支付宝版', 'alipay_mini', 'ali_secret_001', 1001, 'beijing_club', 
 '{"theme":"blue","payment_methods":["alipay"]}', 1, '2025-01-01 00:00:00'),

-- 上海马术俱乐部应用
('wx_shanghai_001', '上海马术俱乐部小程序', 'wechat_mini', 'wx_secret_sh', 1002, 'shanghai_club', 
 '{"theme":"red","max_booking_days":45,"local_features":["weather_info"]}', 1, '2025-01-01 00:00:00'),

('dy_shanghai_001', '上海马术抖音小程序', 'douyin_mini', 'dy_secret_sh', 1002, 'shanghai_club', 
 '{"theme":"red","video_features":["course_video","coach_intro"]}', 1, '2025-01-01 00:00:00'),

-- 全国通用APP
('ios_app_national', '马术通iOS APP', 'app_ios', 'ios_secret_001', NULL, 'national', 
 '{"version":"1.0.0","features":["multi_club","gps_location"]}', 1, '2025-01-01 00:00:00'),

('android_app_national', '马术通Android APP', 'app_android', 'android_secret_001', NULL, 'national', 
 '{"version":"1.0.0","features":["multi_club","gps_location"]}', 1, '2025-01-01 00:00:00');
```

### 2. 会员数据（m_member）

```sql
INSERT INTO m_member (member_id, member_no, union_id, open_id, actual_name, phone, email, avatar_url, 
                      gender, birth_date, club_id, is_membership, membership_status, membership_expire_date, 
                      id_card_no, rider_cert_no, registration_status, created_by_guardian, disabled_flag, 
                      profile_data, default_coach_id, default_course_level, last_login_time, 
                      create_by, create_time, update_by, update_time, is_valid, is_delete, 
                      platform_type, member_uuid) VALUES 

-- 张三：多平台用户，北京俱乐部普通会员
(10001, 'BJ001', 'union_wx_zhang123', NULL, '张三', '13800138001', 'zhang@example.com', 
 'https://avatar.com/zhang.jpg', 1, '1990-05-15', 1001, 0, 0, NULL, '110101199005151234', NULL, 1, 0, 0, 
 '{"hobby":"jumping","level":"beginner"}', 2001, 'beginner', '2025-01-20 10:30:00', 
 'system', '2025-01-01 00:00:00', 'system', '2025-01-20 10:30:00', 1, 0, 
 'wechat_mini', 'uuid-zhang-0001'),

-- 李四：上海俱乐部VIP会员，有骑手证
(10002, 'SH001', 'union_wx_li456', NULL, '李四', '13800138002', 'li@example.com', 
 'https://avatar.com/li.jpg', 2, '1985-08-20', 1002, 1, 1, '2025-12-31', '310101198508201234', 'R001', 1, 0, 0, 
 '{"hobby":"dressage","level":"intermediate"}', 2002, 'intermediate', '2025-01-20 09:15:00', 
 'system', '2025-01-01 00:00:00', 'system', '2025-01-20 09:15:00', 1, 0, 
 'wechat_mini', 'uuid-li-0002'),

-- 王五：北京俱乐部会员，只用支付宝
(10003, 'BJ002', NULL, NULL, '王五', '13800138003', 'wang@example.com', 
 'https://avatar.com/wang.jpg', 1, '1992-03-10', 1001, 0, 0, NULL, NULL, NULL, 1, 0, 0, 
 '{"hobby":"trail","level":"beginner"}', NULL, 'beginner', '2025-01-19 16:20:00', 
 'system', '2025-01-01 00:00:00', 'system', '2025-01-19 16:20:00', 1, 0, 
 'alipay_mini', 'uuid-wang-0003');
```

### 3. 平台身份绑定数据（m_platform_identity）

```sql
INSERT INTO m_platform_identity VALUES 
-- 张三的多平台绑定（member_id: 10001）
(1, 10001, 'wechat_mini', 'wx_beijing_001', 'openid_wx_zhang_001', 'union_wx_zhang123', 'session_key_zhang_001', '2025-01-01 10:00:00', '2025-01-20 10:30:00', 1),
(2, 10001, 'wechat_mini', 'wx_beijing_vip', 'openid_wx_zhang_vip', 'union_wx_zhang123', 'session_key_zhang_vip', '2025-01-05 14:30:00', '2025-01-19 08:45:00', 1),
(3, 10001, 'alipay_mini', 'ali_beijing_001', 'openid_ali_zhang_001', NULL, NULL, '2025-01-10 16:20:00', '2025-01-18 19:30:00', 1),
(4, 10001, 'app_ios', 'ios_app_national', 'device_uuid_zhang_ios', NULL, NULL, '2025-01-15 09:15:00', '2025-01-20 07:20:00', 1),

-- 李四的多平台绑定（member_id: 10002）
(5, 10002, 'wechat_mini', 'wx_shanghai_001', 'openid_wx_li_001', 'union_wx_li456', 'session_key_li_001', '2025-01-01 11:00:00', '2025-01-20 09:15:00', 1),
(6, 10002, 'douyin_mini', 'dy_shanghai_001', 'openid_dy_li_001', NULL, NULL, '2025-01-08 15:30:00', '2025-01-19 20:45:00', 1),
(7, 10002, 'app_android', 'android_app_national', 'device_uuid_li_android', NULL, NULL, '2025-01-12 13:20:00', '2025-01-18 22:10:00', 1),

-- 王五的单平台绑定（member_id: 10003）
(8, 10003, 'alipay_mini', 'ali_beijing_001', 'openid_ali_wang_001', NULL, NULL, '2025-01-01 12:00:00', '2025-01-19 16:20:00', 1);
```

### 数据关系分析

#### 张三（member_id: 10001）的完整画像
**基础信息**：北京马术俱乐部会员，手机号13800138001

**平台绑定情况**：
1. **北京俱乐部微信小程序**（wx_beijing_001）- 普通版
2. **北京俱乐部会员版小程序**（wx_beijing_vip）- VIP版  
3. **北京俱乐部支付宝小程序**（ali_beijing_001）
4. **马术通iOS APP**（ios_app_national）

**业务含义**：
- 张三可以通过4个不同平台登录
- 在微信生态内通过unionId（union_wx_zhang123）识别为同一用户
- 在所有平台看到的个人信息完全一致
- 在北京俱乐部的所有应用内享受会员权益

---

## 🏗️ 代码架构设计

### 项目包结构
```
net.lab1024.sa.admin.module
├── business.member          # 现有会员模块（扩展）
└── platform                # 新增平台适配模块
    ├── adapter             # 平台适配器
    │   ├── PlatformAdapter.java
    │   ├── WechatMiniAdapter.java
    │   ├── AlipayMiniAdapter.java
    │   └── DouyinMiniAdapter.java
    ├── controller          # 统一认证控制器
    │   ├── UnifiedAuthController.java
    │   └── UnifiedMemberController.java
    ├── service             # 核心业务服务
    │   ├── UnifiedAuthService.java
    │   ├── PlatformIdentityService.java
    │   ├── AppConfigService.java
    │   └── AccountMergeService.java
    ├── domain              # 数据模型
    │   ├── entity
    │   ├── vo
    │   └── dto
    └── dao                 # 数据访问层
        ├── PlatformIdentityDao.java
        └── AppConfigDao.java
```

### 1. 平台适配器接口设计

```java
/**
 * 平台适配器接口
 * 统一不同平台的登录和用户信息获取逻辑
 */
public interface PlatformAdapter {
    
    /**
     * 平台登录
     * @param code 平台登录凭证
     * @param appConfig 应用配置
     * @return 平台登录结果
     */
    PlatformLoginResult login(String code, AppConfig appConfig);
    
    /**
     * 获取用户手机号（微信小程序专用）
     * @param code 手机号授权码
     * @param sessionKey 会话密钥
     * @return 手机号
     */
    String getPhoneNumber(String code, String sessionKey);
    
    /**
     * 获取用户信息
     * @param platformUserId 平台用户ID
     * @param appConfig 应用配置
     * @return 用户信息
     */
    PlatformUserInfo getUserInfo(String platformUserId, AppConfig appConfig);
    
    /**
     * 刷新访问凭证
     * @param refreshToken 刷新令牌
     * @param appConfig 应用配置
     * @return 新的访问凭证
     */
    PlatformTokenResult refreshToken(String refreshToken, AppConfig appConfig);
}
```

### 2. 微信小程序适配器实现

```java
/**
 * 微信小程序适配器
 */
@Component("wechatMiniAdapter")
@Slf4j
public class WechatMiniAdapter implements PlatformAdapter {
    
    private static final String WECHAT_API_URL = "https://api.weixin.qq.com/sns/jscode2session";
    private static final String PHONE_API_URL = "https://api.weixin.qq.com/wxa/business/getuserphonenumber";
    
    @Autowired
    private RestTemplate restTemplate;
    
    @Override
    public PlatformLoginResult login(String code, AppConfig appConfig) {
        try {
            // 1. 调用微信接口获取openId和sessionKey
            String url = String.format("%s?appid=%s&secret=%s&js_code=%s&grant_type=authorization_code",
                WECHAT_API_URL, appConfig.getAppId(), appConfig.getAppSecret(), code);
                
            WechatLoginResponse response = restTemplate.getForObject(url, WechatLoginResponse.class);
            
            if (response.getErrcode() != null && response.getErrcode() != 0) {
                throw new BusinessException("微信登录失败：" + response.getErrmsg());
            }
            
            // 2. 构建返回结果
            return PlatformLoginResult.builder()
                .platformUserId(response.getOpenid())
                .unionId(response.getUnionid())
                .sessionKey(response.getSessionKey())
                .platform("wechat_mini")
                .success(true)
                .build();
                
        } catch (Exception e) {
            log.error("微信小程序登录失败, code: {}, appId: {}", code, appConfig.getAppId(), e);
            throw new BusinessException("微信登录失败");
        }
    }
    
    @Override
    public String getPhoneNumber(String code, String sessionKey) {
        try {
            // 微信获取手机号接口调用
            WechatPhoneRequest request = new WechatPhoneRequest();
            request.setCode(code);
            
            WechatPhoneResponse response = restTemplate.postForObject(
                PHONE_API_URL + "?access_token=" + getAccessToken(), 
                request, 
                WechatPhoneResponse.class);
                
            if (response.getErrcode() == 0) {
                return response.getPhoneInfo().getPhoneNumber();
            } else {
                throw new BusinessException("获取手机号失败：" + response.getErrmsg());
            }
            
        } catch (Exception e) {
            log.error("获取微信手机号失败, code: {}", code, e);
            throw new BusinessException("获取手机号失败");
        }
    }
    
    private String getAccessToken() {
        // 获取微信AccessToken的逻辑
        // 可以缓存在Redis中，定期刷新
        return "ACCESS_TOKEN";
    }
}
```

### 3. 统一认证服务核心实现

```java
/**
 * 统一认证服务
 * 处理多平台登录和账号合并逻辑
 */
@Service
@Slf4j
public class UnifiedAuthService {
    
    @Autowired
    private PlatformAdapterFactory platformAdapterFactory;
    
    @Autowired
    private PlatformIdentityService platformIdentityService;
    
    @Autowired
    private MemberService memberService;
    
    @Autowired
    private AppConfigService appConfigService;
    
    @Autowired
    private AccountMergeService accountMergeService;
    
    /**
     * 统一登录入口
     */
    @Transactional
    public UnifiedLoginResult login(UnifiedLoginRequest request) {
        log.info("统一登录开始, platformType: {}, appId: {}", request.getPlatformType(), request.getAppId());
        
        // 1. 获取应用配置
        AppConfig appConfig = appConfigService.getAppConfig(request.getAppId());
        validateAppConfig(appConfig, request.getPlatformType());
        
        // 2. 平台登录获取用户信息
        PlatformAdapter adapter = platformAdapterFactory.getAdapter(request.getPlatformType());
        PlatformLoginResult platformResult = adapter.login(request.getCode(), appConfig);
        
        // 3. 处理手机号（如果提供）
        String phoneNumber = null;
        if (StringUtils.isNotEmpty(request.getPhoneCode()) && 
            "wechat_mini".equals(request.getPlatformType())) {
            phoneNumber = adapter.getPhoneNumber(request.getPhoneCode(), platformResult.getSessionKey());
            platformResult.setPhone(phoneNumber);
        }
        
        // 4. 查找或创建会员
        MemberEntity member = findOrCreateMember(platformResult, appConfig, request);
        
        // 5. 创建或更新平台身份绑定
        PlatformIdentity identity = createOrUpdatePlatformIdentity(member.getMemberId(), 
            request.getPlatformType(), request.getAppId(), platformResult);
        
        // 6. 生成Sa-Token
        StpUtil.login(member.getMemberId());
        String token = StpUtil.getTokenValue();
        
        // 7. 设置Token上下文信息
        setTokenContext(member.getMemberId(), request.getPlatformType(), request.getAppId());
        
        // 8. 缓存用户信息
        cacheMemberInfo(member);
        
        log.info("统一登录成功, memberId: {}, platform: {}", member.getMemberId(), request.getPlatformType());
        
        return buildLoginResult(member, token, appConfig, identity);
    }
    
    /**
     * 查找或创建会员
     */
    private MemberEntity findOrCreateMember(PlatformLoginResult platformResult, 
                                          AppConfig appConfig, 
                                          UnifiedLoginRequest request) {
        
        // 1. 通过平台身份查找现有绑定
        PlatformIdentity existingIdentity = platformIdentityService.findByPlatformUser(
            request.getPlatformType(), request.getAppId(), platformResult.getPlatformUserId());
            
        if (existingIdentity != null) {
            MemberEntity member = memberService.getMemberById(existingIdentity.getMemberId());
            // 实时同步最新平台信息
            syncLatestPlatformDataToMember(member, platformResult, request);
            return member;
        }
        
        // 2. 通过unionId查找现有会员
        MemberEntity member = null;
        if (StringUtils.isNotEmpty(platformResult.getUnionId())) {
            member = memberService.getMemberByUnionId(platformResult.getUnionId());
        }
        
        // 3. 通过手机号查找现有会员
        if (member == null && StringUtils.isNotEmpty(platformResult.getPhone())) {
            MemberEntity phoneOwner = memberService.getMemberByPhone(platformResult.getPhone());
            if (phoneOwner != null) {
                // 触发账号合并逻辑
                member = handlePhoneNumberConflict(phoneOwner, platformResult, appConfig);
            }
        }
        
        // 4. 创建新会员
        if (member == null) {
            member = createNewMember(platformResult, appConfig, request);
        }
        
        return member;
    }
    
    /**
     * 实时同步平台数据到会员表
     */
    private void syncLatestPlatformDataToMember(MemberEntity member, 
                                              PlatformLoginResult platformResult, 
                                              UnifiedLoginRequest request) {
        boolean needUpdate = false;
        
        // 头像同步策略：使用最新的非空头像
        if (StringUtils.isNotEmpty(request.getAvatarUrl()) && 
            !request.getAvatarUrl().equals(member.getAvatarUrl())) {
            member.setAvatarUrl(request.getAvatarUrl());
            needUpdate = true;
        }
        
        // 昵称同步策略：补充空值
        if (StringUtils.isNotEmpty(request.getNickName()) && 
            StringUtils.isEmpty(member.getActualName())) {
            member.setActualName(request.getNickName());
            needUpdate = true;
        }
        
        // unionId同步
        if (StringUtils.isNotEmpty(platformResult.getUnionId()) && 
            StringUtils.isEmpty(member.getUnionId())) {
            member.setUnionId(platformResult.getUnionId());
            needUpdate = true;
        }
        
        // 手机号同步
        if (StringUtils.isNotEmpty(platformResult.getPhone()) && 
            !platformResult.getPhone().equals(member.getPhone())) {
            member.setPhone(platformResult.getPhone());
            needUpdate = true;
        }
        
        if (needUpdate) {
            member.setLastLoginTime(LocalDateTime.now());
            member.setUpdateTime(LocalDateTime.now());
            memberService.updateMember(member);
            
            // 清除缓存
            clearMemberCache(member.getMemberId());
        }
    }
}
```

### 4. 统一认证控制器

```java
/**
 * 统一认证控制器
 */
@RestController
@RequestMapping("/api/unified/auth")
@Tag(name = "统一认证接口")
@Slf4j
public class UnifiedAuthController {
    
    @Autowired
    private UnifiedAuthService unifiedAuthService;
    
    /**
     * 统一登录接口
     */
    @PostMapping("/login")
    @Operation(summary = "统一平台登录")
    @NoNeedLogin
    public ResponseDTO<UnifiedLoginResult> login(@Valid @RequestBody UnifiedLoginRequest request) {
        log.info("收到统一登录请求: platformType={}, appId={}", request.getPlatformType(), request.getAppId());
        
        UnifiedLoginResult result = unifiedAuthService.login(request);
        
        return ResponseDTO.ok(result);
    }
    
    /**
     * 绑定手机号
     */
    @PostMapping("/bind-phone")
    @Operation(summary = "绑定手机号")
    public ResponseDTO<Void> bindPhone(@Valid @RequestBody BindPhoneRequest request) {
        Long memberId = getCurrentMemberId();
        unifiedAuthService.bindPhone(memberId, request);
        return ResponseDTO.ok();
    }
    
    /**
     * 手机号换绑
     */
    @PostMapping("/change-phone")
    @Operation(summary = "手机号换绑") 
    public ResponseDTO<Void> changePhone(@Valid @RequestBody ChangePhoneRequest request) {
        Long memberId = getCurrentMemberId();
        unifiedAuthService.changePhone(memberId, request);
        return ResponseDTO.ok();
    }
    
    /**
     * 账号合并
     */
    @PostMapping("/merge-account")
    @Operation(summary = "手动合并账号")
    public ResponseDTO<Void> mergeAccount(@Valid @RequestBody MergeAccountRequest request) {
        Long memberId = getCurrentMemberId();
        unifiedAuthService.mergeAccount(memberId, request);
        return ResponseDTO.ok();
    }
    
    /**
     * 获取当前登录会员ID
     */
    private Long getCurrentMemberId() {
        return StpUtil.getLoginIdAsLong();
    }
}
```

---

## 📡 API接口文档

### 1. 统一登录接口

#### 请求示例
```http
POST /api/unified/auth/login
Content-Type: application/json

{
  "platformType": "wechat_mini",
  "appId": "wx_beijing_001",
  "code": "061gHl0w3oJW2s2uKf2w3Bt**",
  "phoneCode": "phone_auth_code_optional",
  "avatarUrl": "https://avatar.example.com/user.jpg",
  "nickName": "张三"
}
```

#### 响应示例
```json
{
  "code": 1,
  "msg": "success", 
  "data": {
    "token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
    "member": {
      "memberId": 10001,
      "memberNo": "BJ001",
      "memberUuid": "uuid-zhang-0001",
      "actualName": "张三",
      "phone": "138****8001",
      "avatarUrl": "https://avatar.example.com/user.jpg",
      "gender": 1,
      "clubId": 1001,
      "clubName": "北京马术俱乐部",
      "isMembership": 0,
      "registrationStatus": 1
    },
    "platformInfo": {
      "platformType": "wechat_mini",
      "appId": "wx_beijing_001",
      "appName": "北京马术俱乐部微信小程序",
      "isNewBind": false,
      "bindTime": "2025-01-01T10:00:00"
    },
    "permissions": ["member:read", "booking:create", "course:view"]
  }
}
```

### 2. 获取用户资料接口

#### 请求示例
```http
GET /api/unified/member/profile
Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...
```

#### 响应示例
```json
{
  "code": 1,
  "msg": "success",
  "data": {
    "member": {
      "memberId": 10001,
      "memberNo": "BJ001", 
      "actualName": "张三",
      "phone": "138****8001",
      "email": "zhang@example.com",
      "avatarUrl": "https://avatar.example.com/user.jpg",
      "gender": 1,
      "birthDate": "1990-05-15",
      "clubId": 1001,
      "clubName": "北京马术俱乐部"
    },
    "platformBindings": [
      {
        "platformType": "wechat_mini",
        "appId": "wx_beijing_001",
        "appName": "北京马术俱乐部微信小程序",
        "bindTime": "2025-01-01T10:00:00",
        "lastLoginTime": "2025-01-20T10:30:00"
      },
      {
        "platformType": "alipay_mini", 
        "appId": "ali_beijing_001",
        "appName": "北京马术俱乐部支付宝版",
        "bindTime": "2025-01-10T16:20:00",
        "lastLoginTime": "2025-01-18T19:30:00"
      }
    ],
    "currentPlatform": {
      "platformType": "wechat_mini",
      "appId": "wx_beijing_001"
    }
  }
}
```

### 3. 手机号换绑接口

#### 请求示例
```http
POST /api/unified/auth/change-phone
Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...
Content-Type: application/json

{
  "oldPhoneVerifyCode": "123456",
  "newPhone": "13900139000", 
  "newPhoneVerifyCode": "654321",
  "platformCode": "phone_auth_code_from_platform"
}
```

#### 响应示例
```json
{
  "code": 1,
  "msg": "手机号换绑成功",
  "data": null
}
```

---

## 💾 缓存策略

### Redis缓存设计

```java
/**
 * 会员缓存服务
 */
@Service
@Slf4j
public class MemberCacheService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // 缓存Key常量
    public static class CacheKey {
        public static final String MEMBER_INFO = "member:unified:%d";
        public static final String PLATFORM_IDENTITY = "member:platform:%s:%s:%s"; // platformType:appId:platformUserId
        public static final String MEMBER_PLATFORMS = "member:platforms:%d";
        public static final String APP_CONFIG = "app:config:%s";
        public static final String MEMBER_PERMISSION = "member:permission:%d:%s"; // memberId:platformType
    }
    
    /**
     * 缓存会员信息
     */
    public void cacheMemberInfo(MemberEntity member) {
        String key = String.format(CacheKey.MEMBER_INFO, member.getMemberId());
        redisTemplate.opsForValue().set(key, member, Duration.ofMinutes(30));
        log.debug("缓存会员信息: key={}, memberId={}", key, member.getMemberId());
    }
    
    /**
     * 获取缓存的会员信息
     */
    public MemberEntity getCachedMemberInfo(Long memberId) {
        String key = String.format(CacheKey.MEMBER_INFO, memberId);
        return (MemberEntity) redisTemplate.opsForValue().get(key);
    }
    
    /**
     * 缓存平台身份映射
     */
    public void cachePlatformIdentity(String platformType, String appId, String platformUserId, Long memberId) {
        String key = String.format(CacheKey.PLATFORM_IDENTITY, platformType, appId, platformUserId);
        redisTemplate.opsForValue().set(key, memberId, Duration.ofHours(1));
    }
    
    /**
     * 缓存应用配置
     */
    public void cacheAppConfig(AppConfig appConfig) {
        String key = String.format(CacheKey.APP_CONFIG, appConfig.getAppId());
        redisTemplate.opsForValue().set(key, appConfig, Duration.ofHours(4));
    }
    
    /**
     * 清除会员所有相关缓存
     */
    public void clearMemberAllCache(Long memberId) {
        // 1. 清除会员基础信息缓存
        String memberKey = String.format(CacheKey.MEMBER_INFO, memberId);
        redisTemplate.delete(memberKey);
        
        // 2. 清除会员平台列表缓存
        String platformsKey = String.format(CacheKey.MEMBER_PLATFORMS, memberId);
        redisTemplate.delete(platformsKey);
        
        // 3. 清除权限缓存
        Set<String> permissionKeys = redisTemplate.keys(
            String.format(CacheKey.MEMBER_PERMISSION, memberId, "*"));
        if (!CollectionUtils.isEmpty(permissionKeys)) {
            redisTemplate.delete(permissionKeys);
        }
        
        // 4. 清除Sa-Token会话缓存
        StpUtil.logout(memberId);
        
        log.info("清除会员全部缓存: memberId={}", memberId);
    }
}
```

### 缓存更新策略

| 缓存类型 | 缓存时长 | 更新策略 | 清除时机 |
|---------|---------|---------|---------|
| 会员基础信息 | 30分钟 | 写入时更新 | 个人信息修改时 |
| 平台身份映射 | 1小时 | 写入时更新 | 新增绑定时 |
| 应用配置 | 4小时 | 主动更新 | 配置修改时 |
| 权限信息 | 2小时 | 登录时更新 | 权限变更时 |

---

## 🚀 开发实施计划

### 阶段一：数据库和基础架构（1-2周）

#### 任务清单
- [ ] **数据库表创建**
  - 创建 `m_platform_identity` 表
  - 创建 `m_app_config` 表  
  - 创建 `m_member_merge_log` 表
  - 扩展现有 `m_member` 表字段
  
- [ ] **基础配置初始化**
  - 导入应用配置数据
  - 为现有会员生成UUID
  - 数据一致性检查脚本

#### 建表SQL脚本
```sql
-- 执行顺序：
-- 1. 扩展m_member表
-- 2. 创建m_platform_identity表
-- 3. 创建m_app_config表
-- 4. 创建m_member_merge_log表
-- 5. 初始化应用配置数据
-- 6. 数据迁移和索引优化
```

### 阶段二：平台适配器开发（2-3周）

#### 微信小程序适配器
- [ ] 实现微信登录接口调用
- [ ] 实现微信手机号获取
- [ ] 实现AccessToken管理和缓存
- [ ] 异常处理和重试机制

#### 支付宝小程序适配器  
- [ ] 实现支付宝登录接口
- [ ] 实现用户信息获取
- [ ] 支付宝特有配置处理

#### 抖音小程序适配器
- [ ] 实现抖音登录接口
- [ ] 视频相关特性支持
- [ ] 抖音开放平台集成

### 阶段三：统一认证服务（2-3周）

#### 核心业务逻辑
- [ ] 统一登录服务开发
- [ ] 账号自动合并逻辑
- [ ] 平台身份管理服务
- [ ] 数据同步机制

#### API接口开发
- [ ] 统一登录接口
- [ ] 用户资料接口
- [ ] 手机号换绑接口
- [ ] 账号合并接口

### 阶段四：测试和优化（1-2周）

#### 功能测试
- [ ] 单平台登录测试
- [ ] 跨平台数据一致性测试
- [ ] 账号合并功能测试
- [ ] 异常场景测试

#### 性能优化
- [ ] 数据库查询优化
- [ ] Redis缓存优化
- [ ] 接口响应时间优化
- [ ] 并发压力测试

---

## 📊 数据库索引优化

### 推荐索引配置

```sql
-- m_member表索引优化
CREATE INDEX idx_member_phone ON m_member(phone);
CREATE INDEX idx_member_union_id ON m_member(unionId); 
CREATE INDEX idx_member_club_status ON m_member(club_id, is_valid, is_delete);
CREATE INDEX idx_member_create_time ON m_member(create_time);

-- m_platform_identity表索引
CREATE UNIQUE INDEX uk_platform_user ON m_platform_identity(platform_type, app_id, platform_user_id);
CREATE INDEX idx_member_platform ON m_platform_identity(member_id, platform_type);
CREATE INDEX idx_union_id ON m_platform_identity(union_id);
CREATE INDEX idx_last_login_time ON m_platform_identity(last_login_time);

-- m_app_config表索引
CREATE INDEX idx_platform_club ON m_app_config(platform_type, club_id);
CREATE INDEX idx_status_create ON m_app_config(status, create_time);

-- m_member_merge_log表索引
CREATE INDEX idx_target_member_time ON m_member_merge_log(target_member_id, merge_time);
CREATE INDEX idx_source_member ON m_member_merge_log(source_member_id);
```

---

## 🔒 安全注意事项

### 1. 敏感数据保护

```java
/**
 * 敏感信息脱敏工具
 */
@Component
public class DataMaskingUtil {
    
    /**
     * 手机号脱敏
     */
    public static String maskPhone(String phone) {
        if (StringUtils.isEmpty(phone) || phone.length() < 7) {
            return phone;
        }
        return phone.substring(0, 3) + "****" + phone.substring(7);
    }
    
    /**
     * 身份证脱敏
     */
    public static String maskIdCard(String idCard) {
        if (StringUtils.isEmpty(idCard) || idCard.length() < 8) {
            return idCard;
        }
        return idCard.substring(0, 4) + "**********" + idCard.substring(14);
    }
}
```

### 2. 接口安全防护

```java
/**
 * 接口安全拦截器
 */
@Component
public class SecurityInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        // 1. 频率限制检查
        if (!rateLimitCheck(request)) {
            throw new BusinessException("请求过于频繁");
        }
        
        // 2. IP白名单检查（生产环境）
        if (isProductionEnv() && !ipWhitelistCheck(request)) {
            throw new BusinessException("访问被拒绝");
        }
        
        // 3. 签名校验（重要接口）
        if (needSignatureVerify(request) && !signatureVerify(request)) {
            throw new BusinessException("签名验证失败");
        }
        
        return true;
    }
}
```

### 3. 日志安全

```java
/**
 * 安全日志配置
 */
@Slf4j
public class SecurityLogger {
    
    /**
     * 登录日志（脱敏）
     */
    public void logLogin(Long memberId, String phone, String platformType, String appId) {
        log.info("用户登录成功 - 会员ID: {}, 手机号: {}, 平台: {}, 应用: {}", 
            memberId, DataMaskingUtil.maskPhone(phone), platformType, appId);
    }
    
    /**
     * 敏感操作日志
     */
    public void logSensitiveOperation(Long memberId, String operation, String details) {
        log.warn("敏感操作 - 会员ID: {}, 操作: {}, 详情: {}", memberId, operation, details);
    }
}
```

---

## 📈 监控和运维

### 1. 关键指标监控

```yaml
# 监控指标配置
monitoring:
  metrics:
    - name: "登录成功率"
      expression: "login_success_count / login_total_count * 100"
      threshold: "> 95%"
    
    - name: "接口响应时间" 
      expression: "avg(response_time)"
      threshold: "< 500ms"
      
    - name: "账号合并频率"
      expression: "account_merge_count / hour"
      threshold: "< 100/hour"
      
    - name: "缓存命中率"
      expression: "cache_hit_count / cache_total_count * 100"  
      threshold: "> 80%"
```

### 2. 异常告警配置

```java
/**
 * 异常监控服务
 */
@Service
public class AlertService {
    
    /**
     * 登录异常告警
     */
    public void alertLoginException(String platformType, String appId, Exception e) {
        if (isHighPriorityException(e)) {
            sendAlert(String.format("登录异常告警 - 平台: %s, 应用: %s, 异常: %s", 
                platformType, appId, e.getMessage()));
        }
    }
    
    /**
     * 数据一致性异常告警
     */
    public void alertDataConsistencyError(Long memberId, String details) {
        sendAlert(String.format("数据一致性异常 - 会员ID: %s, 详情: %s", memberId, details));
    }
}
```

---

## 📝 总结

本开发文档提供了马术俱乐部多平台统一会员体系的完整技术方案，包括：

### ✅ 核心优势
- **架构简洁**：基于现有单体架构，最小化改造成本
- **数据一致**：跨平台数据完全同步，无主平台概念
- **高度扩展**：支持几百个应用接入，插件化平台适配
- **业务友好**：完善的账号合并和手机号换绑功能
- **性能优越**：支撑百万会员，响应时间<500ms

### 📈 项目收益
- **开发效率**：统一的用户体系，减少重复开发
- **用户体验**：跨平台数据同步，无缝切换使用
- **业务增长**：支持快速扩展到新平台和新应用
- **运维简化**：统一的用户管理和数据维护

### 🎯 实施建议
1. **分阶段实施**：按照4个阶段逐步推进，确保稳定性
2. **充分测试**：重点测试跨平台数据一致性和账号合并功能
3. **性能调优**：关注数据库索引和缓存策略优化  
4. **安全加固**：敏感数据脱敏和接口安全防护
5. **监控完善**：建立完整的监控告警体系

**预计总开发周期**：8-12周  
**预期性能指标**：支持100万会员，5000QPS，登录响应时间<500ms  
**技术风险**：低，基于成熟的Spring Boot和Sa-Token框架