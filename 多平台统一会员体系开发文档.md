# ğŸ“‹ é©¬æœ¯ä¿±ä¹éƒ¨å¤šå¹³å°ç»Ÿä¸€ä¼šå‘˜ä½“ç³»å¼€å‘æ–‡æ¡£

## ğŸ“– æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›®åç§° | é©¬æœ¯ä¿±ä¹éƒ¨å¤šå¹³å°ç»Ÿä¸€ä¼šå‘˜ä½“ç³» |
|---------|---------------------------|
| æ–‡æ¡£ç‰ˆæœ¬ | v1.0.0 |
| åˆ›å»ºæ—¶é—´ | 2025-01-20 |
| æ›´æ–°æ—¶é—´ | 2025-01-20 |
| æ–‡æ¡£çŠ¶æ€ | å¼€å‘ç‰ˆ |

---

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

### é¡¹ç›®ç›®æ ‡
æ„å»ºæ”¯æŒå‡ ç™¾ä¸ªå¾®ä¿¡å°ç¨‹åºã€APPåŠå…¶ä»–å¹³å°å°ç¨‹åºçš„ç»Ÿä¸€ä¼šå‘˜ä½“ç³»ï¼Œå®ç°è·¨å¹³å°æ•°æ®å®Œå…¨ä¸€è‡´ï¼Œæ”¯æ’‘100ä¸‡ä¼šå‘˜è§„æ¨¡ã€‚

### æ ¸å¿ƒç‰¹æ€§
- âœ… **è·¨å¹³å°æ•°æ®ä¸€è‡´æ€§**ï¼šç”¨æˆ·åœ¨ä»»ä½•å¹³å°çœ‹åˆ°çš„æ•°æ®å®Œå…¨ç›¸åŒ
- âœ… **å¤šåº”ç”¨æ”¯æŒ**ï¼šæ”¯æŒå‡ ç™¾ä¸ªå°ç¨‹åº/APPæ¥å…¥
- âœ… **è‡ªåŠ¨è´¦å·åˆå¹¶**ï¼šåŸºäºæ‰‹æœºå·/unionIdè‡ªåŠ¨è¯†åˆ«å’Œåˆå¹¶è´¦å·
- âœ… **ä¸šåŠ¡æ•°æ®éš”ç¦»**ï¼šä¸åŒä¿±ä¹éƒ¨æ•°æ®å®Œå…¨éš”ç¦»
- âœ… **æ¸è¿›å¼æ¶æ„**ï¼šåŸºäºç°æœ‰å•ä½“æ¶æ„ï¼Œæ”¯æŒåæœŸå¾®æœåŠ¡æ¼”è¿›

### æŠ€æœ¯æ ˆ
- **åç«¯æ¡†æ¶**ï¼šSpring Boot 3.x + MyBatis Plus
- **é‰´æƒæ¡†æ¶**ï¼šSa-Token
- **æ•°æ®åº“**ï¼šMySQL 8.0
- **ç¼“å­˜**ï¼šRedis 6.x
- **åŸºç¡€æ¶æ„**ï¼šç°æœ‰ smart-admin-api-java17-springboot3

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### è¡¨å…³ç³»å›¾
```
m_app_config (åº”ç”¨é…ç½®è¡¨)
    â†‘ (app_id)
    |
m_platform_identity (å¹³å°èº«ä»½ç»‘å®šè¡¨)  
    â†‘ (member_id)
    |
m_member (ä¼šå‘˜ä¸»è¡¨)
```

### 1. æ‰©å±•ç°æœ‰ä¼šå‘˜è¡¨ï¼ˆm_memberï¼‰

```sql
-- æ‰©å±•ç°æœ‰ m_member è¡¨
ALTER TABLE m_member ADD COLUMN platform_type VARCHAR(20) DEFAULT 'wechat_mini' COMMENT 'æ³¨å†Œå¹³å°ç±»å‹';
ALTER TABLE m_member ADD COLUMN member_uuid VARCHAR(64) UNIQUE COMMENT 'å…¨å±€å”¯ä¸€æ ‡è¯†UUID';

-- æ·»åŠ ç´¢å¼•
CREATE INDEX idx_member_uuid ON m_member(member_uuid);
CREATE INDEX idx_platform_type ON m_member(platform_type);  
CREATE INDEX idx_phone ON m_member(phone);
CREATE INDEX idx_union_id ON m_member(unionId);
```

### 2. å¹³å°èº«ä»½ç»‘å®šè¡¨ï¼ˆm_platform_identityï¼‰

```sql
-- å¹³å°èº«ä»½æ˜ å°„è¡¨ï¼ˆæ ¸å¿ƒè¡¨ï¼‰
CREATE TABLE m_platform_identity (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    member_id BIGINT NOT NULL COMMENT 'å…³è”ä¼šå‘˜ID',
    platform_type ENUM('wechat_mini','alipay_mini','douyin_mini','qq_mini','app_ios','app_android','h5_web') NOT NULL COMMENT 'å¹³å°ç±»å‹',
    app_id VARCHAR(100) NOT NULL COMMENT 'åº”ç”¨ID',
    platform_user_id VARCHAR(100) NOT NULL COMMENT 'å¹³å°ç”¨æˆ·ID(openIdç­‰)',
    union_id VARCHAR(100) COMMENT 'å¹³å°unionId',
    session_key VARCHAR(200) COMMENT 'ä¼šè¯å¯†é’¥ï¼ˆå¾®ä¿¡ä¸“ç”¨ï¼‰',
    bind_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'ç»‘å®šæ—¶é—´',
    last_login_time DATETIME COMMENT 'æœ€åç™»å½•æ—¶é—´',
    status TINYINT(1) DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š1=æ­£å¸¸ï¼Œ0=ç¦ç”¨',
    
    UNIQUE KEY uk_platform_user (platform_type, app_id, platform_user_id),
    INDEX idx_member_platform (member_id, platform_type),
    INDEX idx_union_id (union_id),
    FOREIGN KEY fk_member (member_id) REFERENCES m_member(member_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT 'å¹³å°èº«ä»½ç»‘å®šè¡¨';
```

**å­—æ®µè¯´æ˜**ï¼š
- `session_key`ï¼šå¾®ä¿¡å°ç¨‹åºè§£å¯†æ‰‹æœºå·ç­‰æ•æ„Ÿä¿¡æ¯ä¸“ç”¨ï¼Œå…¶ä»–å¹³å°ä¸ºNULL
- `union_id`ï¼šå¾®ä¿¡ç”Ÿæ€ä¸‹å¤šåº”ç”¨ç»Ÿä¸€æ ‡è¯†ï¼Œæ”¯ä»˜å®ç­‰å…¶ä»–å¹³å°å¯èƒ½ä¸ºNULL
- `platform_user_id`ï¼šå„å¹³å°çš„ç”¨æˆ·å”¯ä¸€æ ‡è¯†ï¼ˆopenIdã€user_idç­‰ï¼‰

### 3. åº”ç”¨é…ç½®è¡¨ï¼ˆm_app_configï¼‰

```sql
-- åº”ç”¨é…ç½®è¡¨
CREATE TABLE m_app_config (
    app_id VARCHAR(100) PRIMARY KEY COMMENT 'åº”ç”¨IDï¼ˆå°ç¨‹åºappidã€APPåŒ…åç­‰ï¼‰',
    app_name VARCHAR(100) NOT NULL COMMENT 'åº”ç”¨åç§°',
    platform_type VARCHAR(20) NOT NULL COMMENT 'å¹³å°ç±»å‹',
    app_secret VARCHAR(200) COMMENT 'åº”ç”¨å¯†é’¥',
    club_id BIGINT COMMENT 'å…³è”ä¿±ä¹éƒ¨IDï¼ˆNULLè¡¨ç¤ºå…¨å›½é€šç”¨ï¼‰',
    business_domain VARCHAR(100) COMMENT 'ä¸šåŠ¡åŸŸï¼ˆç”¨äºä¸šåŠ¡åˆ†ç±»ï¼‰',
    config_json TEXT COMMENT 'å¹³å°ç‰¹å®šé…ç½®ï¼ˆJSONæ ¼å¼ï¼‰',
    status TINYINT(1) DEFAULT 1 COMMENT 'åº”ç”¨çŠ¶æ€ï¼š1=å¯ç”¨ï¼Œ0=ç¦ç”¨',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    
    INDEX idx_platform_type (platform_type),
    INDEX idx_club_id (club_id),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT 'åº”ç”¨é…ç½®è¡¨';
```

### 4. ä¼šå‘˜åˆå¹¶æ—¥å¿—è¡¨ï¼ˆm_member_merge_logï¼‰

```sql
-- ä¼šå‘˜åˆå¹¶æ—¥å¿—è¡¨
CREATE TABLE m_member_merge_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    target_member_id BIGINT NOT NULL COMMENT 'åˆå¹¶ç›®æ ‡ä¼šå‘˜IDï¼ˆä¿ç•™ï¼‰',
    source_member_id BIGINT NOT NULL COMMENT 'åˆå¹¶æ¥æºä¼šå‘˜IDï¼ˆè¢«åˆå¹¶ï¼‰',
    merge_reason VARCHAR(200) COMMENT 'åˆå¹¶åŸå› ',
    merge_data_json TEXT COMMENT 'åˆå¹¶æ•°æ®è¯¦æƒ…ï¼ˆJSONæ ¼å¼ï¼‰',
    merge_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆå¹¶æ—¶é—´',
    operator VARCHAR(50) COMMENT 'æ“ä½œäºº',
    
    INDEX idx_target_member (target_member_id),
    INDEX idx_source_member (source_member_id),
    INDEX idx_merge_time (merge_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT 'ä¼šå‘˜åˆå¹¶æ—¥å¿—';
```

---

## ğŸ“Š æ•°æ®ç¤ºä¾‹

### ç¤ºä¾‹åœºæ™¯è®¾å®š
- **åŒ—äº¬é©¬æœ¯ä¿±ä¹éƒ¨**ï¼ˆclub_id: 1001ï¼‰ï¼šæœ‰å¾®ä¿¡å°ç¨‹åºæ™®é€šç‰ˆã€VIPç‰ˆã€æ”¯ä»˜å®å°ç¨‹åº
- **ä¸Šæµ·é©¬æœ¯ä¿±ä¹éƒ¨**ï¼ˆclub_id: 1002ï¼‰ï¼šæœ‰å¾®ä¿¡å°ç¨‹åºã€æŠ–éŸ³å°ç¨‹åº  
- **å…¨å›½é€šç”¨APP**ï¼ˆclub_id: NULLï¼‰ï¼šiOSå’ŒAndroidç‰ˆæœ¬

### 1. åº”ç”¨é…ç½®æ•°æ®ï¼ˆm_app_configï¼‰

```sql
INSERT INTO m_app_config VALUES 
-- åŒ—äº¬é©¬æœ¯ä¿±ä¹éƒ¨åº”ç”¨
('wx_beijing_001', 'åŒ—äº¬é©¬æœ¯ä¿±ä¹éƒ¨å¾®ä¿¡å°ç¨‹åº', 'wechat_mini', 'wx_secret_001', 1001, 'beijing_club', 
 '{"theme":"blue","max_booking_days":30,"template_ids":["temp001","temp002"]}', 1, '2025-01-01 00:00:00'),

('wx_beijing_vip', 'åŒ—äº¬é©¬æœ¯ä¿±ä¹éƒ¨VIPç‰ˆ', 'wechat_mini', 'wx_secret_vip', 1001, 'beijing_vip', 
 '{"theme":"gold","max_booking_days":60,"vip_features":["priority_booking","free_cancel"]}', 1, '2025-01-01 00:00:00'),

('ali_beijing_001', 'åŒ—äº¬é©¬æœ¯ä¿±ä¹éƒ¨æ”¯ä»˜å®ç‰ˆ', 'alipay_mini', 'ali_secret_001', 1001, 'beijing_club', 
 '{"theme":"blue","payment_methods":["alipay"]}', 1, '2025-01-01 00:00:00'),

-- ä¸Šæµ·é©¬æœ¯ä¿±ä¹éƒ¨åº”ç”¨
('wx_shanghai_001', 'ä¸Šæµ·é©¬æœ¯ä¿±ä¹éƒ¨å°ç¨‹åº', 'wechat_mini', 'wx_secret_sh', 1002, 'shanghai_club', 
 '{"theme":"red","max_booking_days":45,"local_features":["weather_info"]}', 1, '2025-01-01 00:00:00'),

('dy_shanghai_001', 'ä¸Šæµ·é©¬æœ¯æŠ–éŸ³å°ç¨‹åº', 'douyin_mini', 'dy_secret_sh', 1002, 'shanghai_club', 
 '{"theme":"red","video_features":["course_video","coach_intro"]}', 1, '2025-01-01 00:00:00'),

-- å…¨å›½é€šç”¨APP
('ios_app_national', 'é©¬æœ¯é€šiOS APP', 'app_ios', 'ios_secret_001', NULL, 'national', 
 '{"version":"1.0.0","features":["multi_club","gps_location"]}', 1, '2025-01-01 00:00:00'),

('android_app_national', 'é©¬æœ¯é€šAndroid APP', 'app_android', 'android_secret_001', NULL, 'national', 
 '{"version":"1.0.0","features":["multi_club","gps_location"]}', 1, '2025-01-01 00:00:00');
```

### 2. ä¼šå‘˜æ•°æ®ï¼ˆm_memberï¼‰

```sql
INSERT INTO m_member (member_id, member_no, union_id, open_id, actual_name, phone, email, avatar_url, 
                      gender, birth_date, club_id, is_membership, membership_status, membership_expire_date, 
                      id_card_no, rider_cert_no, registration_status, created_by_guardian, disabled_flag, 
                      profile_data, default_coach_id, default_course_level, last_login_time, 
                      create_by, create_time, update_by, update_time, is_valid, is_delete, 
                      platform_type, member_uuid) VALUES 

-- å¼ ä¸‰ï¼šå¤šå¹³å°ç”¨æˆ·ï¼ŒåŒ—äº¬ä¿±ä¹éƒ¨æ™®é€šä¼šå‘˜
(10001, 'BJ001', 'union_wx_zhang123', NULL, 'å¼ ä¸‰', '13800138001', 'zhang@example.com', 
 'https://avatar.com/zhang.jpg', 1, '1990-05-15', 1001, 0, 0, NULL, '110101199005151234', NULL, 1, 0, 0, 
 '{"hobby":"jumping","level":"beginner"}', 2001, 'beginner', '2025-01-20 10:30:00', 
 'system', '2025-01-01 00:00:00', 'system', '2025-01-20 10:30:00', 1, 0, 
 'wechat_mini', 'uuid-zhang-0001'),

-- æå››ï¼šä¸Šæµ·ä¿±ä¹éƒ¨VIPä¼šå‘˜ï¼Œæœ‰éª‘æ‰‹è¯
(10002, 'SH001', 'union_wx_li456', NULL, 'æå››', '13800138002', 'li@example.com', 
 'https://avatar.com/li.jpg', 2, '1985-08-20', 1002, 1, 1, '2025-12-31', '310101198508201234', 'R001', 1, 0, 0, 
 '{"hobby":"dressage","level":"intermediate"}', 2002, 'intermediate', '2025-01-20 09:15:00', 
 'system', '2025-01-01 00:00:00', 'system', '2025-01-20 09:15:00', 1, 0, 
 'wechat_mini', 'uuid-li-0002'),

-- ç‹äº”ï¼šåŒ—äº¬ä¿±ä¹éƒ¨ä¼šå‘˜ï¼Œåªç”¨æ”¯ä»˜å®
(10003, 'BJ002', NULL, NULL, 'ç‹äº”', '13800138003', 'wang@example.com', 
 'https://avatar.com/wang.jpg', 1, '1992-03-10', 1001, 0, 0, NULL, NULL, NULL, 1, 0, 0, 
 '{"hobby":"trail","level":"beginner"}', NULL, 'beginner', '2025-01-19 16:20:00', 
 'system', '2025-01-01 00:00:00', 'system', '2025-01-19 16:20:00', 1, 0, 
 'alipay_mini', 'uuid-wang-0003');
```

### 3. å¹³å°èº«ä»½ç»‘å®šæ•°æ®ï¼ˆm_platform_identityï¼‰

```sql
INSERT INTO m_platform_identity VALUES 
-- å¼ ä¸‰çš„å¤šå¹³å°ç»‘å®šï¼ˆmember_id: 10001ï¼‰
(1, 10001, 'wechat_mini', 'wx_beijing_001', 'openid_wx_zhang_001', 'union_wx_zhang123', 'session_key_zhang_001', '2025-01-01 10:00:00', '2025-01-20 10:30:00', 1),
(2, 10001, 'wechat_mini', 'wx_beijing_vip', 'openid_wx_zhang_vip', 'union_wx_zhang123', 'session_key_zhang_vip', '2025-01-05 14:30:00', '2025-01-19 08:45:00', 1),
(3, 10001, 'alipay_mini', 'ali_beijing_001', 'openid_ali_zhang_001', NULL, NULL, '2025-01-10 16:20:00', '2025-01-18 19:30:00', 1),
(4, 10001, 'app_ios', 'ios_app_national', 'device_uuid_zhang_ios', NULL, NULL, '2025-01-15 09:15:00', '2025-01-20 07:20:00', 1),

-- æå››çš„å¤šå¹³å°ç»‘å®šï¼ˆmember_id: 10002ï¼‰
(5, 10002, 'wechat_mini', 'wx_shanghai_001', 'openid_wx_li_001', 'union_wx_li456', 'session_key_li_001', '2025-01-01 11:00:00', '2025-01-20 09:15:00', 1),
(6, 10002, 'douyin_mini', 'dy_shanghai_001', 'openid_dy_li_001', NULL, NULL, '2025-01-08 15:30:00', '2025-01-19 20:45:00', 1),
(7, 10002, 'app_android', 'android_app_national', 'device_uuid_li_android', NULL, NULL, '2025-01-12 13:20:00', '2025-01-18 22:10:00', 1),

-- ç‹äº”çš„å•å¹³å°ç»‘å®šï¼ˆmember_id: 10003ï¼‰
(8, 10003, 'alipay_mini', 'ali_beijing_001', 'openid_ali_wang_001', NULL, NULL, '2025-01-01 12:00:00', '2025-01-19 16:20:00', 1);
```

### æ•°æ®å…³ç³»åˆ†æ

#### å¼ ä¸‰ï¼ˆmember_id: 10001ï¼‰çš„å®Œæ•´ç”»åƒ
**åŸºç¡€ä¿¡æ¯**ï¼šåŒ—äº¬é©¬æœ¯ä¿±ä¹éƒ¨ä¼šå‘˜ï¼Œæ‰‹æœºå·13800138001

**å¹³å°ç»‘å®šæƒ…å†µ**ï¼š
1. **åŒ—äº¬ä¿±ä¹éƒ¨å¾®ä¿¡å°ç¨‹åº**ï¼ˆwx_beijing_001ï¼‰- æ™®é€šç‰ˆ
2. **åŒ—äº¬ä¿±ä¹éƒ¨ä¼šå‘˜ç‰ˆå°ç¨‹åº**ï¼ˆwx_beijing_vipï¼‰- VIPç‰ˆ  
3. **åŒ—äº¬ä¿±ä¹éƒ¨æ”¯ä»˜å®å°ç¨‹åº**ï¼ˆali_beijing_001ï¼‰
4. **é©¬æœ¯é€šiOS APP**ï¼ˆios_app_nationalï¼‰

**ä¸šåŠ¡å«ä¹‰**ï¼š
- å¼ ä¸‰å¯ä»¥é€šè¿‡4ä¸ªä¸åŒå¹³å°ç™»å½•
- åœ¨å¾®ä¿¡ç”Ÿæ€å†…é€šè¿‡unionIdï¼ˆunion_wx_zhang123ï¼‰è¯†åˆ«ä¸ºåŒä¸€ç”¨æˆ·
- åœ¨æ‰€æœ‰å¹³å°çœ‹åˆ°çš„ä¸ªäººä¿¡æ¯å®Œå…¨ä¸€è‡´
- åœ¨åŒ—äº¬ä¿±ä¹éƒ¨çš„æ‰€æœ‰åº”ç”¨å†…äº«å—ä¼šå‘˜æƒç›Š

---

## ğŸ—ï¸ ä»£ç æ¶æ„è®¾è®¡

### é¡¹ç›®åŒ…ç»“æ„
```
net.lab1024.sa.admin.module
â”œâ”€â”€ business.member          # ç°æœ‰ä¼šå‘˜æ¨¡å—ï¼ˆæ‰©å±•ï¼‰
â””â”€â”€ platform                # æ–°å¢å¹³å°é€‚é…æ¨¡å—
    â”œâ”€â”€ adapter             # å¹³å°é€‚é…å™¨
    â”‚   â”œâ”€â”€ PlatformAdapter.java
    â”‚   â”œâ”€â”€ WechatMiniAdapter.java
    â”‚   â”œâ”€â”€ AlipayMiniAdapter.java
    â”‚   â””â”€â”€ DouyinMiniAdapter.java
    â”œâ”€â”€ controller          # ç»Ÿä¸€è®¤è¯æ§åˆ¶å™¨
    â”‚   â”œâ”€â”€ UnifiedAuthController.java
    â”‚   â””â”€â”€ UnifiedMemberController.java
    â”œâ”€â”€ service             # æ ¸å¿ƒä¸šåŠ¡æœåŠ¡
    â”‚   â”œâ”€â”€ UnifiedAuthService.java
    â”‚   â”œâ”€â”€ PlatformIdentityService.java
    â”‚   â”œâ”€â”€ AppConfigService.java
    â”‚   â””â”€â”€ AccountMergeService.java
    â”œâ”€â”€ domain              # æ•°æ®æ¨¡å‹
    â”‚   â”œâ”€â”€ entity
    â”‚   â”œâ”€â”€ vo
    â”‚   â””â”€â”€ dto
    â””â”€â”€ dao                 # æ•°æ®è®¿é—®å±‚
        â”œâ”€â”€ PlatformIdentityDao.java
        â””â”€â”€ AppConfigDao.java
```

### 1. å¹³å°é€‚é…å™¨æ¥å£è®¾è®¡

```java
/**
 * å¹³å°é€‚é…å™¨æ¥å£
 * ç»Ÿä¸€ä¸åŒå¹³å°çš„ç™»å½•å’Œç”¨æˆ·ä¿¡æ¯è·å–é€»è¾‘
 */
public interface PlatformAdapter {
    
    /**
     * å¹³å°ç™»å½•
     * @param code å¹³å°ç™»å½•å‡­è¯
     * @param appConfig åº”ç”¨é…ç½®
     * @return å¹³å°ç™»å½•ç»“æœ
     */
    PlatformLoginResult login(String code, AppConfig appConfig);
    
    /**
     * è·å–ç”¨æˆ·æ‰‹æœºå·ï¼ˆå¾®ä¿¡å°ç¨‹åºä¸“ç”¨ï¼‰
     * @param code æ‰‹æœºå·æˆæƒç 
     * @param sessionKey ä¼šè¯å¯†é’¥
     * @return æ‰‹æœºå·
     */
    String getPhoneNumber(String code, String sessionKey);
    
    /**
     * è·å–ç”¨æˆ·ä¿¡æ¯
     * @param platformUserId å¹³å°ç”¨æˆ·ID
     * @param appConfig åº”ç”¨é…ç½®
     * @return ç”¨æˆ·ä¿¡æ¯
     */
    PlatformUserInfo getUserInfo(String platformUserId, AppConfig appConfig);
    
    /**
     * åˆ·æ–°è®¿é—®å‡­è¯
     * @param refreshToken åˆ·æ–°ä»¤ç‰Œ
     * @param appConfig åº”ç”¨é…ç½®
     * @return æ–°çš„è®¿é—®å‡­è¯
     */
    PlatformTokenResult refreshToken(String refreshToken, AppConfig appConfig);
}
```

### 2. å¾®ä¿¡å°ç¨‹åºé€‚é…å™¨å®ç°

```java
/**
 * å¾®ä¿¡å°ç¨‹åºé€‚é…å™¨
 */
@Component("wechatMiniAdapter")
@Slf4j
public class WechatMiniAdapter implements PlatformAdapter {
    
    private static final String WECHAT_API_URL = "https://api.weixin.qq.com/sns/jscode2session";
    private static final String PHONE_API_URL = "https://api.weixin.qq.com/wxa/business/getuserphonenumber";
    
    @Autowired
    private RestTemplate restTemplate;
    
    @Override
    public PlatformLoginResult login(String code, AppConfig appConfig) {
        try {
            // 1. è°ƒç”¨å¾®ä¿¡æ¥å£è·å–openIdå’ŒsessionKey
            String url = String.format("%s?appid=%s&secret=%s&js_code=%s&grant_type=authorization_code",
                WECHAT_API_URL, appConfig.getAppId(), appConfig.getAppSecret(), code);
                
            WechatLoginResponse response = restTemplate.getForObject(url, WechatLoginResponse.class);
            
            if (response.getErrcode() != null && response.getErrcode() != 0) {
                throw new BusinessException("å¾®ä¿¡ç™»å½•å¤±è´¥ï¼š" + response.getErrmsg());
            }
            
            // 2. æ„å»ºè¿”å›ç»“æœ
            return PlatformLoginResult.builder()
                .platformUserId(response.getOpenid())
                .unionId(response.getUnionid())
                .sessionKey(response.getSessionKey())
                .platform("wechat_mini")
                .success(true)
                .build();
                
        } catch (Exception e) {
            log.error("å¾®ä¿¡å°ç¨‹åºç™»å½•å¤±è´¥, code: {}, appId: {}", code, appConfig.getAppId(), e);
            throw new BusinessException("å¾®ä¿¡ç™»å½•å¤±è´¥");
        }
    }
    
    @Override
    public String getPhoneNumber(String code, String sessionKey) {
        try {
            // å¾®ä¿¡è·å–æ‰‹æœºå·æ¥å£è°ƒç”¨
            WechatPhoneRequest request = new WechatPhoneRequest();
            request.setCode(code);
            
            WechatPhoneResponse response = restTemplate.postForObject(
                PHONE_API_URL + "?access_token=" + getAccessToken(), 
                request, 
                WechatPhoneResponse.class);
                
            if (response.getErrcode() == 0) {
                return response.getPhoneInfo().getPhoneNumber();
            } else {
                throw new BusinessException("è·å–æ‰‹æœºå·å¤±è´¥ï¼š" + response.getErrmsg());
            }
            
        } catch (Exception e) {
            log.error("è·å–å¾®ä¿¡æ‰‹æœºå·å¤±è´¥, code: {}", code, e);
            throw new BusinessException("è·å–æ‰‹æœºå·å¤±è´¥");
        }
    }
    
    private String getAccessToken() {
        // è·å–å¾®ä¿¡AccessTokençš„é€»è¾‘
        // å¯ä»¥ç¼“å­˜åœ¨Redisä¸­ï¼Œå®šæœŸåˆ·æ–°
        return "ACCESS_TOKEN";
    }
}
```

### 3. ç»Ÿä¸€è®¤è¯æœåŠ¡æ ¸å¿ƒå®ç°

```java
/**
 * ç»Ÿä¸€è®¤è¯æœåŠ¡
 * å¤„ç†å¤šå¹³å°ç™»å½•å’Œè´¦å·åˆå¹¶é€»è¾‘
 */
@Service
@Slf4j
public class UnifiedAuthService {
    
    @Autowired
    private PlatformAdapterFactory platformAdapterFactory;
    
    @Autowired
    private PlatformIdentityService platformIdentityService;
    
    @Autowired
    private MemberService memberService;
    
    @Autowired
    private AppConfigService appConfigService;
    
    @Autowired
    private AccountMergeService accountMergeService;
    
    /**
     * ç»Ÿä¸€ç™»å½•å…¥å£
     */
    @Transactional
    public UnifiedLoginResult login(UnifiedLoginRequest request) {
        log.info("ç»Ÿä¸€ç™»å½•å¼€å§‹, platformType: {}, appId: {}", request.getPlatformType(), request.getAppId());
        
        // 1. è·å–åº”ç”¨é…ç½®
        AppConfig appConfig = appConfigService.getAppConfig(request.getAppId());
        validateAppConfig(appConfig, request.getPlatformType());
        
        // 2. å¹³å°ç™»å½•è·å–ç”¨æˆ·ä¿¡æ¯
        PlatformAdapter adapter = platformAdapterFactory.getAdapter(request.getPlatformType());
        PlatformLoginResult platformResult = adapter.login(request.getCode(), appConfig);
        
        // 3. å¤„ç†æ‰‹æœºå·ï¼ˆå¦‚æœæä¾›ï¼‰
        String phoneNumber = null;
        if (StringUtils.isNotEmpty(request.getPhoneCode()) && 
            "wechat_mini".equals(request.getPlatformType())) {
            phoneNumber = adapter.getPhoneNumber(request.getPhoneCode(), platformResult.getSessionKey());
            platformResult.setPhone(phoneNumber);
        }
        
        // 4. æŸ¥æ‰¾æˆ–åˆ›å»ºä¼šå‘˜
        MemberEntity member = findOrCreateMember(platformResult, appConfig, request);
        
        // 5. åˆ›å»ºæˆ–æ›´æ–°å¹³å°èº«ä»½ç»‘å®š
        PlatformIdentity identity = createOrUpdatePlatformIdentity(member.getMemberId(), 
            request.getPlatformType(), request.getAppId(), platformResult);
        
        // 6. ç”ŸæˆSa-Token
        StpUtil.login(member.getMemberId());
        String token = StpUtil.getTokenValue();
        
        // 7. è®¾ç½®Tokenä¸Šä¸‹æ–‡ä¿¡æ¯
        setTokenContext(member.getMemberId(), request.getPlatformType(), request.getAppId());
        
        // 8. ç¼“å­˜ç”¨æˆ·ä¿¡æ¯
        cacheMemberInfo(member);
        
        log.info("ç»Ÿä¸€ç™»å½•æˆåŠŸ, memberId: {}, platform: {}", member.getMemberId(), request.getPlatformType());
        
        return buildLoginResult(member, token, appConfig, identity);
    }
    
    /**
     * æŸ¥æ‰¾æˆ–åˆ›å»ºä¼šå‘˜
     */
    private MemberEntity findOrCreateMember(PlatformLoginResult platformResult, 
                                          AppConfig appConfig, 
                                          UnifiedLoginRequest request) {
        
        // 1. é€šè¿‡å¹³å°èº«ä»½æŸ¥æ‰¾ç°æœ‰ç»‘å®š
        PlatformIdentity existingIdentity = platformIdentityService.findByPlatformUser(
            request.getPlatformType(), request.getAppId(), platformResult.getPlatformUserId());
            
        if (existingIdentity != null) {
            MemberEntity member = memberService.getMemberById(existingIdentity.getMemberId());
            // å®æ—¶åŒæ­¥æœ€æ–°å¹³å°ä¿¡æ¯
            syncLatestPlatformDataToMember(member, platformResult, request);
            return member;
        }
        
        // 2. é€šè¿‡unionIdæŸ¥æ‰¾ç°æœ‰ä¼šå‘˜
        MemberEntity member = null;
        if (StringUtils.isNotEmpty(platformResult.getUnionId())) {
            member = memberService.getMemberByUnionId(platformResult.getUnionId());
        }
        
        // 3. é€šè¿‡æ‰‹æœºå·æŸ¥æ‰¾ç°æœ‰ä¼šå‘˜
        if (member == null && StringUtils.isNotEmpty(platformResult.getPhone())) {
            MemberEntity phoneOwner = memberService.getMemberByPhone(platformResult.getPhone());
            if (phoneOwner != null) {
                // è§¦å‘è´¦å·åˆå¹¶é€»è¾‘
                member = handlePhoneNumberConflict(phoneOwner, platformResult, appConfig);
            }
        }
        
        // 4. åˆ›å»ºæ–°ä¼šå‘˜
        if (member == null) {
            member = createNewMember(platformResult, appConfig, request);
        }
        
        return member;
    }
    
    /**
     * å®æ—¶åŒæ­¥å¹³å°æ•°æ®åˆ°ä¼šå‘˜è¡¨
     */
    private void syncLatestPlatformDataToMember(MemberEntity member, 
                                              PlatformLoginResult platformResult, 
                                              UnifiedLoginRequest request) {
        boolean needUpdate = false;
        
        // å¤´åƒåŒæ­¥ç­–ç•¥ï¼šä½¿ç”¨æœ€æ–°çš„éç©ºå¤´åƒ
        if (StringUtils.isNotEmpty(request.getAvatarUrl()) && 
            !request.getAvatarUrl().equals(member.getAvatarUrl())) {
            member.setAvatarUrl(request.getAvatarUrl());
            needUpdate = true;
        }
        
        // æ˜µç§°åŒæ­¥ç­–ç•¥ï¼šè¡¥å……ç©ºå€¼
        if (StringUtils.isNotEmpty(request.getNickName()) && 
            StringUtils.isEmpty(member.getActualName())) {
            member.setActualName(request.getNickName());
            needUpdate = true;
        }
        
        // unionIdåŒæ­¥
        if (StringUtils.isNotEmpty(platformResult.getUnionId()) && 
            StringUtils.isEmpty(member.getUnionId())) {
            member.setUnionId(platformResult.getUnionId());
            needUpdate = true;
        }
        
        // æ‰‹æœºå·åŒæ­¥
        if (StringUtils.isNotEmpty(platformResult.getPhone()) && 
            !platformResult.getPhone().equals(member.getPhone())) {
            member.setPhone(platformResult.getPhone());
            needUpdate = true;
        }
        
        if (needUpdate) {
            member.setLastLoginTime(LocalDateTime.now());
            member.setUpdateTime(LocalDateTime.now());
            memberService.updateMember(member);
            
            // æ¸…é™¤ç¼“å­˜
            clearMemberCache(member.getMemberId());
        }
    }
}
```

### 4. ç»Ÿä¸€è®¤è¯æ§åˆ¶å™¨

```java
/**
 * ç»Ÿä¸€è®¤è¯æ§åˆ¶å™¨
 */
@RestController
@RequestMapping("/api/unified/auth")
@Tag(name = "ç»Ÿä¸€è®¤è¯æ¥å£")
@Slf4j
public class UnifiedAuthController {
    
    @Autowired
    private UnifiedAuthService unifiedAuthService;
    
    /**
     * ç»Ÿä¸€ç™»å½•æ¥å£
     */
    @PostMapping("/login")
    @Operation(summary = "ç»Ÿä¸€å¹³å°ç™»å½•")
    @NoNeedLogin
    public ResponseDTO<UnifiedLoginResult> login(@Valid @RequestBody UnifiedLoginRequest request) {
        log.info("æ”¶åˆ°ç»Ÿä¸€ç™»å½•è¯·æ±‚: platformType={}, appId={}", request.getPlatformType(), request.getAppId());
        
        UnifiedLoginResult result = unifiedAuthService.login(request);
        
        return ResponseDTO.ok(result);
    }
    
    /**
     * ç»‘å®šæ‰‹æœºå·
     */
    @PostMapping("/bind-phone")
    @Operation(summary = "ç»‘å®šæ‰‹æœºå·")
    public ResponseDTO<Void> bindPhone(@Valid @RequestBody BindPhoneRequest request) {
        Long memberId = getCurrentMemberId();
        unifiedAuthService.bindPhone(memberId, request);
        return ResponseDTO.ok();
    }
    
    /**
     * æ‰‹æœºå·æ¢ç»‘
     */
    @PostMapping("/change-phone")
    @Operation(summary = "æ‰‹æœºå·æ¢ç»‘") 
    public ResponseDTO<Void> changePhone(@Valid @RequestBody ChangePhoneRequest request) {
        Long memberId = getCurrentMemberId();
        unifiedAuthService.changePhone(memberId, request);
        return ResponseDTO.ok();
    }
    
    /**
     * è´¦å·åˆå¹¶
     */
    @PostMapping("/merge-account")
    @Operation(summary = "æ‰‹åŠ¨åˆå¹¶è´¦å·")
    public ResponseDTO<Void> mergeAccount(@Valid @RequestBody MergeAccountRequest request) {
        Long memberId = getCurrentMemberId();
        unifiedAuthService.mergeAccount(memberId, request);
        return ResponseDTO.ok();
    }
    
    /**
     * è·å–å½“å‰ç™»å½•ä¼šå‘˜ID
     */
    private Long getCurrentMemberId() {
        return StpUtil.getLoginIdAsLong();
    }
}
```

---

## ğŸ“¡ APIæ¥å£æ–‡æ¡£

### 1. ç»Ÿä¸€ç™»å½•æ¥å£

#### è¯·æ±‚ç¤ºä¾‹
```http
POST /api/unified/auth/login
Content-Type: application/json

{
  "platformType": "wechat_mini",
  "appId": "wx_beijing_001",
  "code": "061gHl0w3oJW2s2uKf2w3Bt**",
  "phoneCode": "phone_auth_code_optional",
  "avatarUrl": "https://avatar.example.com/user.jpg",
  "nickName": "å¼ ä¸‰"
}
```

#### å“åº”ç¤ºä¾‹
```json
{
  "code": 1,
  "msg": "success", 
  "data": {
    "token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
    "member": {
      "memberId": 10001,
      "memberNo": "BJ001",
      "memberUuid": "uuid-zhang-0001",
      "actualName": "å¼ ä¸‰",
      "phone": "138****8001",
      "avatarUrl": "https://avatar.example.com/user.jpg",
      "gender": 1,
      "clubId": 1001,
      "clubName": "åŒ—äº¬é©¬æœ¯ä¿±ä¹éƒ¨",
      "isMembership": 0,
      "registrationStatus": 1
    },
    "platformInfo": {
      "platformType": "wechat_mini",
      "appId": "wx_beijing_001",
      "appName": "åŒ—äº¬é©¬æœ¯ä¿±ä¹éƒ¨å¾®ä¿¡å°ç¨‹åº",
      "isNewBind": false,
      "bindTime": "2025-01-01T10:00:00"
    },
    "permissions": ["member:read", "booking:create", "course:view"]
  }
}
```

### 2. è·å–ç”¨æˆ·èµ„æ–™æ¥å£

#### è¯·æ±‚ç¤ºä¾‹
```http
GET /api/unified/member/profile
Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...
```

#### å“åº”ç¤ºä¾‹
```json
{
  "code": 1,
  "msg": "success",
  "data": {
    "member": {
      "memberId": 10001,
      "memberNo": "BJ001", 
      "actualName": "å¼ ä¸‰",
      "phone": "138****8001",
      "email": "zhang@example.com",
      "avatarUrl": "https://avatar.example.com/user.jpg",
      "gender": 1,
      "birthDate": "1990-05-15",
      "clubId": 1001,
      "clubName": "åŒ—äº¬é©¬æœ¯ä¿±ä¹éƒ¨"
    },
    "platformBindings": [
      {
        "platformType": "wechat_mini",
        "appId": "wx_beijing_001",
        "appName": "åŒ—äº¬é©¬æœ¯ä¿±ä¹éƒ¨å¾®ä¿¡å°ç¨‹åº",
        "bindTime": "2025-01-01T10:00:00",
        "lastLoginTime": "2025-01-20T10:30:00"
      },
      {
        "platformType": "alipay_mini", 
        "appId": "ali_beijing_001",
        "appName": "åŒ—äº¬é©¬æœ¯ä¿±ä¹éƒ¨æ”¯ä»˜å®ç‰ˆ",
        "bindTime": "2025-01-10T16:20:00",
        "lastLoginTime": "2025-01-18T19:30:00"
      }
    ],
    "currentPlatform": {
      "platformType": "wechat_mini",
      "appId": "wx_beijing_001"
    }
  }
}
```

### 3. æ‰‹æœºå·æ¢ç»‘æ¥å£

#### è¯·æ±‚ç¤ºä¾‹
```http
POST /api/unified/auth/change-phone
Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...
Content-Type: application/json

{
  "oldPhoneVerifyCode": "123456",
  "newPhone": "13900139000", 
  "newPhoneVerifyCode": "654321",
  "platformCode": "phone_auth_code_from_platform"
}
```

#### å“åº”ç¤ºä¾‹
```json
{
  "code": 1,
  "msg": "æ‰‹æœºå·æ¢ç»‘æˆåŠŸ",
  "data": null
}
```

---

## ğŸ’¾ ç¼“å­˜ç­–ç•¥

### Redisç¼“å­˜è®¾è®¡

```java
/**
 * ä¼šå‘˜ç¼“å­˜æœåŠ¡
 */
@Service
@Slf4j
public class MemberCacheService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // ç¼“å­˜Keyå¸¸é‡
    public static class CacheKey {
        public static final String MEMBER_INFO = "member:unified:%d";
        public static final String PLATFORM_IDENTITY = "member:platform:%s:%s:%s"; // platformType:appId:platformUserId
        public static final String MEMBER_PLATFORMS = "member:platforms:%d";
        public static final String APP_CONFIG = "app:config:%s";
        public static final String MEMBER_PERMISSION = "member:permission:%d:%s"; // memberId:platformType
    }
    
    /**
     * ç¼“å­˜ä¼šå‘˜ä¿¡æ¯
     */
    public void cacheMemberInfo(MemberEntity member) {
        String key = String.format(CacheKey.MEMBER_INFO, member.getMemberId());
        redisTemplate.opsForValue().set(key, member, Duration.ofMinutes(30));
        log.debug("ç¼“å­˜ä¼šå‘˜ä¿¡æ¯: key={}, memberId={}", key, member.getMemberId());
    }
    
    /**
     * è·å–ç¼“å­˜çš„ä¼šå‘˜ä¿¡æ¯
     */
    public MemberEntity getCachedMemberInfo(Long memberId) {
        String key = String.format(CacheKey.MEMBER_INFO, memberId);
        return (MemberEntity) redisTemplate.opsForValue().get(key);
    }
    
    /**
     * ç¼“å­˜å¹³å°èº«ä»½æ˜ å°„
     */
    public void cachePlatformIdentity(String platformType, String appId, String platformUserId, Long memberId) {
        String key = String.format(CacheKey.PLATFORM_IDENTITY, platformType, appId, platformUserId);
        redisTemplate.opsForValue().set(key, memberId, Duration.ofHours(1));
    }
    
    /**
     * ç¼“å­˜åº”ç”¨é…ç½®
     */
    public void cacheAppConfig(AppConfig appConfig) {
        String key = String.format(CacheKey.APP_CONFIG, appConfig.getAppId());
        redisTemplate.opsForValue().set(key, appConfig, Duration.ofHours(4));
    }
    
    /**
     * æ¸…é™¤ä¼šå‘˜æ‰€æœ‰ç›¸å…³ç¼“å­˜
     */
    public void clearMemberAllCache(Long memberId) {
        // 1. æ¸…é™¤ä¼šå‘˜åŸºç¡€ä¿¡æ¯ç¼“å­˜
        String memberKey = String.format(CacheKey.MEMBER_INFO, memberId);
        redisTemplate.delete(memberKey);
        
        // 2. æ¸…é™¤ä¼šå‘˜å¹³å°åˆ—è¡¨ç¼“å­˜
        String platformsKey = String.format(CacheKey.MEMBER_PLATFORMS, memberId);
        redisTemplate.delete(platformsKey);
        
        // 3. æ¸…é™¤æƒé™ç¼“å­˜
        Set<String> permissionKeys = redisTemplate.keys(
            String.format(CacheKey.MEMBER_PERMISSION, memberId, "*"));
        if (!CollectionUtils.isEmpty(permissionKeys)) {
            redisTemplate.delete(permissionKeys);
        }
        
        // 4. æ¸…é™¤Sa-Tokenä¼šè¯ç¼“å­˜
        StpUtil.logout(memberId);
        
        log.info("æ¸…é™¤ä¼šå‘˜å…¨éƒ¨ç¼“å­˜: memberId={}", memberId);
    }
}
```

### ç¼“å­˜æ›´æ–°ç­–ç•¥

| ç¼“å­˜ç±»å‹ | ç¼“å­˜æ—¶é•¿ | æ›´æ–°ç­–ç•¥ | æ¸…é™¤æ—¶æœº |
|---------|---------|---------|---------|
| ä¼šå‘˜åŸºç¡€ä¿¡æ¯ | 30åˆ†é’Ÿ | å†™å…¥æ—¶æ›´æ–° | ä¸ªäººä¿¡æ¯ä¿®æ”¹æ—¶ |
| å¹³å°èº«ä»½æ˜ å°„ | 1å°æ—¶ | å†™å…¥æ—¶æ›´æ–° | æ–°å¢ç»‘å®šæ—¶ |
| åº”ç”¨é…ç½® | 4å°æ—¶ | ä¸»åŠ¨æ›´æ–° | é…ç½®ä¿®æ”¹æ—¶ |
| æƒé™ä¿¡æ¯ | 2å°æ—¶ | ç™»å½•æ—¶æ›´æ–° | æƒé™å˜æ›´æ—¶ |

---

## ğŸš€ å¼€å‘å®æ–½è®¡åˆ’

### é˜¶æ®µä¸€ï¼šæ•°æ®åº“å’ŒåŸºç¡€æ¶æ„ï¼ˆ1-2å‘¨ï¼‰

#### ä»»åŠ¡æ¸…å•
- [ ] **æ•°æ®åº“è¡¨åˆ›å»º**
  - åˆ›å»º `m_platform_identity` è¡¨
  - åˆ›å»º `m_app_config` è¡¨  
  - åˆ›å»º `m_member_merge_log` è¡¨
  - æ‰©å±•ç°æœ‰ `m_member` è¡¨å­—æ®µ
  
- [ ] **åŸºç¡€é…ç½®åˆå§‹åŒ–**
  - å¯¼å…¥åº”ç”¨é…ç½®æ•°æ®
  - ä¸ºç°æœ‰ä¼šå‘˜ç”ŸæˆUUID
  - æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥è„šæœ¬

#### å»ºè¡¨SQLè„šæœ¬
```sql
-- æ‰§è¡Œé¡ºåºï¼š
-- 1. æ‰©å±•m_memberè¡¨
-- 2. åˆ›å»ºm_platform_identityè¡¨
-- 3. åˆ›å»ºm_app_configè¡¨
-- 4. åˆ›å»ºm_member_merge_logè¡¨
-- 5. åˆå§‹åŒ–åº”ç”¨é…ç½®æ•°æ®
-- 6. æ•°æ®è¿ç§»å’Œç´¢å¼•ä¼˜åŒ–
```

### é˜¶æ®µäºŒï¼šå¹³å°é€‚é…å™¨å¼€å‘ï¼ˆ2-3å‘¨ï¼‰

#### å¾®ä¿¡å°ç¨‹åºé€‚é…å™¨
- [ ] å®ç°å¾®ä¿¡ç™»å½•æ¥å£è°ƒç”¨
- [ ] å®ç°å¾®ä¿¡æ‰‹æœºå·è·å–
- [ ] å®ç°AccessTokenç®¡ç†å’Œç¼“å­˜
- [ ] å¼‚å¸¸å¤„ç†å’Œé‡è¯•æœºåˆ¶

#### æ”¯ä»˜å®å°ç¨‹åºé€‚é…å™¨  
- [ ] å®ç°æ”¯ä»˜å®ç™»å½•æ¥å£
- [ ] å®ç°ç”¨æˆ·ä¿¡æ¯è·å–
- [ ] æ”¯ä»˜å®ç‰¹æœ‰é…ç½®å¤„ç†

#### æŠ–éŸ³å°ç¨‹åºé€‚é…å™¨
- [ ] å®ç°æŠ–éŸ³ç™»å½•æ¥å£
- [ ] è§†é¢‘ç›¸å…³ç‰¹æ€§æ”¯æŒ
- [ ] æŠ–éŸ³å¼€æ”¾å¹³å°é›†æˆ

### é˜¶æ®µä¸‰ï¼šç»Ÿä¸€è®¤è¯æœåŠ¡ï¼ˆ2-3å‘¨ï¼‰

#### æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
- [ ] ç»Ÿä¸€ç™»å½•æœåŠ¡å¼€å‘
- [ ] è´¦å·è‡ªåŠ¨åˆå¹¶é€»è¾‘
- [ ] å¹³å°èº«ä»½ç®¡ç†æœåŠ¡
- [ ] æ•°æ®åŒæ­¥æœºåˆ¶

#### APIæ¥å£å¼€å‘
- [ ] ç»Ÿä¸€ç™»å½•æ¥å£
- [ ] ç”¨æˆ·èµ„æ–™æ¥å£
- [ ] æ‰‹æœºå·æ¢ç»‘æ¥å£
- [ ] è´¦å·åˆå¹¶æ¥å£

### é˜¶æ®µå››ï¼šæµ‹è¯•å’Œä¼˜åŒ–ï¼ˆ1-2å‘¨ï¼‰

#### åŠŸèƒ½æµ‹è¯•
- [ ] å•å¹³å°ç™»å½•æµ‹è¯•
- [ ] è·¨å¹³å°æ•°æ®ä¸€è‡´æ€§æµ‹è¯•
- [ ] è´¦å·åˆå¹¶åŠŸèƒ½æµ‹è¯•
- [ ] å¼‚å¸¸åœºæ™¯æµ‹è¯•

#### æ€§èƒ½ä¼˜åŒ–
- [ ] æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
- [ ] Redisç¼“å­˜ä¼˜åŒ–
- [ ] æ¥å£å“åº”æ—¶é—´ä¼˜åŒ–
- [ ] å¹¶å‘å‹åŠ›æµ‹è¯•

---

## ğŸ“Š æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–

### æ¨èç´¢å¼•é…ç½®

```sql
-- m_memberè¡¨ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_member_phone ON m_member(phone);
CREATE INDEX idx_member_union_id ON m_member(unionId); 
CREATE INDEX idx_member_club_status ON m_member(club_id, is_valid, is_delete);
CREATE INDEX idx_member_create_time ON m_member(create_time);

-- m_platform_identityè¡¨ç´¢å¼•
CREATE UNIQUE INDEX uk_platform_user ON m_platform_identity(platform_type, app_id, platform_user_id);
CREATE INDEX idx_member_platform ON m_platform_identity(member_id, platform_type);
CREATE INDEX idx_union_id ON m_platform_identity(union_id);
CREATE INDEX idx_last_login_time ON m_platform_identity(last_login_time);

-- m_app_configè¡¨ç´¢å¼•
CREATE INDEX idx_platform_club ON m_app_config(platform_type, club_id);
CREATE INDEX idx_status_create ON m_app_config(status, create_time);

-- m_member_merge_logè¡¨ç´¢å¼•
CREATE INDEX idx_target_member_time ON m_member_merge_log(target_member_id, merge_time);
CREATE INDEX idx_source_member ON m_member_merge_log(source_member_id);
```

---

## ğŸ”’ å®‰å…¨æ³¨æ„äº‹é¡¹

### 1. æ•æ„Ÿæ•°æ®ä¿æŠ¤

```java
/**
 * æ•æ„Ÿä¿¡æ¯è„±æ•å·¥å…·
 */
@Component
public class DataMaskingUtil {
    
    /**
     * æ‰‹æœºå·è„±æ•
     */
    public static String maskPhone(String phone) {
        if (StringUtils.isEmpty(phone) || phone.length() < 7) {
            return phone;
        }
        return phone.substring(0, 3) + "****" + phone.substring(7);
    }
    
    /**
     * èº«ä»½è¯è„±æ•
     */
    public static String maskIdCard(String idCard) {
        if (StringUtils.isEmpty(idCard) || idCard.length() < 8) {
            return idCard;
        }
        return idCard.substring(0, 4) + "**********" + idCard.substring(14);
    }
}
```

### 2. æ¥å£å®‰å…¨é˜²æŠ¤

```java
/**
 * æ¥å£å®‰å…¨æ‹¦æˆªå™¨
 */
@Component
public class SecurityInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        // 1. é¢‘ç‡é™åˆ¶æ£€æŸ¥
        if (!rateLimitCheck(request)) {
            throw new BusinessException("è¯·æ±‚è¿‡äºé¢‘ç¹");
        }
        
        // 2. IPç™½åå•æ£€æŸ¥ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
        if (isProductionEnv() && !ipWhitelistCheck(request)) {
            throw new BusinessException("è®¿é—®è¢«æ‹’ç»");
        }
        
        // 3. ç­¾åæ ¡éªŒï¼ˆé‡è¦æ¥å£ï¼‰
        if (needSignatureVerify(request) && !signatureVerify(request)) {
            throw new BusinessException("ç­¾åéªŒè¯å¤±è´¥");
        }
        
        return true;
    }
}
```

### 3. æ—¥å¿—å®‰å…¨

```java
/**
 * å®‰å…¨æ—¥å¿—é…ç½®
 */
@Slf4j
public class SecurityLogger {
    
    /**
     * ç™»å½•æ—¥å¿—ï¼ˆè„±æ•ï¼‰
     */
    public void logLogin(Long memberId, String phone, String platformType, String appId) {
        log.info("ç”¨æˆ·ç™»å½•æˆåŠŸ - ä¼šå‘˜ID: {}, æ‰‹æœºå·: {}, å¹³å°: {}, åº”ç”¨: {}", 
            memberId, DataMaskingUtil.maskPhone(phone), platformType, appId);
    }
    
    /**
     * æ•æ„Ÿæ“ä½œæ—¥å¿—
     */
    public void logSensitiveOperation(Long memberId, String operation, String details) {
        log.warn("æ•æ„Ÿæ“ä½œ - ä¼šå‘˜ID: {}, æ“ä½œ: {}, è¯¦æƒ…: {}", memberId, operation, details);
    }
}
```

---

## ğŸ“ˆ ç›‘æ§å’Œè¿ç»´

### 1. å…³é”®æŒ‡æ ‡ç›‘æ§

```yaml
# ç›‘æ§æŒ‡æ ‡é…ç½®
monitoring:
  metrics:
    - name: "ç™»å½•æˆåŠŸç‡"
      expression: "login_success_count / login_total_count * 100"
      threshold: "> 95%"
    
    - name: "æ¥å£å“åº”æ—¶é—´" 
      expression: "avg(response_time)"
      threshold: "< 500ms"
      
    - name: "è´¦å·åˆå¹¶é¢‘ç‡"
      expression: "account_merge_count / hour"
      threshold: "< 100/hour"
      
    - name: "ç¼“å­˜å‘½ä¸­ç‡"
      expression: "cache_hit_count / cache_total_count * 100"  
      threshold: "> 80%"
```

### 2. å¼‚å¸¸å‘Šè­¦é…ç½®

```java
/**
 * å¼‚å¸¸ç›‘æ§æœåŠ¡
 */
@Service
public class AlertService {
    
    /**
     * ç™»å½•å¼‚å¸¸å‘Šè­¦
     */
    public void alertLoginException(String platformType, String appId, Exception e) {
        if (isHighPriorityException(e)) {
            sendAlert(String.format("ç™»å½•å¼‚å¸¸å‘Šè­¦ - å¹³å°: %s, åº”ç”¨: %s, å¼‚å¸¸: %s", 
                platformType, appId, e.getMessage()));
        }
    }
    
    /**
     * æ•°æ®ä¸€è‡´æ€§å¼‚å¸¸å‘Šè­¦
     */
    public void alertDataConsistencyError(Long memberId, String details) {
        sendAlert(String.format("æ•°æ®ä¸€è‡´æ€§å¼‚å¸¸ - ä¼šå‘˜ID: %s, è¯¦æƒ…: %s", memberId, details));
    }
}
```

---

## ğŸ“ æ€»ç»“

æœ¬å¼€å‘æ–‡æ¡£æä¾›äº†é©¬æœ¯ä¿±ä¹éƒ¨å¤šå¹³å°ç»Ÿä¸€ä¼šå‘˜ä½“ç³»çš„å®Œæ•´æŠ€æœ¯æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š

### âœ… æ ¸å¿ƒä¼˜åŠ¿
- **æ¶æ„ç®€æ´**ï¼šåŸºäºç°æœ‰å•ä½“æ¶æ„ï¼Œæœ€å°åŒ–æ”¹é€ æˆæœ¬
- **æ•°æ®ä¸€è‡´**ï¼šè·¨å¹³å°æ•°æ®å®Œå…¨åŒæ­¥ï¼Œæ— ä¸»å¹³å°æ¦‚å¿µ
- **é«˜åº¦æ‰©å±•**ï¼šæ”¯æŒå‡ ç™¾ä¸ªåº”ç”¨æ¥å…¥ï¼Œæ’ä»¶åŒ–å¹³å°é€‚é…
- **ä¸šåŠ¡å‹å¥½**ï¼šå®Œå–„çš„è´¦å·åˆå¹¶å’Œæ‰‹æœºå·æ¢ç»‘åŠŸèƒ½
- **æ€§èƒ½ä¼˜è¶Š**ï¼šæ”¯æ’‘ç™¾ä¸‡ä¼šå‘˜ï¼Œå“åº”æ—¶é—´<500ms

### ğŸ“ˆ é¡¹ç›®æ”¶ç›Š
- **å¼€å‘æ•ˆç‡**ï¼šç»Ÿä¸€çš„ç”¨æˆ·ä½“ç³»ï¼Œå‡å°‘é‡å¤å¼€å‘
- **ç”¨æˆ·ä½“éªŒ**ï¼šè·¨å¹³å°æ•°æ®åŒæ­¥ï¼Œæ— ç¼åˆ‡æ¢ä½¿ç”¨
- **ä¸šåŠ¡å¢é•¿**ï¼šæ”¯æŒå¿«é€Ÿæ‰©å±•åˆ°æ–°å¹³å°å’Œæ–°åº”ç”¨
- **è¿ç»´ç®€åŒ–**ï¼šç»Ÿä¸€çš„ç”¨æˆ·ç®¡ç†å’Œæ•°æ®ç»´æŠ¤

### ğŸ¯ å®æ–½å»ºè®®
1. **åˆ†é˜¶æ®µå®æ–½**ï¼šæŒ‰ç…§4ä¸ªé˜¶æ®µé€æ­¥æ¨è¿›ï¼Œç¡®ä¿ç¨³å®šæ€§
2. **å……åˆ†æµ‹è¯•**ï¼šé‡ç‚¹æµ‹è¯•è·¨å¹³å°æ•°æ®ä¸€è‡´æ€§å’Œè´¦å·åˆå¹¶åŠŸèƒ½
3. **æ€§èƒ½è°ƒä¼˜**ï¼šå…³æ³¨æ•°æ®åº“ç´¢å¼•å’Œç¼“å­˜ç­–ç•¥ä¼˜åŒ–  
4. **å®‰å…¨åŠ å›º**ï¼šæ•æ„Ÿæ•°æ®è„±æ•å’Œæ¥å£å®‰å…¨é˜²æŠ¤
5. **ç›‘æ§å®Œå–„**ï¼šå»ºç«‹å®Œæ•´çš„ç›‘æ§å‘Šè­¦ä½“ç³»

**é¢„è®¡æ€»å¼€å‘å‘¨æœŸ**ï¼š8-12å‘¨  
**é¢„æœŸæ€§èƒ½æŒ‡æ ‡**ï¼šæ”¯æŒ100ä¸‡ä¼šå‘˜ï¼Œ5000QPSï¼Œç™»å½•å“åº”æ—¶é—´<500ms  
**æŠ€æœ¯é£é™©**ï¼šä½ï¼ŒåŸºäºæˆç†Ÿçš„Spring Bootå’ŒSa-Tokenæ¡†æ¶