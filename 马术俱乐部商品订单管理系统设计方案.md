# 马术俱乐部商品订单管理系统设计方案

## 一、商品模块表结构设计

### 1. 商品基础表 (m_product)

```sql
CREATE TABLE m_product
(
   product_id   BIGINT AUTO_INCREMENT COMMENT '商品ID' PRIMARY KEY,
   club_id      BIGINT                                NOT NULL COMMENT '俱乐部ID',
   product_name VARCHAR(100)                          NOT NULL COMMENT '商品名称',
   product_code VARCHAR(50) DEFAULT ''                NOT NULL COMMENT '商品编码',
   product_type TINYINT                               NOT NULL COMMENT '商品类型: 1-课程 2-课时包 3-活动',
   sub_type     VARCHAR(50) DEFAULT ''                NOT NULL COMMENT '商品子类型',
   description  TEXT                                  NOT NULL COMMENT '商品描述',
   images       TEXT                                  NOT NULL COMMENT '商品图片地址列表JSON格式',
   status       TINYINT     DEFAULT 1                 NOT NULL COMMENT '商品状态: 1-上架 2-下架 3-售罄',
   sort_order   INT         DEFAULT 0                 NOT NULL COMMENT '排序',
   create_by    VARCHAR(50) DEFAULT ''                NOT NULL COMMENT '创建人',
   create_time  DATETIME    DEFAULT CURRENT_TIMESTAMP NOT NULL COMMENT '创建时间',
   update_by    VARCHAR(50) DEFAULT ''                NOT NULL COMMENT '更新人',
   update_time  DATETIME    DEFAULT CURRENT_TIMESTAMP NOT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
   is_valid     INT         DEFAULT 1                 NOT NULL COMMENT '是否有效;1=有效;0=无效;',
   is_delete    INT         DEFAULT 0                 NOT NULL COMMENT '是否删除;1=已删除;0=未删除;',
   CONSTRAINT uk_product_code UNIQUE (club_id, product_code)
) COMMENT '商品基础表';

CREATE INDEX idx_club_id ON m_product (club_id);
CREATE INDEX idx_product_type ON m_product (product_type);
CREATE INDEX idx_status ON m_product (status);
CREATE INDEX idx_is_delete ON m_product (is_delete);
```

**表说明与规则**：

- 商品统一管理表，所有商品类型的基础信息
- product_code 在同一俱乐部内唯一
- images 字段存储JSON格式的图片地址数组
- 支持软删除，通过 is_delete 字段控制

### 2. 课程商品表 (m_product_course)

```sql
CREATE TABLE m_product_course
(
   id                 BIGINT AUTO_INCREMENT COMMENT '主键ID' PRIMARY KEY,
   product_id         BIGINT                                   NOT NULL COMMENT '商品ID',
   class_type         TINYINT                                  NOT NULL COMMENT '课程分类: 1-单人课 2-多人课',
   duration_minutes   INT            DEFAULT 0                 NOT NULL COMMENT '时长（分钟）',
   duration_periods   DECIMAL(4, 1)  DEFAULT 0.0               NOT NULL COMMENT '时长（鞍时）',
   max_students       INT            DEFAULT 1                 NOT NULL COMMENT '最大人数',
   coach_fee          DECIMAL(10, 2) DEFAULT 0.00              NOT NULL COMMENT '教练费',
   horse_fee          DECIMAL(10, 2) DEFAULT 0.00              NOT NULL COMMENT '马匹费用',
   base_price         DECIMAL(10, 2) GENERATED ALWAYS AS (coach_fee + horse_fee) STORED COMMENT '基础单价=教练费+马匹费用',
   -- 多人课特殊配置
   multi_price_config TEXT COMMENT '多人课价格配置JSON: {coaches: [{coach_id, prices: {2: price, 3: price, 4: price, 5: price}}]}',
   create_by          VARCHAR(50)    DEFAULT ''                NOT NULL COMMENT '创建人',
   create_time        DATETIME       DEFAULT CURRENT_TIMESTAMP NOT NULL COMMENT '创建时间',
   update_by          VARCHAR(50)    DEFAULT ''                NOT NULL COMMENT '更新人',
   update_time        DATETIME       DEFAULT CURRENT_TIMESTAMP NOT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
   CONSTRAINT uk_product_id UNIQUE (product_id)
) COMMENT '课程商品表';

CREATE INDEX idx_class_type ON m_product_course (class_type);
```

**表说明与规则**：

- 课程分为单人课和多人课两种基本类型
- 课程级别通过商品基础表的 product_name 和 sub_type 来区分
- base_price 为计算字段，自动根据教练费和马匹费计算
- 单人课直接使用 base_price
- 多人课通过 multi_price_config 配置不同人数的价格
- 支持到店后修改教练费和马匹费用，重新计算基础单价

### 3. 课时包商品表 (m_product_package)

```sql
CREATE TABLE m_product_package
(
   id             BIGINT AUTO_INCREMENT COMMENT '主键ID' PRIMARY KEY,
   product_id     BIGINT                                NOT NULL COMMENT '商品ID',
   details        TEXT                                  NOT NULL COMMENT '课包详情',
   price          DECIMAL(10, 2)                        NOT NULL COMMENT '课包单价',
   total_sessions INT         DEFAULT 0                 NOT NULL COMMENT '总课时数',
   validity_days  INT         DEFAULT 365               NOT NULL COMMENT '有效期（天）',
   stock_quantity INT         DEFAULT 0                 NOT NULL COMMENT '库存数量',
   create_by      VARCHAR(50) DEFAULT ''                NOT NULL COMMENT '创建人',
   create_time    DATETIME    DEFAULT CURRENT_TIMESTAMP NOT NULL COMMENT '创建时间',
   update_by      VARCHAR(50) DEFAULT ''                NOT NULL COMMENT '更新人',
   update_time    DATETIME    DEFAULT CURRENT_TIMESTAMP NOT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
   CONSTRAINT uk_product_id UNIQUE (product_id)
) COMMENT '课时包商品表';
```

**表说明与规则**：

- 移除了 package_type，统一管理
- 移除了单一用户绑定，支持多用户购买同一课时包
- 库存管理：购买时扣减库存，退款时增加库存
- 有效期从购买日期开始计算

### 4. 课时包用户关联表 (m_package_member)

```sql
CREATE TABLE m_package_member
(
   id                 BIGINT AUTO_INCREMENT COMMENT '主键ID' PRIMARY KEY,
   order_item_id      BIGINT                                NOT NULL COMMENT '订单明细ID',
   package_id         BIGINT                                NOT NULL COMMENT '课时包ID',
   member_id          BIGINT                                NOT NULL COMMENT '会员ID',
   remaining_sessions INT                                   NOT NULL COMMENT '剩余课时数',
   expire_date        DATE                                  NOT NULL COMMENT '到期日期',
   coach_id           BIGINT      DEFAULT 0 COMMENT '绑定教练ID（可选）',
   status             TINYINT     DEFAULT 1                 NOT NULL COMMENT '状态: 1-正常 2-已过期 3-已用完',
   create_by          VARCHAR(50) DEFAULT ''                NOT NULL COMMENT '创建人',
   create_time        DATETIME    DEFAULT CURRENT_TIMESTAMP NOT NULL COMMENT '创建时间',
   update_by          VARCHAR(50) DEFAULT ''                NOT NULL COMMENT '更新人',
   update_time        DATETIME    DEFAULT CURRENT_TIMESTAMP NOT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) COMMENT '课时包用户关联表';

CREATE INDEX idx_order_item_id ON m_package_member (order_item_id);
CREATE INDEX idx_member_id ON m_package_member (member_id);
CREATE INDEX idx_expire_date ON m_package_member (expire_date);
```

**表说明与规则**：

- 支持同一课时包绑定多个用户
- 每个用户的课时包独立计算剩余次数和到期时间
- 约课时扣减对应用户的剩余次数

### 5. 活动商品表 (m_product_activity)

```sql
CREATE TABLE m_product_activity
(
   id                BIGINT AUTO_INCREMENT COMMENT '主键ID' PRIMARY KEY,
   product_id        BIGINT                                 NOT NULL COMMENT '商品ID',
   activity_name     VARCHAR(50)                            NOT NULL COMMENT '活动名称（最多5个字）',
   activity_details  TEXT                                   NOT NULL COMMENT '活动详情全文介绍',
   start_time        DATETIME                               NOT NULL COMMENT '活动开始时间',
   end_time          DATETIME                               NOT NULL COMMENT '活动结束时间',
   activity_location VARCHAR(200) DEFAULT '' COMMENT '活动地点',
   price             DECIMAL(10, 2)                         NOT NULL COMMENT '活动单价',
   max_participants  INT                                    NOT NULL COMMENT '最大参与人数',
   refund_rule       TEXT                                   NOT NULL COMMENT '退款规则',
   detail_images     TEXT                                   NOT NULL COMMENT '详情图片地址列表JSON格式（最多9张）',
   create_by         VARCHAR(50)  DEFAULT ''                NOT NULL COMMENT '创建人',
   create_time       DATETIME     DEFAULT CURRENT_TIMESTAMP NOT NULL COMMENT '创建时间',
   update_by         VARCHAR(50)  DEFAULT ''                NOT NULL COMMENT '更新人',
   update_time       DATETIME     DEFAULT CURRENT_TIMESTAMP NOT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
   CONSTRAINT uk_product_id UNIQUE (product_id)
) COMMENT '活动商品表';

CREATE INDEX idx_start_time ON m_product_activity (start_time);
CREATE INDEX idx_end_time ON m_product_activity (end_time);
```

**表说明与规则**：

- 活动时间改为开始时间和结束时间，精确到秒
- 移除 current_participants，通过订单明细统计实际参与人数
- 支持长时间跨度的活动（如多天活动）

### 6. 商品教练关联表 (m_product_coach)

```sql
CREATE TABLE m_product_coach
(
   id          BIGINT AUTO_INCREMENT COMMENT '主键ID' PRIMARY KEY,
   product_id  BIGINT                                NOT NULL COMMENT '商品ID',
   coach_id    BIGINT                                NOT NULL COMMENT '教练ID',
   is_default  TINYINT     DEFAULT 0                 NOT NULL COMMENT '是否默认教练: 1-是 0-否',
   create_by   VARCHAR(50) DEFAULT ''                NOT NULL COMMENT '创建人',
   create_time DATETIME    DEFAULT CURRENT_TIMESTAMP NOT NULL COMMENT '创建时间',
   CONSTRAINT uk_product_coach UNIQUE (product_id, coach_id)
) COMMENT '商品教练关联表';

CREATE INDEX idx_product_id ON m_product_coach (product_id);
CREATE INDEX idx_coach_id ON m_product_coach (coach_id);
```

**表说明与规则**：

- 管理商品可选教练列表
- 支持设置默认教练，但用户可在预约时更换

## 二、订单与业务流程模块表结构设计

### 1. 订单主表 (m_order)

```sql
CREATE TABLE m_order
(
   order_id       BIGINT AUTO_INCREMENT COMMENT '订单ID' PRIMARY KEY,
   order_no       VARCHAR(50)                              NOT NULL COMMENT '订单号',
   club_id        BIGINT                                   NOT NULL COMMENT '俱乐部ID',
   member_id      BIGINT                                   NOT NULL COMMENT '会员ID',
   order_type     TINYINT                                  NOT NULL COMMENT '订单类型: 1-课程 2-课时包 3-活动',
   order_status   TINYINT        DEFAULT 1                 NOT NULL COMMENT '订单状态: 1-待支付 2-已支付 3-已完成 4-已取消 5-已退款',
   total_amount   DECIMAL(10, 2)                           NOT NULL COMMENT '订单总金额',
   paid_amount    DECIMAL(10, 2) DEFAULT 0.00              NOT NULL COMMENT '已支付金额',
   payment_method VARCHAR(50)    DEFAULT '' COMMENT '支付方式',
   payment_time   DATETIME NULL COMMENT '支付时间',
   remark         VARCHAR(500)   DEFAULT '' COMMENT '订单备注',
   create_by      VARCHAR(50)    DEFAULT ''                NOT NULL COMMENT '创建人',
   create_time    DATETIME       DEFAULT CURRENT_TIMESTAMP NOT NULL COMMENT '创建时间',
   update_by      VARCHAR(50)    DEFAULT ''                NOT NULL COMMENT '更新人',
   update_time    DATETIME       DEFAULT CURRENT_TIMESTAMP NOT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
   is_valid       INT            DEFAULT 1                 NOT NULL COMMENT '是否有效;1=有效;0=无效;',
   is_delete      INT            DEFAULT 0                 NOT NULL COMMENT '是否删除;1=已删除;0=未删除;',
   CONSTRAINT uk_order_no UNIQUE (order_no)
) COMMENT '订单主表';

CREATE INDEX idx_club_id ON m_order (club_id);
CREATE INDEX idx_member_id ON m_order (member_id);
CREATE INDEX idx_order_status ON m_order (order_status);
CREATE INDEX idx_create_time ON m_order (create_time);
CREATE INDEX idx_payment_time ON m_order (payment_time);
CREATE INDEX idx_is_delete ON m_order (is_delete);
```

**表说明与规则**：

- 订单号全局唯一，格式建议：俱乐部编码+日期+序号
- 订单状态流转：待支付→已支付→已完成，支持取消和退款
- 支持部分支付场景

### 2. 订单明细表 (m_order_item)

```sql
CREATE TABLE m_order_item
(
   id           BIGINT AUTO_INCREMENT COMMENT '主键ID' PRIMARY KEY,
   order_id     BIGINT                             NOT NULL COMMENT '订单ID',
   product_id   BIGINT                             NOT NULL COMMENT '商品ID',
   product_name VARCHAR(100)                       NOT NULL COMMENT '商品名称',
   product_type TINYINT                            NOT NULL COMMENT '商品类型: 1-课程 2-课时包 3-活动',
   quantity     INT      DEFAULT 1                 NOT NULL COMMENT '数量',
   unit_price   DECIMAL(10, 2)                     NOT NULL COMMENT '单价',
   total_price  DECIMAL(10, 2)                     NOT NULL COMMENT '小计',
   coach_id     BIGINT   DEFAULT 0 COMMENT '关联教练ID',
   item_config  TEXT COMMENT '商品配置JSON格式',
   create_time  DATETIME DEFAULT CURRENT_TIMESTAMP NOT NULL COMMENT '创建时间'
) COMMENT '订单明细表';

CREATE INDEX idx_order_id ON m_order_item (order_id);
CREATE INDEX idx_product_id ON m_order_item (product_id);
```

**表说明与规则**：

- 记录订单创建时的商品快照信息
- item_config 存储特殊配置，如多人课选择的人数等
- 单价和小计在创建时固定，不受后续商品价格变动影响

### 3. 预约/约课表 (m_booking)

```sql
CREATE TABLE m_booking
(
   booking_id       BIGINT AUTO_INCREMENT COMMENT '预约ID' PRIMARY KEY,
   order_id         BIGINT                                   NOT NULL COMMENT '订单ID',
   order_item_id    BIGINT                                   NOT NULL COMMENT '订单明细ID',
   club_id          BIGINT                                   NOT NULL COMMENT '俱乐部ID',
   member_id        BIGINT                                   NOT NULL COMMENT '会员ID',
   product_id       BIGINT                                   NOT NULL COMMENT '商品ID',
   coach_id         BIGINT         DEFAULT 0 COMMENT '教练ID',
   horse_id         BIGINT         DEFAULT 0 COMMENT '马匹ID',
   start_time       DATETIME                                 NOT NULL COMMENT '预约开始时间',
   end_time         DATETIME                                 NOT NULL COMMENT '预约结束时间',
   booking_status   TINYINT        DEFAULT 1                 NOT NULL COMMENT '预约状态: 1-待确认 2-已确认 3-进行中 4-已完成 5-已取消',
   actual_coach_fee DECIMAL(10, 2) DEFAULT 0.00 COMMENT '实际教练费（到店可调整）',
   actual_horse_fee DECIMAL(10, 2) DEFAULT 0.00 COMMENT '实际马匹费（到店可调整）',
   arrival_time     DATETIME NULL COMMENT '到店时间',
   completion_time  DATETIME NULL COMMENT '完成时间',
   cancel_reason    VARCHAR(500)   DEFAULT '' COMMENT '取消原因',
   create_by        VARCHAR(50)    DEFAULT ''                NOT NULL COMMENT '创建人',
   create_time      DATETIME       DEFAULT CURRENT_TIMESTAMP NOT NULL COMMENT '创建时间',
   update_by        VARCHAR(50)    DEFAULT ''                NOT NULL COMMENT '更新人',
   update_time      DATETIME       DEFAULT CURRENT_TIMESTAMP NOT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) COMMENT '预约/约课表';

CREATE INDEX idx_order_id ON m_booking (order_id);
CREATE INDEX idx_member_id ON m_booking (member_id);
CREATE INDEX idx_coach_id ON m_booking (coach_id);
CREATE INDEX idx_start_time ON m_booking (start_time);
CREATE INDEX idx_booking_status ON m_booking (booking_status);
```

**表说明与规则**：

- 预约时间改为开始时间和结束时间，支持跨天预约
- 支持到店后调整教练费和马匹费用
- 新增到店时间和完成时间字段，支持前台核销流程
- 预约状态支持"进行中"状态，用于课程进行过程中的状态管理

### 4. 课单表 (m_lesson_schedule)

```sql
CREATE TABLE m_lesson_schedule
(
   schedule_id       BIGINT AUTO_INCREMENT COMMENT '课单ID' PRIMARY KEY,
   booking_id        BIGINT                                NOT NULL COMMENT '预约ID',
   schedule_no       VARCHAR(50)                           NOT NULL COMMENT '课单号',
   club_id           BIGINT                                NOT NULL COMMENT '俱乐部ID',
   member_id         BIGINT                                NOT NULL COMMENT '会员ID',
   coach_id          BIGINT                                NOT NULL COMMENT '教练ID',
   horse_id          BIGINT      DEFAULT 0 COMMENT '马匹ID',
   lesson_date       DATE                                  NOT NULL COMMENT '上课日期',
   start_time        DATETIME                              NOT NULL COMMENT '开始时间',
   end_time          DATETIME                              NOT NULL COMMENT '结束时间',
   lesson_status     TINYINT     DEFAULT 1                 NOT NULL COMMENT '课单状态: 1-待上课 2-进行中 3-已完成 4-已取消',
   notification_sent TINYINT     DEFAULT 0                 NOT NULL COMMENT '是否已发送通知: 0-未发送 1-已发送',
   reminder_sent     TINYINT     DEFAULT 0                 NOT NULL COMMENT '是否已发送提醒: 0-未发送 1-已发送',
   create_by         VARCHAR(50) DEFAULT ''                NOT NULL COMMENT '创建人',
   create_time       DATETIME    DEFAULT CURRENT_TIMESTAMP NOT NULL COMMENT '创建时间',
   update_by         VARCHAR(50) DEFAULT ''                NOT NULL COMMENT '更新人',
   update_time       DATETIME    DEFAULT CURRENT_TIMESTAMP NOT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
   CONSTRAINT uk_schedule_no UNIQUE (schedule_no)
) COMMENT '课单表';

CREATE INDEX idx_booking_id ON m_lesson_schedule (booking_id);
CREATE INDEX idx_coach_id ON m_lesson_schedule (coach_id);
CREATE INDEX idx_lesson_date ON m_lesson_schedule (lesson_date);
CREATE INDEX idx_start_time ON m_lesson_schedule (start_time);
```

**表说明与规则**：

- 支付完成后自动生成课单
- 课单号独立生成，便于教练和学员识别
- 支持通知和提醒发送状态跟踪
- 用于推送教练微信公众号信息

### 5. 前台核销记录表 (m_checkin_record)

```sql
CREATE TABLE m_checkin_record
(
   id              BIGINT AUTO_INCREMENT COMMENT '主键ID' PRIMARY KEY,
   booking_id      BIGINT                                 NOT NULL COMMENT '预约ID',
   schedule_id     BIGINT                                 NOT NULL COMMENT '课单ID',
   member_id       BIGINT                                 NOT NULL COMMENT '会员ID',
   checkin_time    DATETIME                               NOT NULL COMMENT '签到时间',
   checkin_staff   VARCHAR(50)  DEFAULT '' COMMENT '签到确认人员',
   checkout_time   DATETIME NULL COMMENT '签退时间',
   checkout_staff  VARCHAR(50)  DEFAULT '' COMMENT '签退确认人员',
   actual_duration INT          DEFAULT 0 COMMENT '实际上课时长（分钟）',
   remark          VARCHAR(500) DEFAULT '' COMMENT '备注',
   create_by       VARCHAR(50)  DEFAULT ''                NOT NULL COMMENT '创建人',
   create_time     DATETIME     DEFAULT CURRENT_TIMESTAMP NOT NULL COMMENT '创建时间'
) COMMENT '前台核销记录表';

CREATE INDEX idx_booking_id ON m_checkin_record (booking_id);
CREATE INDEX idx_member_id ON m_checkin_record (member_id);
CREATE INDEX idx_checkin_time ON m_checkin_record (checkin_time);
```

**表说明与规则**：

- 记录学员到店签到和签退信息
- 支持前台工作人员确认到达操作
- 记录实际上课时长，用于课时包扣减

## 三、系统业务流程设计

### 完整业务流程图

```
学员预约教练 → 生成支付订单 → 支付成功 → 生成课单 → 推送教练公众号
      ↓              ↓            ↓         ↓           ↓
   选择时间/教练    订单状态:待支付   订单状态:已支付  课单状态:待上课   通知发送完成
                                                      ↓
课前3小时提醒 ← 定时任务检查 ← 课单创建完成 ← 课单生成
      ↓
  到店上课
      ↓
前台核销(确认到达) → 订单完成 → 课时包扣减(如适用) → 流程结束
      ↓              ↓            ↓
   签到记录创建    订单状态:已完成   更新剩余课时
```

### 关键业务规则

1. **预约规则**
   - 单人课：可随时预约，但需确认教练档期
   - 多人课：需达到最小人数才能成班
   - 课时包：从绑定用户的剩余课时中扣减

2. **支付规则**
   - 课程：支付后立即生成课单
   - 课时包：支付后创建用户绑定关系，按有效期管理
   - 活动：支付后确认参与名额

3. **通知规则**
   - 支付完成：立即推送教练微信公众号
   - 课前提醒：开课前3小时自动提醒学员和教练
   - 状态变更：实时更新相关方

4. **核销规则**
   - 前台确认到达：更新预约状态为"进行中"
   - 课程完成：前台确认完成，订单状态改为"已完成"
   - 课时包扣减：完成后自动扣减对应课时

## 四、页面设计更新

### 商品列表页面（新增功能）

```
┌─────────────────────────────────────────────────────────────────┐
│ 商品管理                                              [+ 新增商品] │
├─────────────────────────────────────────────────────────────────┤
│ 筛选条件：                                                      │
│ [商品类型▼] [课程分类▼] [状态▼] [教练▼] [搜索] [重置]          │
├─────────────────────────────────────────────────────────────────┤
│ ┌─────┬────────┬──────┬──────┬──────┬──────┬──────┬────────┐     │
│ │选择 │商品编码 │商品名称│类型/级别│状态│价格构成│库存│操作   │     │
│ ├─────┼────────┼──────┼──────┼──────┼──────┼──────┼────────┤     │
│ │ □   │C001   │体验课  │单人/体验│上架│200(150+50)│--│编辑|复制│  │
│ │ □   │P001   │课包A  │课时包   │上架│2000     │25 │编辑|下架│     │
│ │ □   │A001   │春季活动│活动    │上架│300      │15/30│查看详情│    │
│ └─────┴────────┴──────┴──────┴──────┴──────┴──────┴────────┘     │
└─────────────────────────────────────────────────────────────────┘
```

### 新增课程页面（更新）

```
┌─────────────────────────────────────────────────────────────────┐
│ 新增课程                                                        │
├─────────────────────────────────────────────────────────────────┤
│ 基础信息:                                                       │
│ 商品名称: [_________________] 商品编码: [__________]             │
│ 课程分类: ⦿单人课 ○多人课                                      │
│ 商品描述: [____________________]                               │
│                                                                 │
│ 课程配置:                                                       │
│ 时长: [60] 分钟  鞍时: [1.0] 最大人数: [1]                     │
│ 教练费: [150] 马匹费: [50] 基础单价: [200] (自动计算)           │
│                                                                 │
│ 教练设置:                                                       │
│ 可选教练: □ 李教练 □ 王教练 □ 张教练                           │
│                                                                 │
│ 多人课价格配置: (仅多人课显示)                                  │
│ ┌──────────────────────────────────────────────────────────┐     │
│ │教练: [李教练▼] 2人:[180/人] 3人:[160/人] 4人:[150/人]   │     │
│ │[+ 添加教练配置]                                         │     │
│ └──────────────────────────────────────────────────────────┘     │
│                                                                 │
│ 费用调整说明: 客户到店后可根据实际情况调整教练费和马匹费用       │
│                                          [保存] [取消]          │
└─────────────────────────────────────────────────────────────────┘
```

### 课时包页面（更新）

```
┌─────────────────────────────────────────────────────────────────┐
│ 新增课时包                                                      │
├─────────────────────────────────────────────────────────────────┤
│ 基础信息:                                                       │
│ 商品名称: [_________________] 商品编码: [__________]             │
│ 商品描述: [____________________]                               │
│                                                                 │
│ 课包配置:                                                       │
│ 详情描述: [_________________________________]                  │
│ 单价: [2000] 总课时数: [10] 有效期: [365] 天                   │
│ 库存数量: [100]                                                │
│                                                                 │
│ 绑定说明:                                                       │
│ ✓ 支持多用户购买同一课时包                                      │
│ ✓ 每个用户的课时独立计算                                        │
│ ✓ 可选择绑定特定教练                                           │
│                                                                 │
│                                          [保存] [取消]          │
└─────────────────────────────────────────────────────────────────┘
```

### 课程表页面设计

课程表页面是展示课程安排的核心页面，需要支持多种视图和丰富的交互功能。

#### 页面布局（周视图）

```
┌─────────────────────────────────────────────────────────────────┐
│ 课程表管理                    [日视图] [周视图] [月视图] [新增课程] │
├─────────────────────────────────────────────────────────────────┤
│ 筛选条件：                                                      │
│ [教练▼] [马匹▼] [会员▼] [课程类型▼] [状态▼] [本周] [←] [→]     │
├─────────────────────────────────────────────────────────────────┤
│ 2024年8月12日 - 2024年8月18日                                   │
│                                                                 │
│    时间    │ 周一8/12│ 周二8/13│ 周三8/14│ 周四8/15│ 周五8/16│   │
│ ──────────┼─────────┼─────────┼─────────┼─────────┼─────────┤   │
│  09:00    │ [李教练] │         │ [王教练] │         │ [张教练] │   │
│  -10:00   │ 体验课  │         │ 基础课  │         │ 进阶课  │   │
│           │ 张小明  │         │ 李小红  │         │ 王小刚  │   │
│           │ 马001   │         │ 马002   │         │ 马003   │   │
│ ──────────┼─────────┼─────────┼─────────┼─────────┼─────────┤   │
│  10:00    │         │ [李教练] │         │ [多人课] │         │   │
│  -11:00   │         │ 马主课  │         │ 小组课  │         │   │
│           │         │ 赵小华  │         │ 3人班   │         │   │
│           │         │ 马004   │         │ 马005   │         │   │
│ ──────────┼─────────┼─────────┼─────────┼─────────┼─────────┤   │
│  14:00    │ [王教练] │         │ [张教练] │         │ [李教练] │   │
│  -15:00   │ 高级课  │         │ 体验课  │         │ 基础课  │   │
│           │ 孙小明  │         │ 新学员  │         │ 老学员  │   │
│           │ 马006   │         │ 马007   │         │ 马008   │   │
│ ──────────┼─────────┼─────────┼─────────┼─────────┼─────────┤   │
│  15:00    │         │ [空闲]  │         │ [维护]  │         │   │
│  -16:00   │         │         │         │ 马匹体检 │         │   │
│                                                                 │
│ 图例：🟢已确认 🟡待确认 🔴已取消 🔵进行中 ⚪空闲时段            │
└─────────────────────────────────────────────────────────────────┘
```

#### 日视图布局

```
┌─────────────────────────────────────────────────────────────────┐
│ 课程表 - 2024年8月14日 周三           [前一天] [今天] [后一天]    │
├─────────────────────────────────────────────────────────────────┤
│ 教练筛选: [全部▼] 马匹筛选: [全部▼] 状态: [全部▼]              │
├─────────────────────────────────────────────────────────────────┤
│ ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐     │
│ │  时间   │ 李教练  │ 王教练  │ 张教练  │ 马001   │ 马002   │     │
│ ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤     │
│ │09:00-10:00│🟢体验课 │         │         │ 占用    │         │     │
│ │         │李小红   │         │         │         │         │     │
│ │         │¥200     │         │         │         │         │     │
│ ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤     │
│ │10:00-11:00│         │🟡基础课 │         │         │ 占用    │     │
│ │         │         │王小明   │         │         │         │     │
│ │         │         │¥300     │         │         │         │     │
│ ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤     │
│ │14:00-15:00│🔵进行中 │         │🟢进阶课 │ 占用    │         │     │
│ │         │张小刚   │         │赵小华   │         │         │     │
│ │         │¥400     │         │¥500     │         │         │     │
│ └─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘     │
│                                                                 │
│ [快速添加课程] [批量操作] [导出课表] [打印课表]                  │
└─────────────────────────────────────────────────────────────────┘
```

#### 课程详情弹窗

```
┌─────────────────────────────────────────────────────────────────┐
│ 课程详情                                              [×关闭]   │
├─────────────────────────────────────────────────────────────────┤
│ 基本信息:                                                       │
│ 课程名称: 体验课                 状态: 🟢已确认                 │
│ 学员姓名: 李小红                 手机: 138****1234             │
│ 教练姓名: 李教练                 马匹: 001-白雪公主            │
│ 课程时间: 2024-08-14 09:00-10:00                               │
│ 课程费用: ¥200 (教练费¥150 + 马匹费¥50)                        │
│                                                                 │
│ 费用调整: (仅前台可操作)                                        │
│ 教练费: [150] 马匹费: [50] 调整原因: [____________]             │
│                                                                 │
│ 操作记录:                                                       │
│ • 2024-08-12 14:30 创建预约 (系统)                             │
│ • 2024-08-12 14:35 支付完成 (支付宝)                           │
│ • 2024-08-12 14:36 发送通知给教练 (系统)                       │
│ • 2024-08-14 06:00 课前提醒已发送 (系统)                       │
│                                                                 │
│ [编辑] [取消课程] [更换教练] [更换马匹] [到店签到] [完成课程]    │
└─────────────────────────────────────────────────────────────────┘
```

#### 需要新增的数据表结构

**时间段模板表 (m_time_slot_template)**
```sql
CREATE TABLE m_time_slot_template (
    id BIGINT AUTO_INCREMENT COMMENT '主键ID' PRIMARY KEY,
    club_id BIGINT NOT NULL COMMENT '俱乐部ID',
    slot_name VARCHAR(50) NOT NULL COMMENT '时段名称',
    start_time TIME NOT NULL COMMENT '开始时间',
    end_time TIME NOT NULL COMMENT '结束时间',
    week_days VARCHAR(20) NOT NULL COMMENT '适用星期 1,2,3,4,5,6,7',
    is_available TINYINT DEFAULT 1 COMMENT '是否可用: 1-可用 0-不可用',
    sort_order INT DEFAULT 0 COMMENT '排序',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP NOT NULL,
    is_delete INT DEFAULT 0 NOT NULL
) COMMENT '时间段模板表';
```

**教练可用时间表 (m_coach_availability)**
```sql
CREATE TABLE m_coach_availability (
    id BIGINT AUTO_INCREMENT COMMENT '主键ID' PRIMARY KEY,
    club_id BIGINT NOT NULL COMMENT '俱乐部ID',
    coach_id BIGINT NOT NULL COMMENT '教练ID',
    available_date DATE NOT NULL COMMENT '可用日期',
    start_time TIME NOT NULL COMMENT '开始时间',
    end_time TIME NOT NULL COMMENT '结束时间',
    status TINYINT DEFAULT 1 COMMENT '状态: 1-可用 2-请假 3-占用',
    remark VARCHAR(200) DEFAULT '' COMMENT '备注',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT uk_coach_date_time UNIQUE (coach_id, available_date, start_time)
) COMMENT '教练可用时间表';
```

**马匹可用时间表 (m_horse_availability)**
```sql
CREATE TABLE m_horse_availability (
    id BIGINT AUTO_INCREMENT COMMENT '主键ID' PRIMARY KEY,
    club_id BIGINT NOT NULL COMMENT '俱乐部ID',
    horse_id BIGINT NOT NULL COMMENT '马匹ID',
    available_date DATE NOT NULL COMMENT '可用日期',
    start_time TIME NOT NULL COMMENT '开始时间',
    end_time TIME NOT NULL COMMENT '结束时间',
    status TINYINT DEFAULT 1 COMMENT '状态: 1-可用 2-休息 3-治疗 4-占用',
    remark VARCHAR(200) DEFAULT '' COMMENT '备注',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT uk_horse_date_time UNIQUE (horse_id, available_date, start_time)
) COMMENT '马匹可用时间表';
```

#### 课程表页面功能特点

1. **多视图支持**
   - 日视图：详细显示单日所有时段安排
   - 周视图：显示一周的课程概览
   - 月视图：显示整月的课程分布

2. **实时状态显示**
   - 🟢已确认：已支付，等待上课
   - 🟡待确认：已预约，等待支付
   - 🔴已取消：课程已取消
   - 🔵进行中：正在上课
   - ⚪空闲时段：可预约时间

3. **快速操作功能**
   - 拖拽调整课程时间
   - 右键菜单快速操作
   - 批量操作选中课程
   - 冲突检测和提醒

4. **智能排课辅助**
   - 教练档期自动检查
   - 马匹可用性验证
   - 场地资源冲突检测
   - 最优时段推荐

5. **数据统计面板**
   - 课程完成率统计
   - 教练工作负荷分析
   - 马匹使用频率统计
   - 收入趋势分析

## 五、技术实现要点

### 1. 价格计算规则

- 基础单价使用MySQL计算字段自动维护
- 到店调整费用时创建价格调整记录
- 支持历史价格查询和对比

### 2. 库存管理

- 课时包：购买时扣减，退款时恢复
- 活动：报名时预占，支付完成时确认
- 实时库存通过数据库事务保证一致性

### 3. 定时任务

- 课前3小时提醒：每10分钟扫描一次即将开始的课程
- 课时包到期检查：每日检查并更新过期状态
- 订单超时取消：未支付订单30分钟后自动取消

### 4. 通知推送

- 微信公众号模板消息推送
- 短信提醒备用方案
- 站内消息系统集成

### 5. 课程表核心功能

- **冲突检测算法**：实时检查教练、马匹、场地的时间冲突
- **拖拽排课**：前端实现课程时间拖拽调整，后端验证可行性
- **智能推荐**：基于历史数据推荐最优排课时段
- **实时同步**：WebSocket实现多用户实时课表更新

### 6. 数据统计与分析

- **课程完成率**：基于预约状态统计分析
- **教练工作量**：按时间段统计教练课程数量和收入
- **马匹利用率**：统计马匹使用频率和健康状况关联
- **收入分析**：多维度收入统计和趋势分析

## 六、课程表页面开发建议

### 前端技术选型
- **日历组件**：使用 FullCalendar 或自定义日历组件
- **拖拽功能**：Vue.Draggable 或 React-DnD
- **实时更新**：WebSocket 连接实现多用户同步
- **状态管理**：Vuex/Pinia 或 Redux 管理课程状态

### 后端API设计
```javascript
// 获取课程表数据
GET /api/schedule?date=2024-08-14&view=week&coach_id=1

// 创建/更新课程
POST /api/schedule
PUT /api/schedule/{id}

// 批量操作
POST /api/schedule/batch
{
  action: 'cancel', // cancel, reschedule, assign_coach
  booking_ids: [1,2,3],
  params: {}
}

// 冲突检测
POST /api/schedule/conflict-check
{
  coach_id: 1,
  horse_id: 2,
  start_time: '2024-08-14 09:00:00',
  end_time: '2024-08-14 10:00:00'
}
```

### 性能优化
- **数据缓存**：Redis缓存常用课程表数据
- **分页加载**：按周/月分页加载课程数据
- **索引优化**：为时间查询添加复合索引
- **懒加载**：按需加载课程详情和操作历史

这个完整的设计方案现在包含了课程表页面的所有必要功能，可以满足马术俱乐部的日常运营管理需求。
