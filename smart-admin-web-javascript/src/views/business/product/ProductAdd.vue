<!--
  * ËØæÁ®ãÊñ∞Â¢û/ÁºñËæëÈ°µÈù¢
  *
  * @Author: 1024ÂàõÊñ∞ÂÆûÈ™åÂÆ§
  * @Date: 2024-08-16
  * @Copyright: 1024ÂàõÊñ∞ÂÆûÈ™åÂÆ§ (https://1024lab.net)
-->
<template>
  <a-card :bordered="false">
    <template #title>
      <a-space>
        <ArrowLeftOutlined @click="goBack" style="cursor: pointer;" />
        {{ isEdit ? 'ÁºñËæëËØæÁ®ã' : 'Êñ∞Â¢ûËØæÁ®ã' }}
      </a-space>
    </template>

    <template #extra>
      <a-space>
        <a-button @click="goBack">ÂèñÊ∂à</a-button>
        <a-button @click="resetForm">ÈáçÁΩÆ</a-button>
        <a-button type="primary" @click="onSubmit" :loading="submitLoading">
          {{ isEdit ? 'Êõ¥Êñ∞' : 'ÂàõÂª∫' }}
        </a-button>
      </a-space>
    </template>

    <a-form
      ref="formRef"
      :model="formData"
      :rules="formRules"
      :label-col="{ span: 4 }"
      :wrapper-col="{ span: 20 }"
      class="product-form"
    >
      <!-- Âü∫Á°Ä‰ø°ÊÅØ -->
      <a-card size="small" title="Âü∫Á°Ä‰ø°ÊÅØ" class="form-section">
        <!-- Á¨¨‰∏ÄË°åÔºöËØæÁ®ãÁ±ªÂûã + ËØæÁ®ãÂàÜÁ±ª -->
        <a-row :gutter="24" justify="center">
          <a-col :span="18" :md="16" :lg="14" :xl="12">
            <a-form-item label="ËØæÁ®ãÁ±ªÂûã" name="productType" :label-col="{ span: 8 }" :wrapper-col="{ span: 16 }">
              <a-radio-group v-model:value="formData.productType" @change="onProductTypeChange">
                <a-radio
                  v-for="item in Object.values(PRODUCT_MANAGEMENT_TYPE_ENUM)"
                  :key="item.value"
                  :value="item.value"
                >
                  {{ item.desc }}
                </a-radio>
              </a-radio-group>
            </a-form-item>
          </a-col>
        </a-row>

        <!-- Á¨¨‰∫åË°åÔºöËØæÁ®ãÂàÜÁ±ªÔºà‰ªÖÂΩìÈÄâÊã©ËØæÁ®ãÊó∂ÊòæÁ§∫Ôºâ -->
        <a-row :gutter="24" justify="center" v-if="formData.productType === 1">
          <a-col :span="18" :md="16" :lg="14" :xl="12">
            <a-form-item label="ËØæÁ®ãÂàÜÁ±ª" name="dynamicConfig.classType" :label-col="{ span: 8 }" :wrapper-col="{ span: 16 }">
              <a-radio-group v-model:value="formData.dynamicConfig.classType" @change="onClassTypeChange">
                <a-radio
                  v-for="item in Object.values(COURSE_CLASS_TYPE_ENUM)"
                  :key="item.value"
                  :value="item.value"
                >
                  {{ item.desc }}
                </a-radio>
              </a-radio-group>
            </a-form-item>
          </a-col>
        </a-row>

        <!-- Á¨¨‰∏âË°åÔºöËØæÁ®ãÂêçÁß∞ -->
        <a-row :gutter="24" justify="center">
          <a-col :span="18" :md="16" :lg="14" :xl="12">
            <a-form-item label="ËØæÁ®ãÂêçÁß∞" name="productName" :label-col="{ span: 8 }" :wrapper-col="{ span: 16 }">
              <a-input v-model:value="formData.productName" placeholder="ËØ∑ËæìÂÖ•ËØæÁ®ãÂêçÁß∞" />
            </a-form-item>
          </a-col>
        </a-row>

        <!-- Á¨¨ÂõõË°åÔºöÊéàËØæÊïôÁªÉÔºà‰ªÖËØæÁ®ãÁ±ªÂûãÊòæÁ§∫Ôºâ -->
        <a-row :gutter="24" justify="center" v-if="formData.productType === 1">
          <a-col :span="18" :md="16" :lg="14" :xl="12">
            <a-form-item label="ÊéàËØæÊïôÁªÉ" name="coachIds" :label-col="{ span: 8 }" :wrapper-col="{ span: 16 }">
              <CoachSelector
                v-model:value="formData.coachIds"
                :custom-params="{ showCoachFee: true }"
                mode="multiple"
                placeholder="ËØ∑ÈÄâÊã©ÂèØÊéàËØæÁöÑÊïôÁªÉÔºàÂèØÂ§öÈÄâÔºâ"
                :auto-load="true"
                style="width: 100%"
              />
            </a-form-item>
          </a-col>
        </a-row>
      </a-card>

      <!-- Âä®ÊÄÅË°®ÂçïÈÖçÁΩÆ -->
      <a-card size="small" :title="configSectionTitle" class="form-section" v-if="formData.productType">
        <!-- ‰ΩìÈ™åËØæÁâπÊÆäÂ∏ÉÂ±Ä -->
        <div v-if="isExperienceClass" class="experience-form-layout">
          <a-row :gutter="24" justify="center">
            <a-col :span="18" :md="16" :lg="14" :xl="12">
              <a-form-item label="ËØæÁ®ãÊó∂ÈïøÔºàÂàÜÈíüÔºâ" name="dynamicConfig.durationMinutes" :label-col="{ span: 8 }" :wrapper-col="{ span: 16 }">
                <a-input-number
                  v-model:value="formData.dynamicConfig.durationMinutes"
                  placeholder="ËØ∑ËæìÂÖ•ËØæÁ®ãÊó∂Èïø"
                  :min="30"
                  :max="300"
                  style="width: 100%"
                />
              </a-form-item>
            </a-col>
          </a-row>
          <a-row :gutter="24" justify="center">
            <a-col :span="18" :md="16" :lg="14" :xl="12">
              <a-form-item label="ÊúÄÂ§ß‰∫∫Êï∞" name="dynamicConfig.maxStudents" :label-col="{ span: 8 }" :wrapper-col="{ span: 16 }">
                <a-input-number
                  v-model:value="formData.dynamicConfig.maxStudents"
                  placeholder="ËØ∑ËæìÂÖ•ÊúÄÂ§ß‰∫∫Êï∞"
                  :min="1"
                  :max="10"
                  style="width: 100%"
                />
              </a-form-item>
            </a-col>
          </a-row>
          <a-row :gutter="24" justify="center">
            <a-col :span="18" :md="16" :lg="14" :xl="12">
              <a-form-item label="ËØæÊó∂Ë¥π" name="dynamicConfig.sessionFee" :label-col="{ span: 8 }" :wrapper-col="{ span: 16 }">
                <a-input-number
                  v-model:value="formData.dynamicConfig.sessionFee"
                  placeholder="ËØ∑ËæìÂÖ•ËØæÊó∂Ë¥π"
                  :min="0"
                  :max="9999"
                  style="width: 100%"
                  :formatter="value => `¬• ${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')"
                  :parser="value => value.replace(/¬•\s?|(,*)/g, '')"
                />
              </a-form-item>
            </a-col>
          </a-row>
        </div>

        <!-- Ê≠£Â∏∏ËØæÁ®ãÂíåËØæÊó∂ÂåÖÂ∏ÉÂ±Ä -->
        <div v-else class="normal-form-layout">
          <DynamicFormRenderer
            v-model:value="formData.dynamicConfig"
            :form-config="dynamicFormConfig"
            :loading="configLoading"
            :form-props="{ labelCol: { span: 6 }, wrapperCol: { span: 18 } }"
            @validate="onDynamicFormValidate"
            @change="onDynamicFormChange"
          />
        </div>
      </a-card>

      <!-- Â∞èÁªÑËØæÊïôÁªÉ‰ª∑Ê†ºÈÖçÁΩÆ -->
      <a-card 
        v-if="isGroupCourse" 
        size="small" 
        class="form-section coach-price-section"
      >
        <template #title>
          <span style="color: #1890ff; font-weight: 600;">
            üë• Â∞èÁªÑËØæÊïôÁªÉÂÆö‰ª∑ÈÖçÁΩÆ
          </span>
          <!-- ÈÖçÁΩÆÁä∂ÊÄÅÊåáÁ§∫Âô® -->
          <a-tag 
            v-if="coachConfigSummary.hasIssues"
            color="warning" 
            size="small"
            style="margin-left: 8px;"
          >
            {{ coachConfigSummary.valid }}/{{ coachConfigSummary.total }} ÊïôÁªÉÂèØÈÖçÁΩÆ
          </a-tag>
        </template>
        
        <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
        <div v-if="coachDetailsLoading" class="loading-state" style="text-align: center; padding: 40px;">
          <a-spin size="large">
            <template #tip>Ê≠£Âú®Ëé∑ÂèñÊïôÁªÉ‰ø°ÊÅØ...</template>
          </a-spin>
        </div>
        
        <!-- ÈÖçÁΩÆÁªÑ‰ª∂ -->
        <CoachPriceConfig
          v-else
          v-model="formData.coachPriceList"
          :selected-coaches="selectedCoachesWithFee"
          :participant-counts="[2, 3, 4, 5, 6]"
          :coach-config-summary="coachConfigSummary"
        />
      </a-card>

    </a-form>
  </a-card>
</template>

<script setup>
import { ref, reactive, onMounted, computed, watch, nextTick } from 'vue';
import { useRouter, useRoute } from 'vue-router';
import { message, Modal } from 'ant-design-vue';
import { ArrowLeftOutlined } from '@ant-design/icons-vue';
import { productApi } from '/@/api/business/product/product-api';
import { coachApi } from '/@/api/business/coach/coach-api';
import {
  PRODUCT_MANAGEMENT_TYPE_ENUM,
  PRODUCT_FORM_RULES,
  PRODUCT_DEFAULT_CONFIG,
  COURSE_CLASS_TYPE_ENUM
} from '/@/constants/business/product/product-const';
import DynamicFormRenderer from './components/DynamicFormRenderer.vue';
import CoachPriceConfig from '/@/components/business/coach/CoachPriceConfig.vue';
import { CoachSelector } from '/@/components/business/selector';

const router = useRouter();
const route = useRoute();

// ======================== ÂìçÂ∫îÂºèÊï∞ÊçÆ ========================
const formRef = ref();
const submitLoading = ref(false);
const configLoading = ref(false);
const dynamicFormConfig = ref([]);
const dynamicFormValid = ref(false);
const needsDetailedConfig = ref(false);
const baseFormConfig = ref(null);
const currentClassType = ref(null);

// ÊïôÁªÉËØ¶ÊÉÖÁÆ°ÁêÜ
const selectedCoachDetails = ref([]);
const coachDetailsLoading = ref(false);
const failedCoachIds = ref([]);

const formData = reactive({
  // ‰∏ªË°®Â≠óÊÆµ m_product
  productId: null,
  productName: '',
  productCode: '',
  productType: null,
  subType: '',

  // ÊïôÁªÉÁªëÂÆöÂ≠óÊÆµ
  coachIds: [],
  
  // ÊïôÁªÉ‰ª∑Ê†ºÈÖçÁΩÆÔºàÂ∞èÁªÑËØæ‰∏ìÁî®Ôºâ
  coachPriceList: [],

  // Âä®ÊÄÅÈÖçÁΩÆÂ≠óÊÆµ - ‰∏•Ê†ºÊåâÁÖßÊï∞ÊçÆÂ∫ìË°®ÁªìÊûÑ
  dynamicConfig: {
    // ËØæÁ®ãÂ≠óÊÆµ m_product_course (productType=1)
    classType: null,
    durationMinutes: null,
    durationPeriods: null,
    maxStudents: null,
    coachFee: null,
    horseFee: null,
    multiPriceConfig: null,

    // ËØæÊó∂ÂåÖÂ≠óÊÆµ m_product_package (productType=2)
    details: '',
    price: null,
    totalSessions: null,
    validityDays: null,
    stockQuantity: null,

    // Ê¥ªÂä®Â≠óÊÆµ m_product_activity (productType=3)
    activityName: '',
    activityDetails: '',
    startTime: null,
    endTime: null,
    activityLocation: '',
    price: null,
    maxParticipants: null,
    refundRule: '',
    detailImages: []
  }
});

const formRules = { 
  ...PRODUCT_FORM_RULES,
  coachIds: [
    { 
      validator: (rule, value) => {
        if (isGroupCourse.value && (!value || value.length === 0)) {
          return Promise.reject('Â∞èÁªÑËØæÂøÖÈ°ªÈÄâÊã©ÊéàËØæÊïôÁªÉ');
        }
        return Promise.resolve();
      },
      trigger: 'change'
    }
  ],
  coachPriceList: [
    {
      validator: (rule, value) => {
        if (isGroupCourse.value && (!value || value.length === 0)) {
          return Promise.reject('Â∞èÁªÑËØæÂøÖÈ°ªÈÖçÁΩÆÊïôÁªÉ‰ª∑Ê†º');
        }
        return Promise.resolve();
      },
      trigger: 'change'
    }
  ]
};

// ======================== ËÆ°ÁÆóÂ±ûÊÄß ========================
const isEdit = computed(() => {
  return route.params.id && route.params.id !== 'add';
});

const configSectionTitle = computed(() => {
  switch (formData.productType) {
    case 1:
      return 'ËØæÁ®ãÈÖçÁΩÆ';
    case 2:
      return 'ËØæÊó∂ÂåÖÈÖçÁΩÆ';
    default:
      return 'ÂïÜÂìÅÈÖçÁΩÆ';
  }
});

// Ê£ÄÊµãÊòØÂê¶‰∏∫‰ΩìÈ™åËØæ
const isExperienceClass = computed(() => {
  return formData.productType === 1 && formData.productName && formData.productName.includes('‰ΩìÈ™åËØæ');
});

// Ê£ÄÊµãÊòØÂê¶‰∏∫Â∞èÁªÑËØæ
const isGroupCourse = computed(() => {
  return formData.productType === 1 && formData.dynamicConfig.classType === 2;
});

// Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÊïôÁªÉÂèäÂÖ∂Ë¥πÁî®‰ø°ÊÅØÔºà‰∏•Ê†ºÁâàÊú¨ - Âè™ËøîÂõûÊàêÂäüËé∑ÂèñËØ¶ÊÉÖÁöÑÊïôÁªÉÔºâ
const selectedCoachesWithFee = computed(() => {
  // Â¢ûÂº∫ÁöÑÈ™åËØÅÈÄªËæëÔºåÊ∑ªÂä†ËØ¶ÁªÜÊó•Âøó
  const validCoaches = selectedCoachDetails.value.filter(coach => {
    const hasValidId = coach.coachId && coach.coachId > 0;
    const hasValidName = coach.coachName && coach.coachName.trim().length > 0;
    const hasValidFee = coach.coachFee !== null && 
                        coach.coachFee !== undefined && 
                        coach.coachFee >= 0;
    
    console.log('ÊïôÁªÉÈ™åËØÅ:', {
      coachId: coach.coachId,
      coachName: coach.coachName,
      coachFee: coach.coachFee,
      hasValidId,
      hasValidName,
      hasValidFee,
      valid: hasValidId && hasValidName && hasValidFee
    });
    
    return hasValidId && hasValidName && hasValidFee;
  });
  
  console.log('ÂéüÂßãÊïôÁªÉÊï∞ÊçÆ:', selectedCoachDetails.value);
  console.log('ËøáÊª§ÂêéÊúâÊïàÊïôÁªÉÊï∞ÊçÆ:', validCoaches);
  
  return validCoaches;
});

// Ê£ÄÊü•ÊòØÂê¶ÊúâÊïôÁªÉÈÖçÁΩÆ‰∏çÂÆåÊï¥
const hasIncompleteCoachData = computed(() => {
  const selectedCount = formData.coachIds?.length || 0;
  const validCount = selectedCoachesWithFee.value.length;
  return selectedCount > validCount;
});

// Ëé∑ÂèñÈÖçÁΩÆÁä∂ÊÄÅÊëòË¶Å
const coachConfigSummary = computed(() => {
  const total = formData.coachIds?.length || 0;
  const valid = selectedCoachesWithFee.value.length;
  const failed = failedCoachIds.value.length;
  
  return {
    total,
    valid,
    failed,
    hasIssues: failed > 0
  };
});

// ======================== ÂàùÂßãÂåñ ========================
onMounted(() => {
  if (isEdit.value) {
    loadProductDetail();
  }
});

// ======================== ÁõëÂê¨Âô® ========================

// ÁõëÂê¨ÊïôÁªÉIDÂèòÂåñÔºåÂä†ËΩΩÊïôÁªÉËØ¶ÊÉÖ
watch(() => formData.coachIds, (newIds, oldIds) => {
  if (JSON.stringify(newIds) !== JSON.stringify(oldIds)) {
    console.log('ÊïôÁªÉÈÄâÊã©ÂèòÂåñ:', { oldIds, newIds });
    loadCoachDetails(newIds);
  }
}, { immediate: true });

// ÁßªÈô§productTypeÁöÑwatchÁõëÂê¨Âô®ÔºåÈÅøÂÖç‰∏éonProductTypeChangeÈáçÂ§çË∞ÉÁî®
// watch(() => formData.productType, (newType) => {
//   if (newType) {
//     loadFormConfig(newType);
//   }
// });

// ÁõëÂê¨ËØæÁ®ãÂàÜÁ±ªÂèòÂåñÔºåÁÆÄÂåñÊù°‰ª∂Á°Æ‰øùÈ¶ñÊ¨°ÈÄâÊã©‰πüËÉΩËß¶Âèë
watch(() => formData.dynamicConfig.classType, (newClassType, oldClassType) => {
  // ËØæÁ®ãÁ±ªÂûã‰∏ãÔºåÂΩìclassTypeÂèëÁîüÂèòÂåñÊó∂ÈáçÊñ∞Âä†ËΩΩÈÖçÁΩÆÔºàÁßªÈô§Ëøá‰∫é‰∏•Ê†ºÁöÑÊù°‰ª∂Ôºâ
  if (formData.productType === 1 && newClassType && newClassType !== oldClassType) {
    console.log('ËØæÁ®ãÂàÜÁ±ªÂàáÊç¢:', { oldClassType, newClassType });
    // ËØæÁ®ãÁ±ªÂûãÂÜÖÈÉ®ÂàÜÁ±ªÂàáÊç¢ÔºåÈáçÊñ∞Âä†ËΩΩËØ¶ÁªÜÈÖçÁΩÆ
    loadDetailedFormConfig(formData.productType, newClassType);
  }
});

// ÁõëÂê¨ËØæÁ®ãÂêçÁß∞ÂèòÂåñÔºåÊ£ÄÊµã‰ΩìÈ™åËØæÂπ∂Âä®ÊÄÅË∞ÉÊï¥Êó∂Èó¥Â≠óÊÆµ
watch(() => formData.productName, (newName, oldName) => {
  if (formData.productType === 1 && newName !== oldName) {
    // Ê£ÄÊµãÊòØÂê¶‰∏∫‰ΩìÈ™åËØæ
    const isExperienceClass = newName && newName.includes('‰ΩìÈ™åËØæ');
    const wasExperienceClass = oldName && oldName.includes('‰ΩìÈ™åËØæ');

    // Âè™ÊúâÂú®‰ΩìÈ™åËØæÁä∂ÊÄÅÁúüÊ≠£ÂèëÁîüÂèòÂåñÔºå‰∏î‰∏çÊòØÂú®ÈÖçÁΩÆÂä†ËΩΩËøáÁ®ã‰∏≠Êó∂ÊâçÈáçÊñ∞Âä†ËΩΩ
    if (isExperienceClass !== wasExperienceClass && !configLoading.value) {
      // ‰ΩìÈ™åËØæÁä∂ÊÄÅÂèëÁîüÂèòÂåñÔºåËøõË°åÊï∞ÊçÆËΩ¨Êç¢ÂíåÈáçÊñ∞Âä†ËΩΩÈÖçÁΩÆ
      handleTimeFieldConversion(isExperienceClass, wasExperienceClass);
      loadFormConfigWithExperienceDetection();
      // Ê∏ÖÈô§ËØæÁ®ãÂàÜÁ±ªÂ≠óÊÆµÁöÑÈ™åËØÅÁä∂ÊÄÅÔºåÂõ†‰∏∫‰ΩìÈ™åËØæ‰ºöËá™Âä®ËÆæÁΩÆclassType
      nextTick(() => {
        formRef.value?.clearValidate('dynamicConfig.classType');
      });
    }
  }
});

// ======================== ÊñπÊ≥ï ========================

/**
 * Âä†ËΩΩÊïôÁªÉËØ¶ÊÉÖÔºà‰∏•Ê†ºÁâàÊú¨ - Êó†ÈªòËÆ§Êï∞ÊçÆÔºâ
 */
async function loadCoachDetails(coachIds) {
  if (!coachIds || coachIds.length === 0) {
    selectedCoachDetails.value = [];
    failedCoachIds.value = [];
    return;
  }
  
  try {
    coachDetailsLoading.value = true;
    failedCoachIds.value = [];
    
    console.log('ÂºÄÂßãËé∑ÂèñÊïôÁªÉËØ¶ÊÉÖ:', coachIds);
    
    // ÊâπÈáèÊü•ËØ¢ÊïôÁªÉËØ¶ÊÉÖ
    const detailPromises = coachIds.map(async (coachId) => {
      try {
        const response = await coachApi.detail(coachId);
        if (response.ok && response.data) {
          return {
            success: true,
            coachId,
            data: response.data
          };
        } else {
          return {
            success: false,
            coachId,
            error: response.msg || 'Ëé∑ÂèñÊïôÁªÉËØ¶ÊÉÖÂ§±Ë¥•'
          };
        }
      } catch (error) {
        return {
          success: false,
          coachId,
          error: error.message || 'ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•'
        };
      }
    });
    
    const responses = await Promise.all(detailPromises);
    
    console.log('ÊâÄÊúâAPIÂìçÂ∫î:', responses);
    
    // ÂàÜÁ¶ªÊàêÂäüÂíåÂ§±Ë¥•ÁöÑÁªìÊûú
    const successResponses = responses.filter(res => res.success);
    const failedResponses = responses.filter(res => !res.success);
    
    console.log('ÊàêÂäüÂìçÂ∫îÊï∞ÊçÆ:', successResponses.map(res => res.data));
    console.log('Â§±Ë¥•ÂìçÂ∫î:', failedResponses);
    
    // Êõ¥Êñ∞ÊàêÂäüÁöÑÊïôÁªÉËØ¶ÊÉÖ
    selectedCoachDetails.value = successResponses.map(res => ({
      coachId: res.data.coachId,
      coachName: res.data.userName,          // ‚úÖ ‰ΩøÁî®Ê≠£Á°ÆÁöÑÂ≠óÊÆµÂêç
      actualName: res.data.userName,         // ‚úÖ ‰ΩøÁî®Ê≠£Á°ÆÁöÑÂ≠óÊÆµÂêç
      coachFee: res.data.coachFee,           // ‚úÖ Â∑≤ÁªèÊ≠£Á°Æ
      avatar: res.data.avatarUrl,            // ‚úÖ ‰ΩøÁî®Ê≠£Á°ÆÁöÑÂ≠óÊÆµÂêç
      level: res.data.coachStarLevel,        // ‚úÖ ÊïôÁªÉÊòüÁ∫ß
      specialties: res.data.specialties,     // ‚úÖ Â∑≤ÁªèÊ≠£Á°Æ
      coachNo: res.data.coachNo              // ‚úÖ ÊïôÁªÉÁºñÂè∑ÔºàÈ¢ùÂ§ñ‰ø°ÊÅØÔºâ
    }));
    
    console.log('Êò†Â∞ÑÂêéÁöÑÊïôÁªÉËØ¶ÊÉÖ:', selectedCoachDetails.value);
    
    // ËÆ∞ÂΩïÂ§±Ë¥•ÁöÑÊïôÁªÉID
    failedCoachIds.value = failedResponses.map(res => res.coachId);
    
    // ÈîôËØØÊèêÁ§∫
    if (failedResponses.length > 0) {
      const failedNames = failedResponses.map(res => `ÊïôÁªÉ${res.coachId}`).join('„ÄÅ');
      message.warning(`Êó†Ê≥ïËé∑Âèñ${failedNames}ÁöÑËØ¶ÁªÜ‰ø°ÊÅØÔºåËøô‰∫õÊïôÁªÉÂ∞Ü‰∏çÊòæÁ§∫ÈÖçÁΩÆÈÄâÈ°π`);
      console.warn('ÊïôÁªÉËØ¶ÊÉÖËé∑ÂèñÂ§±Ë¥•:', failedResponses);
    }
    
    console.log('ÊïôÁªÉËØ¶ÊÉÖÂä†ËΩΩÂÆåÊàê:', {
      ÊàêÂäü: selectedCoachDetails.value.length,
      Â§±Ë¥•: failedCoachIds.value.length,
      ËØ¶ÊÉÖ: selectedCoachDetails.value
    });
    
  } catch (error) {
    console.error('ÊâπÈáèËé∑ÂèñÊïôÁªÉËØ¶ÊÉÖÂ§±Ë¥•:', error);
    message.error('Ëé∑ÂèñÊïôÁªÉ‰ø°ÊÅØÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
    selectedCoachDetails.value = [];
    failedCoachIds.value = [...coachIds];
  } finally {
    coachDetailsLoading.value = false;
  }
}

async function loadProductDetail() {
  try {
    const response = await productApi.getProductDetail(route.params.id);
    if (response.ok) {
      const product = response.data;

      // Ê£ÄÊü•ÊòØÂê¶‰∏∫Ê¥ªÂä®Á±ªÂûã‰∫ßÂìÅ
      if (product.productType === 3) {
        Modal.info({
          title: 'Ê¥ªÂä®Á±ªÂûã‰∫ßÂìÅ',
          content: 'Ê≠§‰∫ßÂìÅ‰∏∫Ê¥ªÂä®Á±ªÂûãÔºåËØ∑ÂâçÂæÄÊ¥ªÂä®ÁÆ°ÁêÜÈ°µÈù¢ËøõË°åÁºñËæë„ÄÇ‰∫ßÂìÅÁÆ°ÁêÜÈ°µÈù¢‰ªÖÊîØÊåÅËØæÁ®ãÂíåËØæÊó∂ÂåÖÁöÑÁÆ°ÁêÜ„ÄÇ',
          okText: 'Áü•ÈÅì‰∫Ü',
          onOk: () => {
            goBack();
          }
        });
        return;
      }

      // ÂÖàËÆæÁΩÆÂü∫Á°Ä‰ø°ÊÅØÔºà‰∏çÂåÖÊã¨dynamicConfigÂíåproductTypeÔºâ
      Object.assign(formData, {
        productId: product.productId,
        productName: product.productName,
        productCode: product.productCode
      });

      // ÊûÑÂª∫dynamicConfigÊï∞ÊçÆ
      let dynamicConfig = {};

      // Ê†πÊçÆÂïÜÂìÅÁ±ªÂûãËé∑ÂèñÂØπÂ∫îÁöÑËØ¶ÊÉÖÈÖçÁΩÆ
      if (product.productType === 1 && product.courseDetails && Object.keys(product.courseDetails).length > 0) {
        // ËØæÁ®ãÁ±ªÂûãÔºö‰ªécourseDetailsËé∑ÂèñÊï∞ÊçÆ
        dynamicConfig = {
          classType: product.courseDetails.classType,
          durationMinutes: product.courseDetails.durationMinutes,
          durationPeriods: product.courseDetails.durationPeriods,
          maxStudents: product.courseDetails.maxStudents,
          coachFee: product.courseDetails.coachFee,
          horseFee: product.courseDetails.horseFee,
          multiPriceConfig: product.courseDetails.multiPriceConfig
        };
      } else if (product.productType === 2 && product.packageDetails && Object.keys(product.packageDetails).length > 0) {
        // ËØæÊó∂ÂåÖÁ±ªÂûãÔºö‰ªépackageDetailsËé∑ÂèñÊï∞ÊçÆ
        dynamicConfig = {
          details: product.packageDetails.details,
          price: product.packageDetails.price,
          totalSessions: product.packageDetails.totalSessions,
          validityDays: product.packageDetails.validityDays,
          stockQuantity: product.packageDetails.stockQuantity
        };
      } else {
        // Â¶ÇÊûúÊ≤°ÊúâËØ¶ÊÉÖÊï∞ÊçÆÔºåÂ∞ùËØï‰ªéÊóßÁöÑdynamicConfigÂ≠óÊÆµËé∑Âèñ
        try {
          if (product.dynamicConfig) {
            if (typeof product.dynamicConfig === 'string') {
              dynamicConfig = JSON.parse(product.dynamicConfig);
            } else {
              dynamicConfig = product.dynamicConfig;
            }

            // Â¶ÇÊûúdynamicConfig‰∏≠ÊúâdetailImagesÔºå‰πüÈúÄË¶ÅËß£Êûê
            if (dynamicConfig.detailImages && typeof dynamicConfig.detailImages === 'string') {
              try {
                const parsed = JSON.parse(dynamicConfig.detailImages);
                if (Array.isArray(parsed)) {
                  dynamicConfig.detailImages = parsed;
                }
              } catch (error) {
                console.warn('Ëß£ÊûêdynamicConfig‰∏≠ÁöÑdetailImagesÂ§±Ë¥•:', error);
                dynamicConfig.detailImages = [];
              }
            }
          }
        } catch (e) {
          console.warn('Ëß£ÊûêdynamicConfigÂ§±Ë¥•:', e);
          dynamicConfig = {};
        }

        // ‰∏¥Êó∂Â§ÑÁêÜÔºö‰∏∫Ê≤°ÊúâËØæÁ®ãÈÖçÁΩÆÁöÑÁé∞ÊúâËØæÁ®ãÂïÜÂìÅÊèê‰æõÈªòËÆ§ÂÄº
        if (product.productType === 1 && Object.keys(dynamicConfig).length === 0) {
          console.log('‰∏∫ËØæÁ®ãÂïÜÂìÅËÆæÁΩÆÈªòËÆ§ÈÖçÁΩÆ');
          dynamicConfig = {
            classType: 1, // ÈªòËÆ§Âçï‰∫∫ËØæ
            durationMinutes: 60, // ÈªòËÆ§60ÂàÜÈíü
            durationPeriods: 1.0, // ÈªòËÆ§1ÈûçÊó∂
            maxStudents: 1, // ÈªòËÆ§ÊúÄÂ§ß1‰∫∫
            coachFee: 200, // ÈªòËÆ§ÊïôÁªÉË¥π200
            horseFee: 100, // ÈªòËÆ§È©¨ÂåπË¥π100
            multiPriceConfig: null
          };
        }
      }

      console.log('ÂïÜÂìÅËØ¶ÊÉÖÂä†ËΩΩÊàêÂäü:', product);
      console.log('Ëß£ÊûêÁöÑÂä®ÊÄÅÈÖçÁΩÆÊï∞ÊçÆ:', dynamicConfig);
      console.log('ËØ¶ÊÉÖÂõæÁâáÊï∞ÊçÆÁ±ªÂûã:', typeof dynamicConfig.detailImages);
      console.log('ËØ¶ÊÉÖÂõæÁâáÊï∞ÊçÆÂÜÖÂÆπ:', dynamicConfig.detailImages);

      // ÂÖàÂä†ËΩΩË°®ÂçïÈÖçÁΩÆÔºåÂÜçËÆæÁΩÆÊï∞ÊçÆ
      if (product.productType) {
        await loadFormConfig(product.productType);

        // ÈÖçÁΩÆÂä†ËΩΩÂÆåÊàêÂêéÔºåËÆæÁΩÆproductTypeÂíådynamicConfig
        formData.productType = product.productType;
        formData.dynamicConfig = dynamicConfig;

        // Â¶ÇÊûúÊòØËØæÁ®ãÁ±ªÂûãÔºåÂä†ËΩΩÂÖ≥ËÅîÁöÑÊïôÁªÉÊï∞ÊçÆ
        if (product.productType === 1) {
          await loadProductCoaches(product.productId);
        }

        console.log('ÊúÄÁªàËÆæÁΩÆÁöÑdynamicConfig:', formData.dynamicConfig);
      }

    } else {
      message.error(response.msg || 'Âä†ËΩΩÂïÜÂìÅËØ¶ÊÉÖÂ§±Ë¥•');
      goBack();
    }
  } catch (error) {
    message.error('Âä†ËΩΩÂïÜÂìÅËØ¶ÊÉÖÂ§±Ë¥•');
    console.error('Âä†ËΩΩÂïÜÂìÅËØ¶ÊÉÖÂ§±Ë¥•:', error);
    goBack();
  }
}

/**
 * Âä†ËΩΩ‰∫ßÂìÅÂÖ≥ËÅîÁöÑÊïôÁªÉÊï∞ÊçÆÔºàÂ¢ûÂº∫ÁâàÊú¨Ôºâ
 */
async function loadProductCoaches(productId) {
  try {
    const response = await productApi.getProductCoaches(productId);
    if (response.ok && response.data) {
      // ÊèêÂèñÊïôÁªÉIDÊï∞ÁªÑ
      const coachIds = response.data.map(coach => coach.coachId);
      formData.coachIds = coachIds;
      console.log('Âä†ËΩΩÁöÑÊïôÁªÉÊï∞ÊçÆ:', response.data);
      console.log('ËÆæÁΩÆÁöÑÊïôÁªÉIDÊï∞ÁªÑ:', coachIds);
      
      // ÁºñËæëÊ®°Âºè‰∏ãÁ´ãÂç≥Âä†ËΩΩÊïôÁªÉËØ¶ÊÉÖ
      if (coachIds.length > 0) {
        await loadCoachDetails(coachIds);
        console.log('ÁºñËæëÊ®°ÂºèÊïôÁªÉËØ¶ÊÉÖÂä†ËΩΩÂÆåÊàê');
      }
    }
  } catch (error) {
    console.warn('Âä†ËΩΩÊïôÁªÉÊï∞ÊçÆÂ§±Ë¥•:', error);
    // ‰∏çÈòªÂ°ûÈ°µÈù¢Âä†ËΩΩÔºåÂè™ËÆ∞ÂΩïË≠¶Âëä
  }
}

async function loadFormConfig(productType) {
  try {
    configLoading.value = true;
    const response = await productApi.getFormConfig(productType);
    if (response.ok) {
      // ‰ªéAPIÂìçÂ∫î‰∏≠ÊèêÂèñfieldsÊï∞ÁªÑÁªôDynamicFormRenderer‰ΩøÁî®
      dynamicFormConfig.value = response.data?.fields || [];

      // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊ†πÊçÆclassTypeËé∑ÂèñËØ¶ÁªÜÈÖçÁΩÆ
      if (response.data?.needsDetailedConfig) {
        needsDetailedConfig.value = true;
        baseFormConfig.value = response.data;
        // Â¶ÇÊûúÂ∑≤ÁªèÊúâclassTypeÂÄºÔºåÁ´ãÂç≥Âä†ËΩΩËØ¶ÁªÜÈÖçÁΩÆ
        if (formData.dynamicConfig.classType) {
          await loadDetailedFormConfig(productType, formData.dynamicConfig.classType);
        }
      } else {
        needsDetailedConfig.value = false;
        baseFormConfig.value = null;
      }

      // Âè™Âú®Êñ∞Â¢ûÊ®°Âºè‰∏ãÈáçÁΩÆÂä®ÊÄÅÈÖçÁΩÆÔºåÁºñËæëÊ®°Âºè‰∏ã‰øùÊåÅÊï∞ÊçÆ
      if (!isEdit.value) {
        formData.dynamicConfig = {};
      }

      console.log('Ë°®ÂçïÈÖçÁΩÆÂä†ËΩΩÂÆåÊàê:', {
        needsDetailedConfig: needsDetailedConfig.value,
        fields: dynamicFormConfig.value,
        currentDynamicConfig: formData.dynamicConfig
      });
    } else {
      message.error(response.msg || 'Âä†ËΩΩË°®ÂçïÈÖçÁΩÆÂ§±Ë¥•');
    }
  } catch (error) {
    message.error('Âä†ËΩΩË°®ÂçïÈÖçÁΩÆÂ§±Ë¥•');
    console.error('Âä†ËΩΩË°®ÂçïÈÖçÁΩÆÂ§±Ë¥•:', error);
  } finally {
    configLoading.value = false;
  }
}

async function loadDetailedFormConfig(productType, classType) {
  try {
    configLoading.value = true;
    const response = await productApi.getDetailedFormConfig(productType, classType);
    if (response.ok) {
      // ‰ªéAPIÂìçÂ∫î‰∏≠ÊèêÂèñfieldsÊï∞ÁªÑÁªôDynamicFormRenderer‰ΩøÁî®
      dynamicFormConfig.value = response.data?.fields || [];
      currentClassType.value = classType;
    } else {
      message.error(response.msg || 'Âä†ËΩΩËØ¶ÁªÜË°®ÂçïÈÖçÁΩÆÂ§±Ë¥•');
    }
  } catch (error) {
    message.error('Âä†ËΩΩËØ¶ÁªÜË°®ÂçïÈÖçÁΩÆÂ§±Ë¥•');
    console.error('Âä†ËΩΩËØ¶ÁªÜË°®ÂçïÈÖçÁΩÆÂ§±Ë¥•:', error);
  } finally {
    configLoading.value = false;
  }
}

// Â∏¶‰ΩìÈ™åËØæÊ£ÄÊµãÁöÑÂä®ÊÄÅÂä†ËΩΩË°®ÂçïÈÖçÁΩÆ
async function loadFormConfigWithExperienceDetection() {
  try {
    configLoading.value = true;

    // Ê£ÄÊµãÊòØÂê¶‰∏∫‰ΩìÈ™åËØæ
    const isExperience = isExperienceClass.value;

    console.log('Âä®ÊÄÅÂä†ËΩΩË°®ÂçïÈÖçÁΩÆ:', {
      productName: formData.productName,
      isExperience: isExperience,
      productType: formData.productType,
      classType: formData.dynamicConfig.classType
    });

    if (isExperience) {
      // ‰ΩìÈ™åËØæÔºöÁîüÊàê‰ª•ÂàÜÈíü‰∏∫Âçï‰ΩçÁöÑË°®ÂçïÈÖçÁΩÆ
      await loadExperienceClassFormConfig();
    } else {
      // Ê≠£Â∏∏ËØæÁ®ãÔºöÊåâÁÖßÊ≠£Â∏∏ÊµÅÁ®ãÂä†ËΩΩ
      if (formData.dynamicConfig.classType) {
        await loadDetailedFormConfig(formData.productType, formData.dynamicConfig.classType);
      } else {
        await loadFormConfig(formData.productType);
      }
    }

  } catch (error) {
    message.error('Âä†ËΩΩÂä®ÊÄÅË°®ÂçïÈÖçÁΩÆÂ§±Ë¥•');
    console.error('Âä†ËΩΩÂä®ÊÄÅË°®ÂçïÈÖçÁΩÆÂ§±Ë¥•:', error);
  } finally {
    configLoading.value = false;
  }
}

// Âä†ËΩΩ‰ΩìÈ™åËØæË°®ÂçïÈÖçÁΩÆ
async function loadExperienceClassFormConfig() {
  // Áõ¥Êé•Âú®ÂâçÁ´ØÁîüÊàê‰ΩìÈ™åËØæÈÖçÁΩÆÔºå‰ª•ÂàÜÈíü‰∏∫Âçï‰Ωç
  const experienceFields = [
    {
      key: 'durationMinutes',
      label: 'ËØæÁ®ãÊó∂ÈïøÔºàÂàÜÈíüÔºâ',
      type: 'number',
      required: true,
      min: 30,
      max: 300,
      defaultValue: 60,
      placeholder: 'ËØ∑ËæìÂÖ•ËØæÁ®ãÊó∂ÈïøÔºåÂçï‰ΩçÔºöÂàÜÈíü'
    },
    {
      key: 'maxStudents',
      label: 'ÊúÄÂ§ß‰∫∫Êï∞',
      type: 'number',
      required: true,
      min: 1,
      max: 10,
      defaultValue: 1
    },
    {
      key: 'sessionFee',
      label: 'ËØæÊó∂Ë¥π',
      type: 'number',
      required: true,
      min: 0,
      max: 9999,
      defaultValue: 300
    }
  ];

  dynamicFormConfig.value = experienceFields;
  needsDetailedConfig.value = false;

  console.log('‰ΩìÈ™åËØæÈÖçÁΩÆÂä†ËΩΩÂÆåÊàê:', experienceFields);
}

// Â§ÑÁêÜÊó∂Èó¥Â≠óÊÆµËΩ¨Êç¢ÔºàÈûçÊó∂ <-> ÂàÜÈíüÔºâ
function handleTimeFieldConversion(isExperienceClass, wasExperienceClass) {
  const currentConfig = formData.dynamicConfig;

  if (isExperienceClass && !wasExperienceClass) {
    // ‰ªéÊ≠£Â∏∏ËØæÁ®ãËΩ¨‰∏∫‰ΩìÈ™åËØæÔºöÈûçÊó∂ -> ÂàÜÈíü
    if (currentConfig.durationPeriods) {
      // 1ÈûçÊó∂ ‚âà 60ÂàÜÈíü
      const minutes = Math.round(currentConfig.durationPeriods * 60);
      currentConfig.durationMinutes = minutes;
      currentConfig.durationPeriods = null; // Ê∏ÖÁ©∫ÈûçÊó∂Â≠óÊÆµ

      console.log(`Êó∂Èó¥Â≠óÊÆµËΩ¨Êç¢: ${currentConfig.durationPeriods}ÈûçÊó∂ -> ${minutes}ÂàÜÈíü`);
    }

    // ‰ΩìÈ™åËØæ‰øùÊåÅÂçï‰∫∫ËØæÂàÜÁ±ªÔºà‰ΩìÈ™åËØæÊú¨Ë¥®‰∏ä‰πüÊòØÂçï‰∫∫ËØæÁöÑ‰∏ÄÁßçÔºâ
    currentConfig.classType = currentConfig.classType || 1;

  } else if (!isExperienceClass && wasExperienceClass) {
    // ‰ªé‰ΩìÈ™åËØæËΩ¨‰∏∫Ê≠£Â∏∏ËØæÁ®ãÔºöÂàÜÈíü -> ÈûçÊó∂
    if (currentConfig.durationMinutes) {
      // 60ÂàÜÈíü ‚âà 1ÈûçÊó∂
      const periods = Math.round((currentConfig.durationMinutes / 60) * 2) / 2; // ÂõõËàç‰∫îÂÖ•Âà∞0.5ÁöÑÂÄçÊï∞
      currentConfig.durationPeriods = Math.max(0.5, Math.min(5.0, periods)); // ÈôêÂà∂Âú®ÂêàÁêÜËåÉÂõ¥ÂÜÖ
      currentConfig.durationMinutes = null; // Ê∏ÖÁ©∫ÂàÜÈíüÂ≠óÊÆµ

      console.log(`Êó∂Èó¥Â≠óÊÆµËΩ¨Êç¢: ${currentConfig.durationMinutes}ÂàÜÈíü -> ${currentConfig.durationPeriods}ÈûçÊó∂`);
    }

    // Ê≠£Â∏∏ËØæÁ®ãÈúÄË¶ÅËØæÁ®ãÂàÜÁ±ªÔºåÈªòËÆ§‰∏∫Âçï‰∫∫ËØæ
    currentConfig.classType = currentConfig.classType || 1;
  }
}

function onDynamicFormChange(newData) {
  // ËØæÁ®ãÂàÜÁ±ªÁé∞Âú®Âú®Âü∫Á°Ä‰ø°ÊÅØ‰∏≠ÈÄâÊã©Ôºå‰∏çÂÜç‰ªéÂä®ÊÄÅË°®Âçï‰∏≠ÁõëÂê¨classTypeÂèòÂåñ
  // Â¶ÇÊûúÈúÄË¶ÅÈáçÊñ∞Âä†ËΩΩÈÖçÁΩÆÔºåÂ∫îËØ•ÁõëÂê¨Âü∫Á°Ä‰ø°ÊÅØ‰∏≠ÁöÑclassTypeÂèòÂåñ

  // ÊâãÂä®Ëß¶ÂèëÈ™åËØÅÊ£ÄÊü•
  setTimeout(() => {
    // Â¶ÇÊûúË°®ÂçïÊï∞ÊçÆÊúâÂÄºÔºåËÆ§‰∏∫È™åËØÅÈÄöËøá
    const hasRequiredFields = checkRequiredFields(newData);
    if (hasRequiredFields) {
      dynamicFormValid.value = true;
    }
  }, 100);
}

function checkRequiredFields(data) {
  if (!formData.productType) return false;

  if (formData.productType === 1) {
    // ËØæÁ®ãÁ±ªÂûãÂøÖÂ°´Â≠óÊÆµÊ£ÄÊü•
    const isExperience = isExperienceClass.value;

    if (isExperience) {
      // ‰ΩìÈ™åËØæÔºöÊ£ÄÊü•ÂàÜÈíüÂ≠óÊÆµÂíåËØæÊó∂Ë¥π
      return data.durationMinutes &&
             data.maxStudents &&
             data.sessionFee !== null && data.sessionFee !== undefined;
    } else {
      // Ê≠£Â∏∏ËØæÁ®ãÔºöÊ£ÄÊü•ÈûçÊó∂Â≠óÊÆµÂíåËØæÊó∂Ë¥π
      return data.classType &&
             data.durationPeriods &&
             data.maxStudents &&
             data.sessionFee !== null && data.sessionFee !== undefined;
    }
  } else if (formData.productType === 2) {
    // ËØæÊó∂ÂåÖÁ±ªÂûãÂøÖÂ°´Â≠óÊÆµÊ£ÄÊü•
    return data.details &&
           data.price !== null && data.price !== undefined &&
           data.totalSessions &&
           data.validityDays &&
           data.stockQuantity !== null && data.stockQuantity !== undefined;
  }

  return false;
}

function onProductTypeChange(e) {
  const productType = e.target.value;

  // ÂàáÊç¢ÂïÜÂìÅÁ±ªÂûãÊó∂ÈáçÁΩÆÂä®ÊÄÅÈÖçÁΩÆÂíåÁä∂ÊÄÅÔºåÁ°Æ‰øùÊï∞ÊçÆÊ∏ÖÊ¥Å
  formData.dynamicConfig = {};
  dynamicFormValid.value = false;

  // Áªü‰∏ÄÂ§ÑÁêÜ‰∏çÂêåÂïÜÂìÅÁ±ªÂûãÁöÑÈÖçÁΩÆÂä†ËΩΩ
  if (productType === 1) {
    // ËØæÁ®ãÁ±ªÂûãÔºöÈªòËÆ§ÈÄâ‰∏≠Âçï‰∫∫ËØæÔºåÁÑ∂ÂêéÂä†ËΩΩËØ¶ÁªÜÈÖçÁΩÆ
    formData.dynamicConfig.classType = 1;
    needsDetailedConfig.value = true; // Á°Æ‰øùÁä∂ÊÄÅÊ≠£Á°ÆÔºåÂÖÅËÆ∏watchËß¶Âèë
    nextTick(() => {
      // Á°Æ‰øùÈ™åËØÅÁä∂ÊÄÅÈáçÁΩÆÔºåÈÅøÂÖçÊóßÊï∞ÊçÆÈ™åËØÅÈîôËØØ
      dynamicFormValid.value = false;
      // ÊâãÂä®Ê∏ÖÈô§ËØæÁ®ãÂàÜÁ±ªÂ≠óÊÆµÁöÑÈ™åËØÅÁä∂ÊÄÅ
      formRef.value?.clearValidate('dynamicConfig.classType');
      loadDetailedFormConfig(productType, 1);
    });
  } else {
    needsDetailedConfig.value = false; // ‰ªÖÂú®ÈùûËØæÁ®ãÁ±ªÂûãÊó∂ÈáçÁΩÆ
    if (productType === 2) {
      // ËØæÊó∂ÂåÖÁ±ªÂûãÔºöÁõ¥Êé•Âä†ËΩΩÂü∫Á°ÄÈÖçÁΩÆÔºå‰∏çÈúÄË¶ÅclassType
      nextTick(() => {
        // ÈáçÁΩÆÈ™åËØÅÁä∂ÊÄÅ
        dynamicFormValid.value = false;
        loadFormConfig(productType);
      });
    }
  }
}

function onClassTypeChange(e) {
  // ËØæÁ®ãÂàÜÁ±ªÂàáÊç¢Êó∂ÊâãÂä®Ê∏ÖÈô§È™åËØÅÁä∂ÊÄÅ
  nextTick(() => {
    formRef.value?.clearValidate('dynamicConfig.classType');
  });
}

function onDynamicFormValidate(valid) {
  dynamicFormValid.value = valid;
  console.log('Âä®ÊÄÅË°®ÂçïÈ™åËØÅÁä∂ÊÄÅ:', valid);
}

async function onSubmit() {
  try {
    // È™åËØÅÂü∫Á°ÄË°®Âçï
    await formRef.value.validate();

    console.log('Âü∫Á°ÄË°®ÂçïÈ™åËØÅÈÄöËøá');
    console.log('ÂΩìÂâçÂïÜÂìÅÁ±ªÂûã:', formData.productType);
    console.log('Âä®ÊÄÅÈÖçÁΩÆÊï∞ÊçÆ:', formData.dynamicConfig);
    console.log('Âä®ÊÄÅË°®ÂçïÈ™åËØÅÁä∂ÊÄÅ:', dynamicFormValid.value);

    // È™åËØÅÂä®ÊÄÅË°®Âçï
    if (formData.productType) {
      // Ê£ÄÊü•ÂøÖÂ°´Â≠óÊÆµ
      const hasRequiredFields = checkRequiredFields(formData.dynamicConfig);
      console.log('ÂøÖÂ°´Â≠óÊÆµÊ£ÄÊü•ÁªìÊûú:', hasRequiredFields);

      if (!hasRequiredFields) {
        message.error('ËØ∑ÂÆåÂñÑÂïÜÂìÅÈÖçÁΩÆ‰ø°ÊÅØ');
        return;
      }
      
      // È™åËØÅÂ∞èÁªÑËØæÊïôÁªÉ‰ª∑Ê†ºÈÖçÁΩÆÔºà‰∏•Ê†ºÁâàÊú¨Ôºâ
      if (isGroupCourse.value) {
        // Ê£ÄÊü•ÊòØÂê¶ÊúâÂèØÁî®ÁöÑÊïôÁªÉ
        if (selectedCoachesWithFee.value.length === 0) {
          if (coachConfigSummary.value.total > 0) {
            message.error('Êó†Ê≥ïËé∑ÂèñÊïôÁªÉËØ¶ÁªÜ‰ø°ÊÅØÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØïÊàñÈáçÊñ∞ÈÄâÊã©ÊïôÁªÉ');
          } else {
            message.error('Â∞èÁªÑËØæÂøÖÈ°ªÈÄâÊã©ÊéàËØæÊïôÁªÉ');
          }
          return;
        }
        
        // Ê£ÄÊü•ÊòØÂê¶ÊúâÊïôÁªÉ‰ø°ÊÅØËé∑ÂèñÂ§±Ë¥•
        if (coachConfigSummary.value.hasIssues) {
          const result = await new Promise((resolve) => {
            Modal.confirm({
              title: 'ÈÉ®ÂàÜÊïôÁªÉ‰ø°ÊÅØÁº∫Â§±',
              content: `${coachConfigSummary.value.failed}‰∏™ÊïôÁªÉÁöÑ‰ø°ÊÅØËé∑ÂèñÂ§±Ë¥•ÔºåÂè™Êúâ${coachConfigSummary.value.valid}‰∏™ÊïôÁªÉÂèØ‰ª•ËøõË°å‰ª∑Ê†ºÈÖçÁΩÆ„ÄÇÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü`,
              onOk: () => resolve(true),
              onCancel: () => resolve(false)
            });
          });
          
          if (!result) return;
        }
        
        // È™åËØÅ‰ª∑Ê†ºÈÖçÁΩÆÂÆåÊï¥ÊÄß
        if (!formData.coachPriceList || formData.coachPriceList.length === 0) {
          message.error('ËØ∑ÂÆåÊàêÊïôÁªÉ‰ª∑Ê†ºÈÖçÁΩÆ');
          return;
        }
        
        // È™åËØÅÊØè‰∏™ÊïôÁªÉÈÉΩÊúâÂÆåÊï¥ÁöÑ‰ª∑Ê†ºÈÖçÁΩÆ
        const incompleteCoaches = formData.coachPriceList.filter(item => {
          if (!item.prices) return true;
          for (let count = 2; count <= 6; count++) {
            if (!item.prices[count] || item.prices[count] <= 0) {
              return true;
            }
          }
          return false;
        });
        
        if (incompleteCoaches.length > 0) {
          message.error('ËØ∑ÂÆåÂñÑÊâÄÊúâÊïôÁªÉÁöÑ‰ª∑Ê†ºÈÖçÁΩÆÔºà2-6‰∫∫Ôºâ');
          return;
        }
      }
    }

    submitLoading.value = true;

    // ÊûÑÈÄ†Êèê‰∫§Êï∞ÊçÆ - ‰∏•Ê†ºÊåâÁÖßÊï∞ÊçÆÂ∫ìÂ≠óÊÆµÁªìÊûÑ
    const submitData = {
      // ‰∏ªË°®Â≠óÊÆµ
      ...formData,

      // Ê†πÊçÆÂïÜÂìÅÁ±ªÂûãÊûÑÈÄ†ÂØπÂ∫îÁöÑÊâ©Â±ïË°®Êï∞ÊçÆ
      dynamicConfig: JSON.stringify(formData.dynamicConfig),

      // ËØæÁ®ãÂïÜÂìÅÂ≠óÊÆµ (productType=1)
      ...(formData.productType === 1 && {
        classType: formData.dynamicConfig.classType,
        durationMinutes: formData.dynamicConfig.durationMinutes,
        durationPeriods: formData.dynamicConfig.durationPeriods,
        maxStudents: formData.dynamicConfig.maxStudents,
        coachFee: formData.dynamicConfig.coachFee,
        horseFee: formData.dynamicConfig.horseFee,
        multiPriceConfig: formData.dynamicConfig.multiPriceConfig
      }),

      // ËØæÊó∂ÂåÖÂïÜÂìÅÂ≠óÊÆµ (productType=2)
      ...(formData.productType === 2 && {
        details: formData.dynamicConfig.details,
        price: formData.dynamicConfig.price,
        totalSessions: formData.dynamicConfig.totalSessions,
        validityDays: formData.dynamicConfig.validityDays,
        stockQuantity: formData.dynamicConfig.stockQuantity
      })

    };

    let response;
    if (isEdit.value) {
      response = await productApi.updateProduct(submitData);
    } else {
      response = await productApi.addProduct(submitData);
    }

    if (response.ok) {
      // ‰∫ßÂìÅ‰øùÂ≠òÊàêÂäüÂêéÔºåÂ§ÑÁêÜÊïôÁªÉÂÖ≥ËÅî
      if (formData.productType === 1 && formData.coachIds && formData.coachIds.length > 0) {
        const productId = isEdit.value ? formData.productId : response.data.productId;
        try {
          const coachResponse = await productApi.updateProductCoaches({
            productId: productId,
            coachIds: formData.coachIds,
            operator: 'current_user' // ËøôÈáåÂèØ‰ª•ÊõøÊç¢‰∏∫ÂÆûÈôÖÁöÑÂΩìÂâçÁî®Êà∑
          });

          if (!coachResponse.ok) {
            console.warn('‰øùÂ≠òÊïôÁªÉÂÖ≥ËÅîÂ§±Ë¥•:', coachResponse.msg);
            message.warning('ËØæÁ®ã‰øùÂ≠òÊàêÂäüÔºå‰ΩÜÊïôÁªÉÂÖ≥ËÅî‰øùÂ≠òÂ§±Ë¥•');
          }
        } catch (coachError) {
          console.warn('‰øùÂ≠òÊïôÁªÉÂÖ≥ËÅîÂºÇÂ∏∏:', coachError);
          message.warning('ËØæÁ®ã‰øùÂ≠òÊàêÂäüÔºå‰ΩÜÊïôÁªÉÂÖ≥ËÅî‰øùÂ≠òÂ§±Ë¥•');
        }
      }

      message.success(isEdit.value ? 'Êõ¥Êñ∞ÊàêÂäü' : 'ÂàõÂª∫ÊàêÂäü');
      goBack();
    } else {
      message.error(response.msg || (isEdit.value ? 'Êõ¥Êñ∞Â§±Ë¥•' : 'ÂàõÂª∫Â§±Ë¥•'));
    }
  } catch (error) {
    if (error.errorFields) {
      message.error('ËØ∑Ê£ÄÊü•Ë°®Âçï‰ø°ÊÅØ');
    } else {
      message.error(isEdit.value ? 'Êõ¥Êñ∞ÂïÜÂìÅÂ§±Ë¥•' : 'ÂàõÂª∫ÂïÜÂìÅÂ§±Ë¥•');
      console.error('Êèê‰∫§ÂïÜÂìÅÂ§±Ë¥•:', error);
    }
  } finally {
    submitLoading.value = false;
  }
}

function resetForm() {
  formRef.value?.resetFields();
  Object.assign(formData, {
    // ‰∏ªË°®Â≠óÊÆµ m_product
    productId: null,
    productName: '',
    productCode: '',
    productType: null,
    subType: '',

    // ÊïôÁªÉÁªëÂÆöÂ≠óÊÆµ
    coachIds: [],
    
    // ÊïôÁªÉ‰ª∑Ê†ºÈÖçÁΩÆÔºàÂ∞èÁªÑËØæ‰∏ìÁî®Ôºâ
    coachPriceList: [],

    // Âä®ÊÄÅÈÖçÁΩÆÂ≠óÊÆµ - ‰∏•Ê†ºÊåâÁÖßÊï∞ÊçÆÂ∫ìË°®ÁªìÊûÑ
    dynamicConfig: {
      // ËØæÁ®ãÂ≠óÊÆµ m_product_course (productType=1)
      classType: null,
      durationMinutes: null,
      durationPeriods: null,
      maxStudents: null,
      coachFee: null,
      horseFee: null,
      multiPriceConfig: null,

      // ËØæÊó∂ÂåÖÂ≠óÊÆµ m_product_package (productType=2)
      details: '',
      price: null,
      totalSessions: null,
      validityDays: null,
      stockQuantity: null
    }
  });
  dynamicFormConfig.value = [];
  dynamicFormValid.value = false;
  needsDetailedConfig.value = false;
  baseFormConfig.value = null;
  currentClassType.value = null;
}

function goBack() {
  router.back();
}
</script>

<style scoped>
.product-form {
  max-width: 1000px;
  margin: 0 auto;
}

.form-section {
  margin-bottom: 24px;
}

.form-section:last-child {
  margin-bottom: 0;
}

/* ÂçïÈÄâÊ°ÜÊ†∑Âºè‰ºòÂåñ */
.ant-radio-group {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
}

.ant-radio-wrapper {
  margin-right: 0;
}

/* ‰ΩìÈ™åËØæË°®ÂçïÂ∏ÉÂ±Ä‰ºòÂåñ */
.experience-form-layout .ant-input-number {
  width: 100%;
}

/* Ê≠£Â∏∏Ë°®ÂçïÂ∏ÉÂ±Ä‰ºòÂåñ */
.normal-form-layout {
  /* ÂèØ‰ª•Ê∑ªÂä†È¢ùÂ§ñÁöÑÊ†∑Âºè */
}
</style>
