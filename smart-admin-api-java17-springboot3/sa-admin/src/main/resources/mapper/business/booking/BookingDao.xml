<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="net.lab1024.sa.admin.module.business.booking.dao.BookingDao">

    <!-- 查询教练时间冲突的预约 -->
    <select id="findCoachTimeConflicts" resultType="net.lab1024.sa.admin.module.business.booking.domain.entity.BookingEntity">
        SELECT * FROM m_booking 
        WHERE coach_id = #{coachId}
        AND booking_status = 2 
        AND booking_id != #{excludeBookingId}
        AND (
            (start_time &lt;= #{startTime} AND end_time &gt; #{startTime}) OR
            (start_time &lt; #{endTime} AND end_time &gt;= #{endTime}) OR  
            (start_time &gt;= #{startTime} AND end_time &lt;= #{endTime})
        )
    </select>

    <!-- 查询马匹时间冲突的预约 -->
    <select id="findHorseTimeConflicts" resultType="net.lab1024.sa.admin.module.business.booking.domain.entity.BookingEntity">
        SELECT * FROM m_booking 
        WHERE horse_id = #{horseId}
        AND booking_status = 2
        AND booking_id != #{excludeBookingId}
        AND (
            (start_time &lt;= #{startTime} AND end_time &gt; #{startTime}) OR
            (start_time &lt; #{endTime} AND end_time &gt;= #{endTime}) OR
            (start_time &gt;= #{startTime} AND end_time &lt;= #{endTime})
        )
    </select>

    <!-- 根据订单ID列表批量查询预约 -->
    <select id="selectByOrderIds" resultType="net.lab1024.sa.admin.module.business.booking.domain.entity.BookingEntity">
        SELECT * FROM m_booking 
        WHERE order_id IN
        <foreach collection="orderIds" item="orderId" open="(" separator="," close=")">
            #{orderId}
        </foreach>
        ORDER BY create_time DESC
    </select>

    <!-- 简化查询预约列表 - 用于列表视图 -->
    <select id="selectSimpleBookingList" resultType="net.lab1024.sa.admin.module.business.booking.domain.vo.BookingSimpleListVO">
        SELECT 
            b.booking_id as bookingId,
            p.product_name as courseName,
            m.actual_name as memberName,
            c.actual_name as coachName,
            h.horse_name as horseName,
            b.actual_coach_fee as coachFee,
            b.actual_horse_fee as horseFee,
            (b.actual_coach_fee + b.actual_horse_fee) as totalFee,
            b.start_time as startTime,
            b.booking_status as bookingStatus,
            b.update_by as updateBy,
            b.update_time as updateTime
        FROM m_booking b
        LEFT JOIN m_member m ON b.member_id = m.member_id
        LEFT JOIN m_coach c ON b.coach_id = c.coach_id
        LEFT JOIN m_horse h ON b.horse_id = h.horse_id
        LEFT JOIN m_product p ON b.product_id = p.product_id
        <where>
            1=1
            <if test="queryForm.keywords != null and queryForm.keywords != ''">
                AND (
                    m.actual_name LIKE CONCAT('%', #{queryForm.keywords}, '%') OR
                    c.actual_name LIKE CONCAT('%', #{queryForm.keywords}, '%') OR
                    p.product_name LIKE CONCAT('%', #{queryForm.keywords}, '%')
                )
            </if>
            <if test="queryForm.bookingStatus != null and queryForm.bookingStatus.size() > 0">
                AND b.booking_status IN
                <foreach collection="queryForm.bookingStatus" item="status" open="(" separator="," close=")">
                    #{status}
                </foreach>
            </if>
            <if test="queryForm.coachId != null">
                AND b.coach_id = #{queryForm.coachId}
            </if>
            <if test="queryForm.memberId != null">
                AND b.member_id = #{queryForm.memberId}
            </if>
            <if test="queryForm.startDate != null">
                AND b.start_time >= #{queryForm.startDate}
            </if>
            <if test="queryForm.endDate != null">
                AND b.end_time &lt;= #{queryForm.endDate}
            </if>
        </where>
        ORDER BY b.create_time DESC
    </select>

</mapper>