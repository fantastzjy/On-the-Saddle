<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="net.lab1024.sa.admin.module.business.coach.dao.CoachDao">

    <!-- 分页查询教练 -->
    <select id="queryPage" resultType="net.lab1024.sa.admin.module.business.coach.domain.vo.CoachListVO">
        SELECT
            c.coach_id,
            c.club_id,
            club.club_name,
            c.user_id,
            u.actual_name as user_name,
            c.coach_no,
            c.avatar_url,
            c.birth_date,
            c.id_card,
            c.entry_date,
            c.specialties,
            c.rider_cert_no,
            c.rider_show_jumping_level,
            c.rider_dressage_level,
            c.rider_eventing_level,
            c.coach_cert_no,
            c.coach_star_level,
            c.coach_fee,
            c.sort_order,
            c.create_by,
            c.create_time,
            c.is_valid
        FROM m_coach c
        LEFT JOIN m_club club ON c.club_id = club.club_id AND club.is_delete = 0
        LEFT JOIN t_employee u ON c.user_id = u.employee_id AND u.deleted_flag = 0
        <where>
            c.is_delete = #{queryForm.isDelete}
            <if test="queryForm.keywords != null and queryForm.keywords != ''">
                AND (
                    INSTR(c.coach_no, #{queryForm.keywords})
                )
            </if>
            <if test="queryForm.clubId != null">
                AND c.club_id = #{queryForm.clubId}
            </if>
            <if test="queryForm.userId != null">
                AND c.user_id = #{queryForm.userId}
            </if>
            <if test="queryForm.coachLevel != null and queryForm.coachLevel != ''">
                AND c.coach_star_level = #{queryForm.coachLevel}
            </if>
            <if test="queryForm.startDate != null and queryForm.startDate != ''">
                AND DATE_FORMAT(c.create_time, '%Y-%m-%d') &gt;= #{queryForm.startDate}
            </if>
            <if test="queryForm.endDate != null and queryForm.endDate != ''">
                AND DATE_FORMAT(c.create_time, '%Y-%m-%d') &lt;= #{queryForm.endDate}
            </if>
            <if test="queryForm.isValid != null">
                AND c.is_valid = #{queryForm.isValid}
            </if>
        </where>
        <if test="queryForm.sortItemList == null or queryForm.sortItemList.size == 0">
            ORDER BY c.sort_order ASC, c.create_time DESC
        </if>
    </select>

    <!-- 根据教练编号查询 -->
    <select id="selectByCoachNo" resultType="net.lab1024.sa.admin.module.business.coach.domain.entity.CoachEntity">
        SELECT * FROM m_coach
        WHERE coach_no = #{coachNo} AND is_delete = 0
        LIMIT 1
    </select>

    <!-- 根据俱乐部和用户ID查询 -->
    <select id="selectByClubAndUser" resultType="net.lab1024.sa.admin.module.business.coach.domain.entity.CoachEntity">
        SELECT * FROM m_coach
        WHERE club_id = #{clubId} AND user_id = #{userId} AND is_delete = 0
        LIMIT 1
    </select>

    <!-- 查询教练详情 -->
    <select id="getDetail" resultType="net.lab1024.sa.admin.module.business.coach.domain.vo.CoachVO">
        SELECT
            c.coach_id,
            c.club_id,
            club.club_name,
            c.user_id,
            u.actual_name as user_name,
            c.coach_no,
            c.avatar_url,
            c.birth_date,
            c.id_card,
            c.entry_date,
            c.specialties,
            c.introduction,
            c.rider_cert_no,
            c.rider_show_jumping_level,
            c.rider_dressage_level,
            c.rider_eventing_level,
            c.rider_show_jumping_images,
            c.rider_dressage_images,
            c.rider_eventing_images,
            c.coach_cert_no,
            c.coach_star_level,
            c.coach_star_cert_images,
            c.coach_show_jumping_level,
            c.coach_show_jumping_images,
            c.coach_dressage_level,
            c.coach_dressage_images,
            c.coach_eventing_level,
            c.coach_eventing_images,
            c.coach_fee,
            c.sort_order,
            c.create_by,
            c.create_time,
            c.update_by,
            c.update_time,
            c.is_valid,
            c.is_delete
        FROM m_coach c
        LEFT JOIN m_club club ON c.club_id = club.club_id AND club.is_delete = 0
        LEFT JOIN t_employee u ON c.user_id = u.employee_id AND u.deleted_flag = 0
        WHERE c.coach_id = #{coachId} AND c.is_delete = 0
    </select>

    <!-- 教练列表查询 -->
    <select id="queryList" resultType="net.lab1024.sa.admin.module.business.coach.domain.vo.CoachListVO">
        SELECT
            c.coach_id,
            c.club_id,
            club.club_name,
            c.user_id,
            u.actual_name as user_name,
            c.coach_no,
            c.avatar_url,
            c.birth_date,
            c.id_card,
            c.entry_date,
            c.specialties,
            c.rider_cert_no,
            c.rider_show_jumping_level,
            c.rider_dressage_level,
            c.rider_eventing_level,
            c.coach_cert_no,
            c.coach_star_level,
            c.coach_fee,
            c.sort_order,
            c.create_by,
            c.create_time,
            c.is_valid
        FROM m_coach c
        LEFT JOIN m_club club ON c.club_id = club.club_id AND club.is_delete = 0
        LEFT JOIN t_employee u ON c.user_id = u.employee_id AND u.deleted_flag = 0
        WHERE c.is_delete = 0
        <if test="isValid != null">
            AND c.is_valid = #{isValid}
        </if>
        <if test="clubId != null">
            AND c.club_id = #{clubId}
        </if>
        ORDER BY c.sort_order ASC, c.create_time DESC
    </select>
    
    <!-- === AI服务专用查询 === -->
    
    <!-- 查询前20个教练（AI候选数据用） -->
    <select id="selectTop20Coaches" resultType="net.lab1024.sa.admin.module.business.coach.domain.entity.CoachEntity">
        SELECT 
            c.coach_id,
            c.club_id,
            c.user_id,
            c.coach_no,
            c.actual_name,
            c.specialties,
            c.coach_fee,
            c.entry_date,
            c.create_time
        FROM m_coach c
        WHERE c.is_delete = 0 AND c.is_valid = 1
        <if test="clubId != null">
            AND c.club_id = #{clubId}
        </if>
        ORDER BY c.sort_order ASC, c.create_time DESC
        LIMIT 20
    </select>
    
    <!-- 根据教练编号和俱乐部查询教练 -->
    <select id="selectByCoachNoAndClub" resultType="net.lab1024.sa.admin.module.business.coach.domain.entity.CoachEntity">
        SELECT 
            c.*
        FROM m_coach c
        WHERE c.coach_no = #{coachNo} 
        AND c.is_delete = 0 
        AND c.is_valid = 1
        <if test="clubId != null">
            AND c.club_id = #{clubId}
        </if>
        LIMIT 1
    </select>
    
    <!-- 根据教练姓名查询 -->
    <select id="selectByName" resultType="net.lab1024.sa.admin.module.business.coach.domain.entity.CoachEntity">
        SELECT 
            c.*
        FROM m_coach c
        WHERE c.is_delete = 0 
        AND c.is_valid = 1
        AND c.actual_name = #{coachName}
        <if test="clubId != null">
            AND c.club_id = #{clubId}
        </if>
        LIMIT 1
    </select>
    
    <!-- 根据教练姓名模糊查询 -->
    <select id="selectByFuzzyName" resultType="net.lab1024.sa.admin.module.business.coach.domain.entity.CoachEntity">
        SELECT 
            c.*
        FROM m_coach c
        WHERE c.is_delete = 0 
        AND c.is_valid = 1
        AND c.actual_name LIKE CONCAT('%', #{coachName}, '%')
        <if test="clubId != null">
            AND c.club_id = #{clubId}
        </if>
        ORDER BY c.sort_order ASC
        LIMIT 1
    </select>
    
    <!-- 根据姓氏前缀匹配教练（支持单字姓氏匹配） -->
    <select id="selectByNamePrefix" resultType="net.lab1024.sa.admin.module.business.coach.domain.entity.CoachEntity">
        SELECT 
            c.*
        FROM m_coach c
        WHERE c.is_delete = 0 
        AND c.is_valid = 1
        AND c.actual_name LIKE CONCAT(#{namePrefix}, '%')
        <if test="clubId != null">
            AND c.club_id = #{clubId}
        </if>
        ORDER BY c.sort_order ASC, c.create_time ASC
        LIMIT 1
    </select>
    
    <!-- 查询默认教练（第一个有效教练） -->
    <select id="selectDefaultCoach" resultType="net.lab1024.sa.admin.module.business.coach.domain.entity.CoachEntity">
        SELECT 
            c.*
        FROM m_coach c
        WHERE c.is_delete = 0 
        AND c.is_valid = 1
        <if test="clubId != null">
            AND c.club_id = #{clubId}
        </if>
        ORDER BY c.sort_order ASC, c.create_time ASC
        LIMIT 1
    </select>
    
    <!-- 根据俱乐部ID查询教练（限制数量） -->
    <select id="selectByClubIdLimit" resultType="net.lab1024.sa.admin.module.business.coach.domain.entity.CoachEntity">
        SELECT 
            c.*
        FROM m_coach c
        WHERE c.is_delete = 0 
        AND c.is_valid = 1
        <if test="clubId != null">
            AND c.club_id = #{clubId}
        </if>
        ORDER BY c.sort_order ASC, c.create_time ASC
        LIMIT #{limit}
    </select>

</mapper>