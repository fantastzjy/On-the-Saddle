# 马术俱乐部商品订单管理系统 - 完整设计方案 v2.0

## 📋 项目概述

**项目定位**: 基于现有马术俱乐部管理系统的全栈商品订单管理扩展，包含后台管理系统和微信小程序  
**核心变化**: 
- 订单生成即创建课表（待确认状态）
- 集成微信支付，完整支付数据存储
- 支持退款后数据回滚
- 小程序端完整下单流程
- 后台管理系统负责商品管理和运营

---

## 🏗️ 系统架构设计

### 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                     马术俱乐部商品订单管理系统                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  📱 微信小程序端              🖥️ 后台管理系统                      │
│  ┌─────────────────┐         ┌─────────────────┐               │
│  │ 商品浏览选择     │         │ 商品管理配置     │               │
│  │ 订单创建支付     │  ⟷     │ 订单管理查看     │               │
│  │ 课程预约管理     │         │ 课表管理确认     │               │
│  │ 个人中心        │         │ 数据统计分析     │               │
│  └─────────────────┘         └─────────────────┘               │
│           │                            │                       │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    API 接口层                               │ │
│  │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │ │
│  │ │ 小程序接口   │ │ 管理后台接口 │ │ 公共服务接口 │          │ │
│  │ │ /api/mini   │ │ /api/admin  │ │ /api/common │          │ │
│  │ └─────────────┘ └─────────────┘ └─────────────┘          │ │
│  └─────────────────────────────────────────────────────────────┘ │
│           │                            │                       │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                   业务服务层                                │ │
│  │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │ │
│  │ │ 商品服务     │ │ 订单服务     │ │ 支付服务     │          │ │
│  │ │ 预约服务     │ │ 课表服务     │ │ 会员服务     │          │ │
│  │ └─────────────┘ └─────────────┘ └─────────────┘          │ │
│  └─────────────────────────────────────────────────────────────┘ │
│           │                                                     │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                  数据存储层                                 │ │
│  │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │ │
│  │ │ MySQL 主库   │ │ Redis 缓存   │ │ 文件存储     │          │ │
│  │ │ 业务数据     │ │ 会话/临时    │ │ 图片/文档    │          │ │
│  │ └─────────────┘ └─────────────┘ └─────────────┘          │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                  外部服务集成                               │ │
│  │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │ │
│  │ │ 微信支付API  │ │ 微信小程序   │ │ 消息推送     │          │ │
│  │ │ 支付/退款    │ │ 登录授权     │ │ 模板消息     │          │ │
│  │ └─────────────┘ └─────────────┘ └─────────────┘          │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

---

## 💰 支付系统设计

### 支付数据表结构新增

#### 支付记录表 (m_payment_record)
```sql
CREATE TABLE `m_payment_record`
(
    `payment_id`        bigint                                  NOT NULL AUTO_INCREMENT COMMENT '支付记录ID',
    `order_id`          bigint                                  NOT NULL COMMENT '关联订单ID',
    `payment_no`        varchar(64) COLLATE utf8mb4_general_ci  NOT NULL COMMENT '支付单号（系统生成）',
    `trade_no`          varchar(64) COLLATE utf8mb4_general_ci  NOT NULL DEFAULT '' COMMENT '第三方交易号',
    `payment_method`    varchar(20) COLLATE utf8mb4_general_ci  NOT NULL COMMENT '支付方式: wechat-微信支付',
    `payment_type`      tinyint                                 NOT NULL COMMENT '支付类型: 1-付款 2-退款',
    `payment_amount`    decimal(10, 2)                          NOT NULL COMMENT '支付金额',
    `payment_status`    tinyint                                 NOT NULL DEFAULT 1 COMMENT '支付状态: 1-待支付 2-支付中 3-支付成功 4-支付失败 5-已关闭',
    `prepay_id`         varchar(64) COLLATE utf8mb4_general_ci  NOT NULL DEFAULT '' COMMENT '微信预支付ID',
    `openid`            varchar(64) COLLATE utf8mb4_general_ci  NOT NULL DEFAULT '' COMMENT '用户openid',
    `payment_time`      datetime                                         DEFAULT NULL COMMENT '支付完成时间',
    `notify_time`       datetime                                         DEFAULT NULL COMMENT '通知回调时间',
    `callback_data`     text COLLATE utf8mb4_general_ci COMMENT '支付回调原始数据JSON',
    `refund_reason`     varchar(200) COLLATE utf8mb4_general_ci NOT NULL DEFAULT '' COMMENT '退款原因',
    `refund_amount`     decimal(10, 2)                          NOT NULL DEFAULT 0.00 COMMENT '退款金额',
    `refund_time`       datetime                                         DEFAULT NULL COMMENT '退款时间',
    `refund_status`     tinyint                                 NOT NULL DEFAULT 0 COMMENT '退款状态: 0-无退款 1-退款中 2-退款成功 3-退款失败',
    `expire_time`       datetime                                         DEFAULT NULL COMMENT '支付过期时间',
    `create_by`         varchar(50) COLLATE utf8mb4_general_ci  NOT NULL DEFAULT '' COMMENT '创建人',
    `create_time`       datetime                                NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `update_by`         varchar(50) COLLATE utf8mb4_general_ci  NOT NULL DEFAULT '' COMMENT '更新人',
    `update_time`       datetime                                NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    PRIMARY KEY (`payment_id`),
    UNIQUE KEY `uk_payment_no` (`payment_no`),
    KEY                 `idx_order_id` (`order_id`),
    KEY                 `idx_trade_no` (`trade_no`),
    KEY                 `idx_payment_status` (`payment_status`),
    KEY                 `idx_create_time` (`create_time`),
    CONSTRAINT `fk_payment_order` FOREIGN KEY (`order_id`) REFERENCES `m_order` (`order_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci COMMENT='支付记录表';
```

#### 支付流水表 (m_payment_flow)
```sql
CREATE TABLE `m_payment_flow`
(
    `flow_id`       bigint                                  NOT NULL AUTO_INCREMENT COMMENT '流水ID',
    `payment_id`    bigint                                  NOT NULL COMMENT '支付记录ID',
    `flow_type`     tinyint                                 NOT NULL COMMENT '流水类型: 1-创建订单 2-发起支付 3-支付成功 4-支付失败 5-申请退款 6-退款成功',
    `flow_amount`   decimal(10, 2)                          NOT NULL DEFAULT 0.00 COMMENT '流水金额',
    `flow_desc`     varchar(200) COLLATE utf8mb4_general_ci NOT NULL COMMENT '流水描述',
    `operator_id`   bigint                                  NOT NULL DEFAULT 0 COMMENT '操作人ID',
    `operator_type` tinyint                                 NOT NULL COMMENT '操作人类型: 1-会员 2-管理员 3-系统',
    `flow_data`     text COLLATE utf8mb4_general_ci COMMENT '流水扩展数据JSON',
    `create_time`   datetime                                NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    PRIMARY KEY (`flow_id`),
    KEY             `idx_payment_id` (`payment_id`),
    KEY             `idx_create_time` (`create_time`),
    CONSTRAINT `fk_flow_payment` FOREIGN KEY (`payment_id`) REFERENCES `m_payment_record` (`payment_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci COMMENT='支付流水表';
```

### 微信支付集成架构

#### 支付流程时序图
```
小程序端          后端API           微信支付           数据库
    │               │                │                │
    │──创建订单────→│                │                │
    │               │──保存订单数据──→│                │
    │               │──创建支付记录──→│                │
    │               │                │                │
    │               │──统一下单API──→│                │
    │               │←──返回prepay_id│                │
    │←──返回支付参数──│                │                │
    │               │                │                │
    │──调起支付────→│                │                │
    │               │                │──用户支付────→ │
    │               │                │                │
    │               │←──支付回调──────│                │
    │               │──更新支付状态──→│                │
    │               │──更新订单状态──→│                │
    │               │──生成课表记录──→│                │
    │               │──发送通知消息──→│                │
    │               │                │                │
    │←──支付成功通知──│                │                │
```

#### 支付服务核心代码结构
```javascript
// 支付服务类
class PaymentService {
  
  // 创建支付订单
  async createPayment(orderData) {
    // 1. 验证订单数据
    // 2. 生成支付记录
    // 3. 调用微信统一下单
    // 4. 返回支付参数
  }
  
  // 支付成功回调处理
  async handlePaymentSuccess(callbackData) {
    // 1. 验证回调数据
    // 2. 更新支付状态
    // 3. 更新订单状态
    // 4. 自动生成课表
    // 5. 扣减库存
    // 6. 发送通知
  }
  
  // 申请退款
  async applyRefund(paymentId, refundAmount, reason) {
    // 1. 验证退款条件
    // 2. 调用微信退款API
    // 3. 更新退款状态
    // 4. 恢复相关数据
  }
}
```

---

## 🔄 业务流程重新设计

### 新的核心业务流程

```
小程序端选择商品 → 配置商品参数 → 选择上课时间 → 确认订单信息 → 发起微信支付
        ↓              ↓              ↓            ↓              ↓
     商品类型展示      动态配置表单     时间冲突检测   生成待付订单     创建支付记录
        ↓              ↓              ↓            ↓              ↓
     支付成功回调 → 更新订单状态 → 自动生成课表 → 扣减相关库存 → 推送消息通知
        ↓              ↓              ↓            ↓              ↓
     支付流水记录      订单状态:已付   课表状态:待确认   库存实时更新    微信模板消息
```

### 详细业务状态流转图

```
订单状态流转:
┌─────────────┐    支付成功    ┌─────────────┐    后台确认    ┌─────────────┐
│  1-待支付    │──────────→   │  2-已支付    │──────────→   │  3-已确认    │
│  (30分钟)   │              │             │              │             │
└─────────────┘              └─────────────┘              └─────────────┘
       │                            │                            │
       │支付超时                      │申请退款                      │课程完成
       ↓                            ↓                            ↓
┌─────────────┐              ┌─────────────┐              ┌─────────────┐
│  4-已取消    │              │  5-已退款    │              │  6-已完成    │
│             │              │             │              │             │
└─────────────┘              └─────────────┘              └─────────────┘

课表状态流转:
┌─────────────┐    后台确认    ┌─────────────┐    学员到店    ┌─────────────┐
│  1-待确认    │──────────→   │  2-已确认    │──────────→   │  3-进行中    │
│             │              │             │              │             │
└─────────────┘              └─────────────┘              └─────────────┘
       │                            │                            │
       │订单退款                      │取消课程                      │课程结束
       ↓                            ↓                            ↓
┌─────────────┐              ┌─────────────┐              ┌─────────────┐
│  4-已取消    │              │  4-已取消    │              │  5-已完成    │
│             │              │             │              │             │
└─────────────┘              └─────────────┘              └─────────────┘

支付状态流转:
┌─────────────┐    统一下单    ┌─────────────┐    支付成功    ┌─────────────┐
│  1-待支付    │──────────→   │  2-支付中    │──────────→   │  3-支付成功  │
│             │              │             │              │             │
└─────────────┘              └─────────────┘              └─────────────┘
       │                            │                            │
       │订单超时                      │支付失败                      │申请退款
       ↓                            ↓                            ↓
┌─────────────┐              ┌─────────────┐              ┌─────────────┐
│  5-已关闭    │              │  4-支付失败  │              │退款处理状态   │
│             │              │             │              │             │
└─────────────┘              └─────────────┘              └─────────────┘
```

---

## 📱 小程序端设计

### 小程序页面架构

```
小程序页面结构:
├── 首页 (index)
│   ├── 轮播图展示
│   ├── 商品分类入口
│   └── 推荐商品列表
│
├── 商品模块
│   ├── 商品列表页 (product/list)
│   ├── 商品详情页 (product/detail)
│   ├── 课程配置页 (product/course-config)
│   ├── 课时包配置页 (product/package-config)
│   └── 活动详情页 (product/activity-detail)
│
├── 订单模块
│   ├── 订单确认页 (order/confirm)
│   ├── 支付页面 (order/payment)
│   ├── 订单列表页 (order/list)
│   └── 订单详情页 (order/detail)
│
├── 预约模块
│   ├── 时间选择页 (booking/time-select)
│   ├── 教练选择页 (booking/coach-select)
│   ├── 我的预约页 (booking/my-list)
│   └── 预约详情页 (booking/detail)
│
└── 个人中心
    ├── 个人信息页 (user/profile)
    ├── 我的课时包 (user/packages)
    ├── 课程历史 (user/lessons)
    └── 设置页面 (user/settings)
```

### 小程序关键页面设计

#### 1. 商品详情页设计
```
┌─────────────────────────────────────────────────────────────┐
│ ← 商品详情                                    分享 ⋯        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│     ┌─────────────────────────────────────────────────┐     │
│     │                                                 │     │
│     │              商品轮播图                          │     │
│     │                                                 │     │
│     └─────────────────────────────────────────────────┘     │
│                                                             │
│ 📚 体验课程                                    ¥200        │
│ 🏷️ 适合新手体验 | 教练一对一指导                             │
│                                                             │
│ ┌─商品类型─────────────────────────────────────────────────┐ │
│ │ ⦿ 单人课    ○ 多人课                                   │ │
│ └───────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─时长设置─────────────────────────────────────────────────┐ │
│ │ 🕐 60分钟 | 🏇 1.0鞍时 | 👥 最多1人                   │ │
│ └───────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─价格明细─────────────────────────────────────────────────┐ │
│ │ 教练费: ¥150  马匹费: ¥50  合计: ¥200                  │ │
│ └───────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─可选教练─────────────────────────────────────────────────┐ │
│ │ 👨‍🏫 李教练(推荐) 👨‍🏫 王教练 👨‍🏫 张教练                │ │
│ └───────────────────────────────────────────────────────┘ │
│                                                             │
│ [                    立即预约                              ] │
│ [                    加入购物车                            ] │
└─────────────────────────────────────────────────────────────┘
```

#### 2. 订单确认页设计
```
┌─────────────────────────────────────────────────────────────┐
│ ← 确认订单                                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 📍 上课地址                                                 │
│ 海淀区马术俱乐部 | 📞 010-12345678                         │
│                                                             │
│ ┌─课程信息─────────────────────────────────────────────────┐ │
│ │ 📚 体验课程                                  ¥200       │ │
│ │ 👨‍🏫 李教练 | 🕐 2024-08-20 14:00-15:00              │ │
│ │ 🏇 单人课 | 60分钟 | 1.0鞍时                           │ │
│ └───────────────────────────────────────────────────────┘ │
│                                                             │
│ 👤 学员信息                                                │
│ 张小明 | 📞 138****1234                                   │
│                                                             │
│ 💰 费用明细                                                │
│ 课程费用: ¥200                                             │
│ 优惠金额: -¥0                                              │
│ ─────────────────────────────────────────                 │
│ 实付金额: ¥200                                             │
│                                                             │
│ 📝 备注信息                                                │
│ ┌───────────────────────────────────────────────────────┐ │
│ │ 请输入特殊需求或备注...                                │ │
│ └───────────────────────────────────────────────────────┘ │
│                                                             │
│ [                   确认支付 ¥200                         ] │
└─────────────────────────────────────────────────────────────┘
```

#### 3. 我的预约页设计
```
┌─────────────────────────────────────────────────────────────┐
│ 我的预约                    📅 日历视图 📋 列表视图         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 🔍 搜索课程...                        [全部▼] [筛选]       │
│                                                             │
│ ┌─今日课程─────────────────────────────────────────────────┐ │
│ │ 🟢 14:00-15:00  体验课程                               │ │
│ │    👨‍🏫 李教练  🏇 马001  📍 场地A                     │ │
│ │    [签到] [查看详情] [取消]                            │ │
│ └───────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─明日课程─────────────────────────────────────────────────┐ │
│ │ 🟡 09:00-10:00  基础课程                  待确认        │ │
│ │    👨‍🏫 王教练  🏇 待分配  📍 待分配                   │ │
│ │    [查看详情] [修改] [取消]                            │ │
│ └───────────────────────────────────────────────────────┘ │
│                                                             │
│ ┌─下周课程─────────────────────────────────────────────────┐ │
│ │ 🔵 2024-08-25 10:00-11:00  进阶课程                   │ │
│ │    👨‍🏫 张教练  🏇 马003  📍 场地B                     │ │
│ │    [查看详情] [修改]                                   │ │
│ └───────────────────────────────────────────────────────┘ │
│                                                             │
│ 📊 本月统计: 已上8节 | 剩余课时包: 12节                     │
│                                                             │
│ [                    预约新课程                            ] │
└─────────────────────────────────────────────────────────────┘
```

### 小程序API接口设计

#### 接口分层架构
```
/api/mini/                          // 小程序专用接口前缀
├── auth/                          // 授权相关
│   ├── POST /login                // 微信登录
│   ├── POST /refresh              // 刷新token
│   └── POST /logout               // 退出登录
│
├── product/                       // 商品相关
│   ├── GET /list                  // 商品列表
│   ├── GET /{id}                  // 商品详情
│   ├── GET /{id}/coaches          // 商品可选教练
│   └── GET /{id}/config           // 商品配置选项
│
├── order/                         // 订单相关
│   ├── POST /create               // 创建订单
│   ├── GET /list                  // 订单列表
│   ├── GET /{id}                  // 订单详情
│   ├── POST /{id}/cancel          // 取消订单
│   └── POST /{id}/refund          // 申请退款
│
├── payment/                       // 支付相关
│   ├── POST /create               // 创建支付
│   ├── POST /notify               // 支付回调
│   ├── GET /{id}/status           // 支付状态
│   └── POST /{id}/refund          // 申请退款
│
├── booking/                       // 预约相关
│   ├── GET /list                  // 我的预约
│   ├── GET /{id}                  // 预约详情
│   ├── POST /{id}/checkin         // 签到
│   ├── PUT /{id}/modify           // 修改预约
│   └── POST /{id}/cancel          // 取消预约
│
├── schedule/                      // 课表相关
│   ├── GET /available-times       // 可预约时间
│   ├── GET /coach-schedule        // 教练课表
│   └── POST /conflict-check       // 冲突检测
│
└── user/                         // 用户相关
    ├── GET /profile              // 个人信息
    ├── PUT /profile              // 更新信息
    ├── GET /packages             // 我的课时包
    └── GET /lessons              // 课程历史
```

---

## 🖥️ 后台管理系统设计

### 后台系统功能架构

```
后台管理系统功能模块:
├── 🏪 俱乐部管理
│   ├── 基本信息设置
│   ├── 营业时间配置
│   └── 轮播图管理
│
├── 🛍️ 商品管理
│   ├── 商品列表管理
│   ├── 商品创建配置
│   ├── 价格策略管理
│   └── 库存监控
│
├── 🧾 订单管理
│   ├── 订单列表查询
│   ├── 订单详情查看
│   ├── 退款处理
│   └── 订单统计
│
├── 📅 课表管理
│   ├── 课表总览 (日/周/月视图)
│   ├── 课程确认/调整
│   ├── 资源冲突检测
│   └── 批量操作
│
├── 👨‍🏫 教练管理
│   ├── 教练档期设置
│   ├── 请假管理
│   ├── 工作量统计
│   └── 收入分析
│
├── 🐎 马匹管理
│   ├── 马匹档期管理
│   ├── 健康状态监控
│   ├── 使用统计
│   └── 维护提醒
│
├── 👥 会员管理
│   ├── 会员信息查看
│   ├── 课时包管理
│   ├── 消费记录
│   └── 活跃度分析
│
├── 💰 财务管理
│   ├── 收入统计报表
│   ├── 支付流水查询
│   ├── 退款记录
│   └── 对账管理
│
└── 📊 数据分析
    ├── 运营数据大屏
    ├── 趋势分析报告
    ├── 客户行为分析
    └── 决策支持系统
```

### 关键后台页面设计

#### 1. 课表管理主页面
```
┌─────────────────────────────────────────────────────────────────┐
│ 📅 课表管理                [日视图] [周视图] [月视图] [新增课程]    │
├─────────────────────────────────────────────────────────────────┤
│ 筛选条件：                                                      │
│ 📅 [2024-08-20] 👨‍🏫 [全部教练▼] 🐎 [全部马匹▼] 📍 [全部场地▼]  │
│ 📋 [全部状态▼] 🔍 [搜索学员/订单号]                              │
├─────────────────────────────────────────────────────────────────┤
│                     2024年8月20日 周二课表                       │
│                                                                 │
│  时间   │ 李教练   │ 王教练   │ 张教练   │ 场地A   │ 场地B   │ 操作  │
│ ──────┼────────┼────────┼────────┼────────┼────────┼──────┤
│09:00   │🟡待确认  │         │🟢已确认  │ 占用    │ 空闲    │[批量] │
│-10:00  │张小明    │         │李小红    │ 马001   │         │[确认] │
│        │体验课    │         │基础课    │         │         │      │
│        │¥200      │         │¥300      │         │         │      │
│ ──────┼────────┼────────┼────────┼────────┼────────┼──────┤
│10:00   │         │🔵进行中  │         │         │ 占用    │[查看] │
│-11:00  │         │王小刚    │         │         │ 马002   │[调整] │
│        │         │进阶课    │         │         │         │      │
│        │         │¥400      │         │         │         │      │
│ ──────┼────────┼────────┼────────┼────────┼────────┼──────┤
│14:00   │🟢已确认  │         │🟡待确认  │ 占用    │ 占用    │[详情] │
│-15:00  │赵小华    │         │新学员    │ 马003   │ 马001   │[编辑] │
│        │高级课    │         │体验课    │         │         │      │
│        │¥500      │         │¥200      │         │         │      │
└─────────────────────────────────────────────────────────────────┘
│ 📊 今日统计: 总课程 8节 | 已确认 5节 | 待确认 3节 | 完成率 62.5%  │
│ 💰 今日收入: ¥2,400 | 待确认收入: ¥900                           │
└─────────────────────────────────────────────────────────────────┘
```

#### 2. 商品配置页面（智能表单）
```
┌─────────────────────────────────────────────────────────────────┐
│ 新增商品                                              [保存] [取消] │
├─────────────────────────────────────────────────────────────────┤
│ 📋 基础信息                                                     │
│ 商品名称: [________________] 商品编码: [__________]              │
│ 商品类型: ⦿课程 ○课时包 ○活动                                   │
│ 商品描述: [_________________________________________________]  │
│                                                                 │
│ 🖼️ 商品图片: [上传图片] [预览]                                    │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │  📷      📷      📷                                       │ │
│ │ 图片1    图片2    图片3    [+ 添加图片]                    │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                 │
│ 🎓 课程配置 (根据选择的商品类型自动显示)                         │
│                                                                 │
│ 课程分类: ⦿单人课 ○多人课                                       │
│ 时长设置: [60] 分钟  鞍时: [1.0]  最大人数: [1]                │
│                                                                 │
│ 💰 价格配置:                                                   │
│ 教练费: [150] 元  马匹费: [50] 元                              │
│ → 基础单价: 200 元 (自动计算)                                   │
│                                                                 │
│ 👨‍🏫 可选教练: □ 李教练 ☑ 王教练 ☑ 张教练                      │
│ 默认教练: [王教练▼]                                             │
│                                                                 │
│ ┌─多人课价格配置────────────────────────────────────────────────┐ │
│ │ 📊 按人数阶梯定价:                                          │ │
│ │ 2人: [180/人] 3人: [160/人] 4人: [150/人] 5人: [140/人]     │ │
│ │                                                            │ │
│ │ 👨‍🏫 教练差异化定价:                                        │ │
│ │ 李教练: +20元 | 王教练: 标准价 | 张教练: +10元                │ │
│ └────────────────────────────────────────────────────────────┘ │
│                                                                 │
│ ⚙️ 高级设置:                                                   │
│ 支持到店调价: ☑ 是 ○ 否                                        │
│ 提前预约时间: [24] 小时                                         │
│ 取消课程规则: [课前24小时可免费取消]                             │
└─────────────────────────────────────────────────────────────────┘
```

#### 3. 订单管理页面
```
┌─────────────────────────────────────────────────────────────────┐
│ 📋 订单管理                                      [导出Excel] [新增] │
├─────────────────────────────────────────────────────────────────┤
│ 筛选条件：                                                      │
│ 📅 [今日▼] 💰 [全部状态▼] 🛍️ [商品类型▼] 👤 [会员搜索______]    │
│ 💳 [支付方式▼] 🔍 [订单号搜索______] [搜索] [重置]               │
├─────────────────────────────────────────────────────────────────┤
│ ┌─┬──────┬─────────┬──────┬──────┬──────┬──────┬──────┬────────┐ │
│ │✓│订单号 │ 下单时间 │ 会员 │ 商品 │ 金额 │ 支付 │ 状态 │ 操作   │ │
│ ├─┼──────┼─────────┼──────┼──────┼──────┼──────┼──────┼────────┤ │
│ │□│O2024082│14:32:18 │张小明 │体验课│ ¥200│微信付│🟢已付│查看|退款│ │
│ │ │0001   │         │13812 │60min │     │14:33 │     │        │ │
│ ├─┼──────┼─────────┼──────┼──────┼──────┼──────┼──────┼────────┤ │
│ │□│O2024082│14:28:45 │李小红 │课时包│¥2000│微信付│🟡待确│确认|详情│ │
│ │ │0002   │         │13823 │10节课│     │14:30 │认   │        │ │
│ ├─┼──────┼─────────┼──────┼──────┼──────┼──────┼──────┼────────┤ │
│ │□│O2024082│14:15:22 │王小刚 │活动  │ ¥300│待支付│🔴超时│查看|关闭│ │
│ │ │0003   │         │13834 │春游  │     │      │     │        │ │
│ └─┴──────┴─────────┴──────┴──────┴──────┴──────┴──────┴────────┘ │
│                                                                 │
│ 📊 统计信息:                                                   │
│ 📈 今日订单: 28单 | 💰 今日收入: ¥8,600 | ✅ 支付成功率: 92.3%  │
│ 🔄 待处理: 3单 | ⏰ 超时订单: 1单 | 📞 需要回访: 2单            │
│                                                                 │
│ 页码: [上页] 1 2 3 ... 10 [下页] 共 245 条记录                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔧 技术实现细节

### 支付安全设计

#### 1. 签名验证机制
```javascript
// 支付回调签名验证
function verifyWechatSignature(data, signature) {
  const stringA = Object.keys(data)
    .filter(key => data[key] !== '' && key !== 'sign')
    .sort()
    .map(key => `${key}=${data[key]}`)
    .join('&');
  
  const stringSignTemp = `${stringA}&key=${API_KEY}`;
  const hash = crypto.createHash('md5').update(stringSignTemp).digest('hex');
  
  return hash.toUpperCase() === signature;
}
```

#### 2. 幂等性保证
```javascript
// 支付幂等性控制
class PaymentIdempotency {
  async processPayment(orderNo, paymentData) {
    const lockKey = `payment:lock:${orderNo}`;
    const lock = await redis.set(lockKey, '1', 'PX', 30000, 'NX');
    
    if (!lock) {
      throw new Error('支付正在处理中，请勿重复操作');
    }
    
    try {
      // 检查是否已支付
      const existingPayment = await this.getPaymentByOrderNo(orderNo);
      if (existingPayment && existingPayment.status === 'SUCCESS') {
        return existingPayment;
      }
      
      // 处理支付逻辑
      return await this.doPayment(paymentData);
    } finally {
      await redis.del(lockKey);
    }
  }
}
```

### 数据一致性保证

#### 1. 分布式事务处理
```javascript
// 支付成功后的数据更新事务
async function handlePaymentSuccess(paymentData) {
  const transaction = await sequelize.transaction();
  
  try {
    // 1. 更新支付状态
    await PaymentRecord.update({
      payment_status: 3, // 支付成功
      payment_time: new Date(),
      trade_no: paymentData.trade_no
    }, { 
      where: { payment_no: paymentData.payment_no },
      transaction 
    });
    
    // 2. 更新订单状态
    await Order.update({
      order_status: 2, // 已支付
      paid_amount: paymentData.amount,
      payment_time: new Date()
    }, { 
      where: { order_id: paymentData.order_id },
      transaction 
    });
    
    // 3. 生成课表记录
    const scheduleData = await this.generateSchedule(paymentData.order_id);
    await LessonSchedule.create(scheduleData, { transaction });
    
    // 4. 扣减库存（如果是课时包）
    if (paymentData.product_type === 2) {
      await this.deductPackageStock(paymentData.product_id, paymentData.quantity, transaction);
    }
    
    // 5. 记录支付流水
    await PaymentFlow.create({
      payment_id: paymentData.payment_id,
      flow_type: 3, // 支付成功
      flow_amount: paymentData.amount,
      flow_desc: '支付成功',
      operator_type: 3 // 系统
    }, { transaction });
    
    await transaction.commit();
    
    // 6. 发送异步通知（事务外执行）
    await this.sendPaymentSuccessNotification(paymentData);
    
  } catch (error) {
    await transaction.rollback();
    throw error;
  }
}
```

#### 2. 退款数据回滚
```javascript
// 退款处理逻辑
async function processRefund(paymentId, refundAmount, reason) {
  const transaction = await sequelize.transaction();
  
  try {
    // 1. 获取原支付记录
    const payment = await PaymentRecord.findByPk(paymentId, { transaction });
    const order = await Order.findByPk(payment.order_id, { transaction });
    
    // 2. 调用微信退款API
    const refundResult = await wechatPay.refund({
      transaction_id: payment.trade_no,
      out_refund_no: `RF${Date.now()}`,
      amount: {
        refund: refundAmount * 100, // 分
        total: payment.payment_amount * 100,
        currency: 'CNY'
      },
      reason: reason
    });
    
    // 3. 更新支付记录
    await payment.update({
      refund_status: 2, // 退款成功
      refund_amount: refundAmount,
      refund_time: new Date(),
      refund_reason: reason
    }, { transaction });
    
    // 4. 更新订单状态
    await order.update({
      order_status: 5, // 已退款
      paid_amount: payment.payment_amount - refundAmount
    }, { transaction });
    
    // 5. 取消相关课表
    await LessonSchedule.update({
      lesson_status: 4 // 已取消
    }, { 
      where: { booking_id: order.booking_id },
      transaction 
    });
    
    // 6. 恢复库存
    if (order.order_type === 2) { // 课时包
      await this.restorePackageStock(order.product_id, order.quantity, transaction);
    }
    
    // 7. 记录退款流水
    await PaymentFlow.create({
      payment_id: paymentId,
      flow_type: 6, // 退款成功
      flow_amount: refundAmount,
      flow_desc: `退款: ${reason}`,
      operator_type: 2 // 管理员
    }, { transaction });
    
    await transaction.commit();
    
    // 8. 发送退款通知
    await this.sendRefundNotification(payment, refundAmount);
    
  } catch (error) {
    await transaction.rollback();
    throw error;
  }
}
```

### 课表自动生成算法

#### 1. 智能排课算法
```javascript
// 智能课表生成
class ScheduleGenerator {
  async generateOptimalSchedule(orderData) {
    const { product_id, preferred_time, coach_id, member_id } = orderData;
    
    // 1. 获取商品信息
    const product = await this.getProductWithConfig(product_id);
    
    // 2. 获取可用时间段
    const availableSlots = await this.getAvailableTimeSlots(
      preferred_time.date, 
      product.duration_minutes
    );
    
    // 3. 获取教练可用性
    const coachAvailability = await this.getCoachAvailability(
      coach_id, 
      preferred_time.date
    );
    
    // 4. 获取马匹可用性
    const horseAvailability = await this.getHorseAvailability(
      preferred_time.date
    );
    
    // 5. 智能匹配最佳时段
    const optimalSlot = this.findOptimalSlot({
      availableSlots,
      coachAvailability,
      horseAvailability,
      preferredTime: preferred_time.time,
      memberHistory: await this.getMemberLessonHistory(member_id)
    });
    
    // 6. 生成课表记录
    return {
      schedule_no: this.generateScheduleNo(),
      booking_id: orderData.booking_id,
      club_id: orderData.club_id,
      member_id: member_id,
      coach_id: coach_id,
      horse_id: optimalSlot.horse_id,
      lesson_date: optimalSlot.date,
      start_time: optimalSlot.start_time,
      end_time: optimalSlot.end_time,
      lesson_status: 1, // 待确认
      notification_sent: 0,
      reminder_sent: 0
    };
  }
  
  findOptimalSlot(params) {
    const { availableSlots, coachAvailability, horseAvailability, preferredTime, memberHistory } = params;
    
    // 评分算法
    const scoredSlots = availableSlots.map(slot => {
      let score = 0;
      
      // 时间偏好评分（越接近期望时间分数越高）
      const timeDiff = Math.abs(this.getTimeDiff(slot.start_time, preferredTime));
      score += Math.max(0, 100 - timeDiff * 10);
      
      // 教练可用性评分
      if (coachAvailability.includes(slot.start_time)) {
        score += 50;
      }
      
      // 马匹匹配评分（根据会员历史偏好）
      const preferredHorse = this.getMemberPreferredHorse(memberHistory);
      if (slot.horse_id === preferredHorse) {
        score += 30;
      }
      
      // 连续课程奖励（如果会员有连续上课习惯）
      if (this.isConsecutiveLesson(slot, memberHistory)) {
        score += 20;
      }
      
      return { ...slot, score };
    });
    
    // 返回评分最高的时段
    return scoredSlots.sort((a, b) => b.score - a.score)[0];
  }
}
```

### 小程序与后台数据同步

#### 1. WebSocket实时通信
```javascript
// WebSocket服务设计
class ScheduleWebSocketService {
  constructor() {
    this.connections = new Map(); // clubId -> Set<connection>
  }
  
  // 建立连接
  onConnection(ws, clubId, userType) {
    if (!this.connections.has(clubId)) {
      this.connections.set(clubId, new Set());
    }
    
    ws.clubId = clubId;
    ws.userType = userType; // 'admin' | 'miniapp'
    this.connections.get(clubId).add(ws);
    
    ws.on('close', () => {
      this.connections.get(clubId).delete(ws);
    });
  }
  
  // 广播课表更新
  broadcastScheduleUpdate(clubId, updateData) {
    const connections = this.connections.get(clubId);
    if (connections) {
      connections.forEach(ws => {
        if (ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({
            type: 'schedule_update',
            data: updateData,
            timestamp: Date.now()
          }));
        }
      });
    }
  }
  
  // 发送支付成功通知
  notifyPaymentSuccess(clubId, orderData) {
    this.broadcastScheduleUpdate(clubId, {
      type: 'payment_success',
      order: orderData,
      action: 'new_lesson_created'
    });
  }
}
```

#### 2. 数据缓存策略
```javascript
// Redis缓存策略
class CacheService {
  constructor() {
    this.redis = new Redis(config.redis);
  }
  
  // 课表数据缓存
  async cacheScheduleData(clubId, date, data) {
    const key = `schedule:${clubId}:${date}`;
    await this.redis.setex(key, 300, JSON.stringify(data)); // 5分钟缓存
  }
  
  // 获取缓存的课表数据
  async getCachedSchedule(clubId, date) {
    const key = `schedule:${clubId}:${date}`;
    const cached = await this.redis.get(key);
    return cached ? JSON.parse(cached) : null;
  }
  
  // 清除相关缓存
  async invalidateScheduleCache(clubId, date) {
    const pattern = `schedule:${clubId}:${date}*`;
    const keys = await this.redis.keys(pattern);
    if (keys.length > 0) {
      await this.redis.del(...keys);
    }
  }
  
  // 用户课时包缓存
  async cacheUserPackages(memberId, packages) {
    const key = `user:packages:${memberId}`;
    await this.redis.setex(key, 600, JSON.stringify(packages)); // 10分钟缓存
  }
}
```

---

## 📊 系统监控与日志

### 1. 关键指标监控
```javascript
// 业务指标监控
const BusinessMetrics = {
  // 支付成功率
  paymentSuccessRate: {
    metric: 'payment_success_rate',
    calculate: async () => {
      const total = await PaymentRecord.count({
        where: { create_time: { [Op.gte]: dayjs().startOf('day') } }
      });
      const success = await PaymentRecord.count({
        where: { 
          payment_status: 3,
          create_time: { [Op.gte]: dayjs().startOf('day') } 
        }
      });
      return total > 0 ? (success / total * 100).toFixed(2) : 0;
    }
  },
  
  // 课程完成率
  lessonCompletionRate: {
    metric: 'lesson_completion_rate',
    calculate: async () => {
      const total = await LessonSchedule.count({
        where: { lesson_date: { [Op.gte]: dayjs().startOf('day') } }
      });
      const completed = await LessonSchedule.count({
        where: { 
          lesson_status: 5,
          lesson_date: { [Op.gte]: dayjs().startOf('day') } 
        }
      });
      return total > 0 ? (completed / total * 100).toFixed(2) : 0;
    }
  },
  
  // 平均响应时间
  avgResponseTime: {
    metric: 'avg_response_time',
    calculate: async () => {
      // 从日志中计算API平均响应时间
      return await LogService.getAvgResponseTime();
    }
  }
};
```

### 2. 异常处理与告警
```javascript
// 异常处理服务
class ExceptionHandler {
  static async handlePaymentException(error, context) {
    // 记录详细错误日志
    logger.error('Payment Exception', {
      error: error.message,
      stack: error.stack,
      context: context,
      timestamp: new Date().toISOString()
    });
    
    // 发送告警通知
    await AlertService.send({
      type: 'payment_error',
      level: 'critical',
      message: `支付异常: ${error.message}`,
      context: context
    });
    
    // 尝试数据恢复
    if (context.order_id) {
      await this.recoverOrderData(context.order_id);
    }
  }
  
  static async handleScheduleConflict(conflictData) {
    logger.warn('Schedule Conflict Detected', conflictData);
    
    // 自动解决冲突
    const resolution = await ConflictResolver.resolve(conflictData);
    
    if (!resolution.success) {
      // 无法自动解决，发送人工干预通知
      await AlertService.send({
        type: 'schedule_conflict',
        level: 'warning',
        message: '课表冲突需要人工处理',
        data: conflictData
      });
    }
  }
}
```

---

## 🚀 部署与运维

### 1. 环境配置
```yaml
# docker-compose.yml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DB_HOST=mysql
      - REDIS_HOST=redis
    depends_on:
      - mysql
      - redis

  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: equestrian_club
    volumes:
      - mysql_data:/var/lib/mysql
      - ./sql:/docker-entrypoint-initdb.d

  redis:
    image: redis:6.2-alpine
    volumes:
      - redis_data:/data

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - app

volumes:
  mysql_data:
  redis_data:
```

### 2. CI/CD流水线
```yaml
# .github/workflows/deploy.yml
name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Run Tests
        run: |
          npm install
          npm run test
          npm run test:e2e

  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Build Docker Image
        run: |
          docker build -t equestrian-club:${{ github.sha }} .
          docker tag equestrian-club:${{ github.sha }} equestrian-club:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Server
        run: |
          # 部署脚本
          ssh user@server 'docker-compose pull && docker-compose up -d'
```

---

## 📋 总结

### 🎯 核心特性总结
1. **双端架构**: 后台管理系统 + 微信小程序，数据实时同步
2. **智能排课**: 订单生成即创建课表，支持冲突检测和自动优化
3. **完整支付**: 微信支付集成，支持退款和数据回滚
4. **动态表单**: 根据商品类型自动切换配置表单
5. **实时通信**: WebSocket实现多用户实时课表更新

### 📊 技术优势
- **高可用性**: 分布式架构，Redis缓存，数据库主从
- **数据一致性**: 分布式事务，幂等性控制
- **安全可靠**: 支付签名验证，数据加密传输
- **性能优化**: 索引优化，缓存策略，懒加载

### 🔮 扩展性设计
- **微服务架构**: 模块化设计，便于后续拆分
- **插件化支付**: 支持多种支付方式扩展
- **多租户支持**: 为连锁俱乐部提供扩展基础
- **数据分析**: 完整的数据埋点，支持深度分析

---

**文档版本**: v2.0  
**更新时间**: 2024-08-15  
**设计状态**: 待开发实现