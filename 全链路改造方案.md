# é©¬æœ¯ä¿±ä¹éƒ¨è®¢å•ç³»ç»Ÿå…¨é“¾è·¯æ”¹é€ æ–¹æ¡ˆ

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

åŸºäºæ–°çš„ä¸šåŠ¡çŠ¶æ€è®¾è®¡ï¼ˆå¾…æ”¯ä»˜ä¸ç”Ÿæˆé¢„çº¦è®°å½•ï¼Œåªå ç”¨èµ„æºæ—¶é—´æ®µï¼‰ï¼Œå¯¹ç°æœ‰è®¢å•åˆ›å»ºæµç¨‹è¿›è¡Œå…¨é¢æ”¹é€ ï¼Œå®ç°æ›´ç¬¦åˆå®é™…ä¸šåŠ¡åœºæ™¯çš„è®¢å•ç®¡ç†ç³»ç»Ÿã€‚

## ğŸ¯ æ”¹é€ ç›®æ ‡

### æ–°çŠ¶æ€è®¾è®¡
- **è®¢å•çŠ¶æ€**ï¼š1-å¾…æ”¯ä»˜ã€2-å·²æ”¯ä»˜ã€3-å·²æ ¸é”€ã€4-å·²å–æ¶ˆã€5-å·²é€€æ¬¾
- **é¢„çº¦çŠ¶æ€**ï¼š1-å·²é¢„çº¦ã€2-å·²æ ¸é”€ã€3-å·²å–æ¶ˆã€4-å·²è¿‡æœŸ
- **è¯¾ç¨‹çŠ¶æ€**ï¼š1-å¾…ä¸Šè¯¾ã€2-å·²ä¸Šè¯¾ã€3-å·²å–æ¶ˆ
- **èµ„æºå ç”¨çŠ¶æ€**ï¼š5-å¾…æ”¯ä»˜å ç”¨ã€6-å·²ç¡®è®¤é¢„çº¦

### æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
1. **å¾…æ”¯ä»˜é˜¶æ®µ**ï¼šåªåœ¨èµ„æºæ—¶é—´è¡¨ä¸­åˆ›å»ºå ç”¨è®°å½•ï¼Œä¸ç”Ÿæˆé¢„çº¦å’Œè¯¾ç¨‹è®°å½•
2. **å·²æ”¯ä»˜é˜¶æ®µ**ï¼šåˆ›å»ºé¢„çº¦è®°å½•å’Œè¯¾ç¨‹è®°å½•ï¼Œèµ„æºå ç”¨è½¬ä¸ºå·²ç¡®è®¤çŠ¶æ€
3. **è¿‡æœŸå¤„ç†**ï¼šæ”¯ä»˜è¶…æ—¶è‡ªåŠ¨é‡Šæ”¾èµ„æºï¼Œé¢„çº¦è¿‡æœŸè‡ªåŠ¨é€€æ¬¾

## ğŸ”„ å…¨é“¾è·¯ä¸šåŠ¡æµç¨‹

### 1. è®¢å•åˆ›å»ºæµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·é€‰æ‹©æ—¶é—´] --> B[æ£€æŸ¥èµ„æºå¯ç”¨æ€§]
    B --> C{èµ„æºæ˜¯å¦å¯ç”¨}
    C -->|å¦| D[è¿”å›å†²çªæç¤º]
    C -->|æ˜¯| E[åˆ›å»ºè®¢å•-å¾…æ”¯ä»˜]
    E --> F[å ç”¨èµ„æºæ—¶é—´æ®µ]
    F --> G[è¿”å›è®¢å•å·å’Œæ”¯ä»˜ä¿¡æ¯]
    G --> H[ç”¨æˆ·æ”¯ä»˜]
    H --> I{æ”¯ä»˜æ˜¯å¦æˆåŠŸ}
    I -->|å¦| J[æ”¯ä»˜å¤±è´¥]
    I -->|æ˜¯| K[è®¢å•çŠ¶æ€-å·²æ”¯ä»˜]
    K --> L[èµ„æºå ç”¨è½¬ç¡®è®¤é¢„çº¦]
    L --> M[åˆ›å»ºé¢„çº¦è®°å½•]
    M --> N[åˆ›å»ºè¯¾ç¨‹è®°å½•]
    N --> O[å‘é€ç¡®è®¤é€šçŸ¥]
```

### 2. çŠ¶æ€æµè½¬å…³ç³»

```mermaid
stateDiagram-v2
    [*] --> å¾…æ”¯ä»˜: åˆ›å»ºè®¢å•
    å¾…æ”¯ä»˜ --> å·²æ”¯ä»˜: æ”¯ä»˜æˆåŠŸ
    å¾…æ”¯ä»˜ --> å·²å–æ¶ˆ: æ”¯ä»˜è¶…æ—¶/ç”¨æˆ·å–æ¶ˆ
    å·²æ”¯ä»˜ --> å·²æ ¸é”€: åˆ°åº—ä¸Šè¯¾
    å·²æ”¯ä»˜ --> å·²é€€æ¬¾: ç”¨æˆ·å–æ¶ˆ
    å·²æ ¸é”€ --> [*]: æµç¨‹ç»“æŸ
    å·²å–æ¶ˆ --> [*]: æµç¨‹ç»“æŸ
    å·²é€€æ¬¾ --> [*]: æµç¨‹ç»“æŸ
```

## ğŸ“Š æ•°æ®åº“æ”¹é€ æ–¹æ¡ˆ

### 1. èµ„æºæ—¶é—´è¡¨çŠ¶æ€æ‰©å±•

```sql
-- æ‰©å±•èµ„æºæ—¶é—´è¡¨çŠ¶æ€
ALTER TABLE m_resource_schedule 
MODIFY COLUMN status tinyint DEFAULT 1 NOT NULL 
COMMENT 'çŠ¶æ€: 1-è¯·å‡ 2-å ç”¨ 3-ç»´æŠ¤ 4-å…¶ä»– 5-å¾…æ”¯ä»˜å ç”¨ 6-å·²ç¡®è®¤é¢„çº¦';

-- æ·»åŠ è®¢å•å…³è”å­—æ®µ
ALTER TABLE m_resource_schedule 
ADD COLUMN order_no varchar(50) DEFAULT NULL COMMENT 'å…³è”è®¢å•å·',
ADD COLUMN expire_time datetime DEFAULT NULL COMMENT 'è¿‡æœŸæ—¶é—´ï¼ˆå¾…æ”¯ä»˜å ç”¨ï¼‰';

-- æ·»åŠ ç´¢å¼•
CREATE INDEX idx_order_no ON m_resource_schedule(order_no);
CREATE INDEX idx_expire_time ON m_resource_schedule(expire_time);
```

### 2. è®¢å•è¡¨å­—æ®µå®Œå–„

```sql
-- æ·»åŠ æ”¯ä»˜ç›¸å…³å­—æ®µ
ALTER TABLE m_order 
ADD COLUMN payment_expire_time datetime DEFAULT NULL COMMENT 'æ”¯ä»˜è¿‡æœŸæ—¶é—´',
ADD COLUMN auto_cancel_flag tinyint DEFAULT 0 COMMENT 'æ˜¯å¦è‡ªåŠ¨å–æ¶ˆ: 0-å¦ 1-æ˜¯';
```

### 3. é¢„çº¦è¡¨è°ƒæ•´

```sql
-- é¢„çº¦è¡¨çŠ¶æ€æ³¨é‡Šæ›´æ–°
ALTER TABLE m_booking 
MODIFY COLUMN booking_status tinyint NOT NULL DEFAULT '1' 
COMMENT 'é¢„çº¦çŠ¶æ€: 1-å·²é¢„çº¦ 2-å·²æ ¸é”€ 3-å·²å–æ¶ˆ 4-å·²è¿‡æœŸ';

-- æ·»åŠ è¿‡æœŸå¤„ç†å­—æ®µ
ALTER TABLE m_booking
ADD COLUMN expire_date date DEFAULT NULL COMMENT 'é¢„çº¦è¿‡æœŸæ—¥æœŸ';
```

## ğŸ’» åç«¯ä»£ç æ”¹é€ 

### 1. æ–°å¢èµ„æºæ—¶é—´ç®¡ç†æœåŠ¡

**ResourceScheduleService.java**

```java
@Service
@Slf4j
public class ResourceScheduleService {
    
    @Resource
    private ResourceScheduleDao resourceScheduleDao;
    
    /**
     * æ£€æŸ¥èµ„æºå¯ç”¨æ€§
     */
    public ResponseDTO<Boolean> checkResourceAvailability(
            Long clubId, Integer resourceType, Long resourceId, 
            LocalDate date, LocalTime startTime, LocalTime endTime) {
        
        LambdaQueryWrapper<ResourceScheduleEntity> wrapper = new LambdaQueryWrapper<>();
        wrapper.eq(ResourceScheduleEntity::getClubId, clubId)
               .eq(ResourceScheduleEntity::getResourceType, resourceType)
               .eq(ResourceScheduleEntity::getResourceId, resourceId)
               .eq(ResourceScheduleEntity::getScheduleDate, date)
               .and(w -> w.le(ResourceScheduleEntity::getStartTime, startTime)
                          .ge(ResourceScheduleEntity::getEndTime, endTime)
                        .or()
                        .between(ResourceScheduleEntity::getStartTime, startTime, endTime)
                        .or()  
                        .between(ResourceScheduleEntity::getEndTime, startTime, endTime));
        
        Long count = resourceScheduleDao.selectCount(wrapper);
        return ResponseDTO.ok(count == 0);
    }
    
    /**
     * å ç”¨èµ„æºæ—¶é—´æ®µï¼ˆå¾…æ”¯ä»˜ï¼‰
     */
    @Transactional(rollbackFor = Exception.class)
    public ResponseDTO<Void> occupyResourceTimeSlot(
            String orderNo, Long clubId, Integer resourceType, Long resourceId,
            LocalDate date, LocalTime startTime, LocalTime endTime, 
            LocalDateTime expireTime) {
        
        ResourceScheduleEntity entity = new ResourceScheduleEntity();
        entity.setClubId(clubId);
        entity.setResourceType(resourceType);
        entity.setResourceId(resourceId);
        entity.setScheduleDate(date);
        entity.setStartTime(startTime);
        entity.setEndTime(endTime);
        entity.setStatus(5); // å¾…æ”¯ä»˜å ç”¨
        entity.setTitle("å¾…æ”¯ä»˜å ç”¨");
        entity.setDescription("è®¢å•å·:" + orderNo);
        entity.setOrderNo(orderNo);
        entity.setExpireTime(expireTime);
        entity.setCreatedBy("system");
        
        resourceScheduleDao.insert(entity);
        return ResponseDTO.ok();
    }
    
    /**
     * ç¡®è®¤èµ„æºé¢„çº¦ï¼ˆå·²æ”¯ä»˜ï¼‰
     */
    @Transactional(rollbackFor = Exception.class) 
    public ResponseDTO<Void> confirmResourceBooking(String orderNo) {
        LambdaUpdateWrapper<ResourceScheduleEntity> wrapper = new LambdaUpdateWrapper<>();
        wrapper.set(ResourceScheduleEntity::getStatus, 6) // å·²ç¡®è®¤é¢„çº¦
               .set(ResourceScheduleEntity::getTitle, "å·²ç¡®è®¤é¢„çº¦") 
               .set(ResourceScheduleEntity::getExpireTime, null)
               .set(ResourceScheduleEntity::getUpdatedBy, "system")
               .set(ResourceScheduleEntity::getUpdateTime, LocalDateTime.now())
               .eq(ResourceScheduleEntity::getOrderNo, orderNo)
               .eq(ResourceScheduleEntity::getStatus, 5);
        
        resourceScheduleDao.update(null, wrapper);
        return ResponseDTO.ok();
    }
    
    /**
     * é‡Šæ”¾èµ„æºæ—¶é—´æ®µ
     */
    @Transactional(rollbackFor = Exception.class)
    public ResponseDTO<Void> releaseResourceTimeSlot(String orderNo) {
        LambdaQueryWrapper<ResourceScheduleEntity> wrapper = new LambdaQueryWrapper<>();
        wrapper.eq(ResourceScheduleEntity::getOrderNo, orderNo);
        
        resourceScheduleDao.delete(wrapper);
        return ResponseDTO.ok();
    }
    
    /**
     * è·å–èµ„æºå¯ç”¨æ—¶é—´æ®µ
     */
    public ResponseDTO<List<TimeSlotVO>> getAvailableTimeSlots(
            Long clubId, Integer resourceType, Long resourceId, LocalDate date) {
        
        // 1. è·å–ä¿±ä¹éƒ¨è¥ä¸šæ—¶é—´
        ClubEntity club = clubDao.selectById(clubId);
        if (club == null) {
            return ResponseDTO.userErrorParam("ä¿±ä¹éƒ¨ä¸å­˜åœ¨");
        }
        
        // 2. è·å–å·²å ç”¨æ—¶é—´æ®µ
        LambdaQueryWrapper<ResourceScheduleEntity> wrapper = new LambdaQueryWrapper<>();
        wrapper.eq(ResourceScheduleEntity::getClubId, clubId)
               .eq(ResourceScheduleEntity::getResourceType, resourceType)
               .eq(ResourceScheduleEntity::getResourceId, resourceId)
               .eq(ResourceScheduleEntity::getScheduleDate, date)
               .in(ResourceScheduleEntity::getStatus, Arrays.asList(1,2,3,4,5,6));
        
        List<ResourceScheduleEntity> occupiedSlots = resourceScheduleDao.selectList(wrapper);
        
        // 3. è®¡ç®—å¯ç”¨æ—¶é—´æ®µ
        List<TimeSlotVO> availableSlots = calculateAvailableSlots(
                club.getBusinessStartTime(), club.getBusinessEndTime(), occupiedSlots);
        
        return ResponseDTO.ok(availableSlots);
    }
    
    /**
     * è®¡ç®—å¯ç”¨æ—¶é—´æ®µ
     */
    private List<TimeSlotVO> calculateAvailableSlots(
            LocalTime businessStart, LocalTime businessEnd,
            List<ResourceScheduleEntity> occupiedSlots) {
        
        List<TimeSlotVO> availableSlots = new ArrayList<>();
        
        // æŒ‰å¼€å§‹æ—¶é—´æ’åºå ç”¨æ—¶é—´æ®µ
        occupiedSlots.sort(Comparator.comparing(ResourceScheduleEntity::getStartTime));
        
        LocalTime currentTime = businessStart;
        
        for (ResourceScheduleEntity occupied : occupiedSlots) {
            // å¦‚æœå½“å‰æ—¶é—´æ—©äºå ç”¨å¼€å§‹æ—¶é—´ï¼Œè¯´æ˜æœ‰å¯ç”¨æ—¶é—´æ®µ
            if (currentTime.isBefore(occupied.getStartTime())) {
                TimeSlotVO slot = new TimeSlotVO();
                slot.setStartTime(currentTime);
                slot.setEndTime(occupied.getStartTime());
                availableSlots.add(slot);
            }
            
            // æ›´æ–°å½“å‰æ—¶é—´ä¸ºå ç”¨ç»“æŸæ—¶é—´
            if (occupied.getEndTime().isAfter(currentTime)) {
                currentTime = occupied.getEndTime();
            }
        }
        
        // æ£€æŸ¥æœ€åä¸€ä¸ªæ—¶é—´æ®µåˆ°è¥ä¸šç»“æŸæ—¶é—´
        if (currentTime.isBefore(businessEnd)) {
            TimeSlotVO slot = new TimeSlotVO();
            slot.setStartTime(currentTime);
            slot.setEndTime(businessEnd);
            availableSlots.add(slot);
        }
        
        return availableSlots;
    }
}
```

### 2. æ”¹é€ HomeService.createOrder()

**HomeService.java**

```java
@Service
@Slf4j
public class HomeService {
    
    @Resource
    private ResourceScheduleService resourceScheduleService;
    @Resource
    private OrderDao orderDao;
    @Resource
    private ClubDao clubDao;
    @Resource
    private CoachDao coachDao;
    @Resource
    private ProductDao productDao;
    
    /**
     * åˆ›å»ºè®¢å• - å®Œæ•´å®ç°
     */
    @Transactional(rollbackFor = Exception.class)
    public ResponseDTO<OrderCreateVO> createOrder(OrderCreateForm form) {
        try {
            // 1. æ•°æ®æ ¡éªŒ
            ResponseDTO<ValidationResult> validationResult = validateOrderCreateForm(form);
            if (!validationResult.ok()) {
                return ResponseDTO.error(validationResult.getCode(), validationResult.getMsg());
            }
            
            ValidationResult validation = validationResult.getData();
            ClubEntity club = validation.getClub();
            CoachEntity coach = validation.getCoach();
            ProductEntity product = validation.getProduct();
            
            // 2. æ£€æŸ¥æ—¶é—´æ®µå¯ç”¨æ€§
            for (BookingTimeVO timeInfo : form.getTimes()) {
                LocalDate date = LocalDate.parse(timeInfo.getDate());
                
                for (String timeSlot : timeInfo.getTimeSlots()) {
                    String[] times = timeSlot.split("-");
                    LocalTime startTime = LocalTime.parse(times[0]);
                    LocalTime endTime = LocalTime.parse(times[1]);
                    
                    // æ£€æŸ¥æ•™ç»ƒå¯ç”¨æ€§
                    ResponseDTO<Boolean> coachAvailable = resourceScheduleService
                            .checkResourceAvailability(club.getClubId(), 2, coach.getCoachId(), 
                                                     date, startTime, endTime);
                    
                    if (!coachAvailable.getData()) {
                        return ResponseDTO.userErrorParam(
                                String.format("æ•™ç»ƒ%såœ¨%s %sæ—¶é—´æ®µä¸å¯ç”¨", 
                                            coach.getActualName(), date, timeSlot));
                    }
                }
            }
            
            // 3. ç”Ÿæˆè®¢å•å·
            String orderNo = generateOrderNo();
            
            // 4. åˆ›å»ºè®¢å•è®°å½•
            OrderEntity order = buildOrderEntity(form, validation, orderNo);
            order.setOrderStatus(1); // å¾…æ”¯ä»˜
            order.setPaymentExpireTime(LocalDateTime.now().plusMinutes(30)); // 30åˆ†é’Ÿæ”¯ä»˜æœŸé™
            orderDao.insert(order);
            
            // 5. å ç”¨æ•™ç»ƒæ—¶é—´æ®µ
            LocalDateTime expireTime = LocalDateTime.now().plusMinutes(30);
            for (BookingTimeVO timeInfo : form.getTimes()) {
                LocalDate date = LocalDate.parse(timeInfo.getDate());
                
                for (String timeSlot : timeInfo.getTimeSlots()) {
                    String[] times = timeSlot.split("-");
                    LocalTime startTime = LocalTime.parse(times[0]);
                    LocalTime endTime = LocalTime.parse(times[1]);
                    
                    resourceScheduleService.occupyResourceTimeSlot(
                            orderNo, club.getClubId(), 2, coach.getCoachId(),
                            date, startTime, endTime, expireTime);
                }
            }
            
            // 6. æ„å»ºå“åº”
            OrderCreateVO vo = buildOrderCreateVO(order);
            
            log.info("è®¢å•åˆ›å»ºæˆåŠŸï¼Œè®¢å•å·ï¼š{}", orderNo);
            return ResponseDTO.ok(vo);
            
        } catch (Exception e) {
            log.error("åˆ›å»ºè®¢å•å¤±è´¥", e);
            return ResponseDTO.error(SystemErrorCode.SYSTEM_ERROR, "åˆ›å»ºè®¢å•å¤±è´¥");
        }
    }
    
    /**
     * è®¢å•æ•°æ®æ ¡éªŒ
     */
    private ResponseDTO<ValidationResult> validateOrderCreateForm(OrderCreateForm form) {
        ValidationResult result = new ValidationResult();
        
        // 1. æ ¡éªŒä¿±ä¹éƒ¨
        ClubEntity club = clubDao.getByClubCode(form.getClubCode());
        if (club == null) {
            return ResponseDTO.userErrorParam("ä¿±ä¹éƒ¨ä¸å­˜åœ¨");
        }
        result.setClub(club);
        
        // 2. æ ¡éªŒæ•™ç»ƒ
        CoachEntity coach = coachDao.getByCoachNo(form.getCoachNo());
        if (coach == null) {
            return ResponseDTO.userErrorParam("æ•™ç»ƒä¸å­˜åœ¨");
        }
        if (!coach.getClubId().equals(club.getClubId())) {
            return ResponseDTO.userErrorParam("æ•™ç»ƒä¸å±äºè¯¥ä¿±ä¹éƒ¨");
        }
        result.setCoach(coach);
        
        // 3. æ ¡éªŒè¯¾ç¨‹
        ProductEntity product = productDao.getByCourseCode(form.getCourseCode());
        if (product == null) {
            return ResponseDTO.userErrorParam("è¯¾ç¨‹ä¸å­˜åœ¨");
        }
        if (!product.getClubId().equals(club.getClubId())) {
            return ResponseDTO.userErrorParam("è¯¾ç¨‹ä¸å±äºè¯¥ä¿±ä¹éƒ¨");
        }
        result.setProduct(product);
        
        // 4. æ ¡éªŒæ—¶é—´æ ¼å¼
        for (BookingTimeVO timeInfo : form.getTimes()) {
            try {
                LocalDate.parse(timeInfo.getDate());
                for (String timeSlot : timeInfo.getTimeSlots()) {
                    if (!timeSlot.matches("\\d{2}:\\d{2}-\\d{2}:\\d{2}")) {
                        return ResponseDTO.userErrorParam("æ—¶é—´æ ¼å¼é”™è¯¯ï¼š" + timeSlot);
                    }
                }
            } catch (Exception e) {
                return ResponseDTO.userErrorParam("æ—¥æœŸæ ¼å¼é”™è¯¯ï¼š" + timeInfo.getDate());
            }
        }
        
        // 5. æ ¡éªŒé‡‘é¢
        BigDecimal expectedTotal = form.getCoachFee().add(form.getBaseFee());
        if (expectedTotal.compareTo(form.getTotalAmount()) != 0) {
            return ResponseDTO.userErrorParam("é‡‘é¢è®¡ç®—é”™è¯¯");
        }
        
        return ResponseDTO.ok(result);
    }
    
    /**
     * æ„å»ºè®¢å•å®ä½“
     */
    private OrderEntity buildOrderEntity(OrderCreateForm form, ValidationResult validation, String orderNo) {
        OrderEntity order = new OrderEntity();
        order.setOrderNo(orderNo);
        order.setClubId(validation.getClub().getClubId());
        order.setMemberId(getCurrentMemberId());
        order.setOrderType(1); // è¯¾ç¨‹è®¢å•
        order.setOrderStatus(1); // å¾…æ”¯ä»˜
        order.setTotalAmount(form.getTotalAmount());
        order.setPaidAmount(BigDecimal.ZERO);
        order.setPaymentMethod("");
        order.setRemark("");
        
        // è®¾ç½®å•†å“ä¿¡æ¯ï¼ˆåˆå¹¶åçš„å­—æ®µï¼‰
        order.setProductId(validation.getProduct().getProductId());
        order.setProductName(validation.getProduct().getProductName());
        order.setProductType(validation.getProduct().getProductType());
        order.setQuantity(calculateTotalQuantity(form.getTimes()));
        order.setUnitPrice(calculateUnitPrice(form.getTotalAmount(), order.getQuantity()));
        order.setCoachId(validation.getCoach().getCoachId());
        order.setPreferredTimes(JSON.toJSONString(form.getTimes()));
        
        order.setCreateBy("member");
        return order;
    }
    
    /**
     * è®¡ç®—æ€»è¯¾æ—¶æ•°
     */
    private Integer calculateTotalQuantity(List<BookingTimeVO> times) {
        return times.stream()
                   .mapToInt(timeInfo -> timeInfo.getTimeSlots().size())
                   .sum();
    }
    
    /**
     * è®¡ç®—å•ä»·
     */
    private BigDecimal calculateUnitPrice(BigDecimal totalAmount, Integer quantity) {
        return totalAmount.divide(BigDecimal.valueOf(quantity), 2, RoundingMode.HALF_UP);
    }
    
    /**
     * æ„å»ºè®¢å•åˆ›å»ºå“åº”
     */
    private OrderCreateVO buildOrderCreateVO(OrderEntity order) {
        OrderCreateVO vo = new OrderCreateVO();
        vo.setOrderNo(order.getOrderNo());
        vo.setStatus(order.getOrderStatus());
        vo.setCreateTime(order.getCreateTime());
        vo.setExpireTime(order.getPaymentExpireTime());
        
        // è®¡ç®—æ”¯ä»˜å€’è®¡æ—¶
        long countdown = Duration.between(LocalDateTime.now(), order.getPaymentExpireTime()).getSeconds();
        vo.setPaymentCountdown(Math.max(0, countdown));
        
        return vo;
    }
    
    /**
     * ç”Ÿæˆè®¢å•å·
     */
    private String generateOrderNo() {
        String timestamp = LocalDateTime.now().format(
                DateTimeFormatter.ofPattern("yyyyMMddHHmmss"));
        String randomNum = String.format("%06d", new Random().nextInt(1000000));
        return "ORD" + timestamp + randomNum;
    }
    
    /**
     * è·å–å½“å‰ä¼šå‘˜IDï¼ˆä»ç™»å½•ä¿¡æ¯ä¸­è·å–ï¼‰
     */
    private Long getCurrentMemberId() {
        // TODO: ä»å½“å‰ç™»å½•ä¿¡æ¯ä¸­è·å–ä¼šå‘˜ID
        // è¿™é‡Œæš‚æ—¶è¿”å›å›ºå®šå€¼ï¼Œå®é™…åº”è¯¥ä»SecurityContextæˆ–Sessionä¸­è·å–
        return 1L;
    }
    
    /**
     * æ ¡éªŒç»“æœå†…éƒ¨ç±»
     */
    @Data
    private static class ValidationResult {
        private ClubEntity club;
        private CoachEntity coach;
        private ProductEntity product;
    }
}
```

### 3. æ–°å¢æ”¯ä»˜æˆåŠŸå¤„ç†æ¥å£

**PaymentController.java**

```java
@RestController
@RequestMapping("/api/payment")
@Tag(name = "æ”¯ä»˜å›è°ƒ", description = "æ”¯ä»˜æˆåŠŸå›è°ƒå¤„ç†")
public class PaymentController {
    
    @Resource
    private PaymentService paymentService;
    
    /**
     * æ”¯ä»˜æˆåŠŸå›è°ƒ
     */
    @PostMapping("/callback/success")
    @Operation(summary = "æ”¯ä»˜æˆåŠŸå›è°ƒ")
    public ResponseDTO<Void> paymentSuccess(@RequestBody PaymentCallbackForm form) {
        return paymentService.handlePaymentSuccess(form);
    }
}
```

**PaymentService.java**

```java
@Service
@Slf4j
public class PaymentService {
    
    @Resource
    private OrderDao orderDao;
    @Resource
    private BookingDao bookingDao;
    @Resource
    private LessonScheduleDao lessonScheduleDao;
    @Resource
    private ResourceScheduleService resourceScheduleService;
    
    /**
     * å¤„ç†æ”¯ä»˜æˆåŠŸ
     */
    @Transactional(rollbackFor = Exception.class)
    public ResponseDTO<Void> handlePaymentSuccess(PaymentCallbackForm form) {
        try {
            // 1. æŸ¥è¯¢è®¢å•
            OrderEntity order = orderDao.getByOrderNo(form.getOrderNo());
            if (order == null) {
                return ResponseDTO.userErrorParam("è®¢å•ä¸å­˜åœ¨");
            }
            
            if (!order.getOrderStatus().equals(1)) {
                return ResponseDTO.userErrorParam("è®¢å•çŠ¶æ€å¼‚å¸¸");
            }
            
            // 2. æ›´æ–°è®¢å•çŠ¶æ€
            order.setOrderStatus(2); // å·²æ”¯ä»˜
            order.setPaidAmount(form.getPaymentAmount());
            order.setPaymentMethod(form.getPaymentMethod());
            order.setPaymentTime(LocalDateTime.now());
            orderDao.updateById(order);
            
            // 3. ç¡®è®¤èµ„æºé¢„çº¦
            resourceScheduleService.confirmResourceBooking(order.getOrderNo());
            
            // 4. åˆ›å»ºé¢„çº¦è®°å½•
            List<BookingEntity> bookings = createBookingsFromOrder(order);
            for (BookingEntity booking : bookings) {
                bookingDao.insert(booking);
                
                // 5. åˆ›å»ºè¯¾ç¨‹è®°å½•
                LessonScheduleEntity lesson = createLessonFromBooking(booking);
                lessonScheduleDao.insert(lesson);
            }
            
            log.info("æ”¯ä»˜æˆåŠŸå¤„ç†å®Œæˆï¼Œè®¢å•å·ï¼š{}", order.getOrderNo());
            return ResponseDTO.ok();
            
        } catch (Exception e) {
            log.error("å¤„ç†æ”¯ä»˜æˆåŠŸå¤±è´¥", e);
            return ResponseDTO.error(SystemErrorCode.SYSTEM_ERROR, "å¤„ç†æ”¯ä»˜å¤±è´¥");
        }
    }
    
    /**
     * ä»è®¢å•åˆ›å»ºé¢„çº¦è®°å½•
     */
    private List<BookingEntity> createBookingsFromOrder(OrderEntity order) {
        List<BookingEntity> bookings = new ArrayList<>();
        
        // è§£æé¢„çº¦æ—¶é—´ä¿¡æ¯
        String preferredTimesJson = order.getPreferredTimes();
        List<BookingTimeVO> times = JSON.parseArray(preferredTimesJson, BookingTimeVO.class);
        
        for (BookingTimeVO timeInfo : times) {
            LocalDate date = LocalDate.parse(timeInfo.getDate());
            
            for (String timeSlot : timeInfo.getTimeSlots()) {
                String[] timeParts = timeSlot.split("-");
                LocalTime startTime = LocalTime.parse(timeParts[0]);
                LocalTime endTime = LocalTime.parse(timeParts[1]);
                
                BookingEntity booking = new BookingEntity();
                booking.setOrderId(order.getOrderId());
                booking.setOrderItemId(0L); // åˆå¹¶åæ— è®¢å•æ˜ç»†
                booking.setClubId(order.getClubId());
                booking.setMemberId(order.getMemberId());
                booking.setConsumerMemberId(null); // é»˜è®¤è‡ªå·±æ¶ˆè´¹
                booking.setProductId(order.getProductId());
                booking.setCoachId(order.getCoachId());
                booking.setHorseId(0L); // TODO: ä»è®¢å•ä¸­è·å–é©¬åŒ¹ä¿¡æ¯
                booking.setStartTime(LocalDateTime.of(date, startTime));
                booking.setEndTime(LocalDateTime.of(date, endTime));
                booking.setBookingStatus(1); // å·²é¢„çº¦
                booking.setPackageConsumeCount(1);
                booking.setActualCoachFee(BigDecimal.ZERO);
                booking.setActualHorseFee(BigDecimal.ZERO);
                booking.setCreateBy("system");
                
                bookings.add(booking);
            }
        }
        
        return bookings;
    }
    
    /**
     * ä»é¢„çº¦åˆ›å»ºè¯¾ç¨‹è®°å½•
     */
    private LessonScheduleEntity createLessonFromBooking(BookingEntity booking) {
        LessonScheduleEntity lesson = new LessonScheduleEntity();
        lesson.setBookingId(booking.getBookingId());
        lesson.setScheduleNo(generateScheduleNo());
        lesson.setClubId(booking.getClubId());
        lesson.setMemberId(booking.getMemberId());
        lesson.setCoachId(booking.getCoachId());
        lesson.setHorseId(booking.getHorseId());
        lesson.setStartTime(booking.getStartTime());
        lesson.setEndTime(booking.getEndTime());
        lesson.setLessonStatus(1); // å¾…ä¸Šè¯¾
        lesson.setDuration(calculateDuration(booking.getStartTime(), booking.getEndTime()));
        lesson.setCreateBy("system");
        
        return lesson;
    }
    
    /**
     * ç”Ÿæˆè¯¾å•å·
     */
    private String generateScheduleNo() {
        String timestamp = LocalDateTime.now().format(
                DateTimeFormatter.ofPattern("yyyyMMddHHmmss"));
        String randomNum = String.format("%04d", new Random().nextInt(10000));
        return "SCH" + timestamp + randomNum;
    }
    
    /**
     * è®¡ç®—è¯¾ç¨‹æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
     */
    private Integer calculateDuration(LocalDateTime startTime, LocalDateTime endTime) {
        return (int) Duration.between(startTime, endTime).toMinutes();
    }
}
```

### 4. æ–°å¢å®šæ—¶ä»»åŠ¡å¤„ç†

**ScheduledTasks.java**

```java
@Component
@Slf4j
public class ScheduledTasks {
    
    @Resource
    private ResourceScheduleService resourceScheduleService;
    @Resource
    private OrderDao orderDao;
    @Resource
    private BookingDao bookingDao;
    
    /**
     * æ¸…ç†è¿‡æœŸçš„å¾…æ”¯ä»˜è®¢å•å ç”¨
     * æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
     */
    @Scheduled(fixedRate = 300000)
    public void cleanExpiredPaymentOccupancy() {
        try {
            // 1. æŸ¥è¯¢è¿‡æœŸçš„å¾…æ”¯ä»˜è®¢å•
            LambdaQueryWrapper<OrderEntity> wrapper = new LambdaQueryWrapper<>();
            wrapper.eq(OrderEntity::getOrderStatus, 1) // å¾…æ”¯ä»˜
                   .lt(OrderEntity::getPaymentExpireTime, LocalDateTime.now());
            
            List<OrderEntity> expiredOrders = orderDao.selectList(wrapper);
            
            for (OrderEntity order : expiredOrders) {
                // 2. æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå·²å–æ¶ˆ
                order.setOrderStatus(4);
                order.setAutoCancelFlag(1);
                orderDao.updateById(order);
                
                // 3. é‡Šæ”¾èµ„æºå ç”¨
                resourceScheduleService.releaseResourceTimeSlot(order.getOrderNo());
                
                log.info("è‡ªåŠ¨å–æ¶ˆè¿‡æœŸè®¢å•ï¼š{}", order.getOrderNo());
            }
            
            if (!expiredOrders.isEmpty()) {
                log.info("æ‰¹é‡å¤„ç†è¿‡æœŸè®¢å•å®Œæˆï¼Œå…±å¤„ç†{}ä¸ªè®¢å•", expiredOrders.size());
            }
            
        } catch (Exception e) {
            log.error("æ¸…ç†è¿‡æœŸè®¢å•å¤±è´¥", e);
        }
    }
    
    /**
     * å¤„ç†è¿‡æœŸé¢„çº¦
     * æ¯å¤©å‡Œæ™¨1ç‚¹æ‰§è¡Œ
     */
    @Scheduled(cron = "0 0 1 * * ?")
    public void handleExpiredBookings() {
        try {
            LocalDate yesterday = LocalDate.now().minusDays(1);
            
            // 1. æŸ¥è¯¢æ˜¨å¤©çš„æœªä¸Šè¯¾é¢„çº¦
            LambdaQueryWrapper<BookingEntity> wrapper = new LambdaQueryWrapper<>();
            wrapper.eq(BookingEntity::getBookingStatus, 1) // å·²é¢„çº¦
                   .lt(BookingEntity::getStartTime, yesterday.plusDays(1).atStartOfDay());
            
            List<BookingEntity> expiredBookings = bookingDao.selectList(wrapper);
            
            for (BookingEntity booking : expiredBookings) {
                // 2. æ›´æ–°é¢„çº¦çŠ¶æ€ä¸ºå·²è¿‡æœŸ
                booking.setBookingStatus(4);
                bookingDao.updateById(booking);
                
                // 3. TODO: è§¦å‘è‡ªåŠ¨é€€æ¬¾æµç¨‹
                processAutoRefund(booking);
                
                log.info("å¤„ç†è¿‡æœŸé¢„çº¦ï¼šé¢„çº¦ID={}", booking.getBookingId());
            }
            
            if (!expiredBookings.isEmpty()) {
                log.info("æ‰¹é‡å¤„ç†è¿‡æœŸé¢„çº¦å®Œæˆï¼Œå…±å¤„ç†{}ä¸ªé¢„çº¦", expiredBookings.size());
            }
            
        } catch (Exception e) {
            log.error("å¤„ç†è¿‡æœŸé¢„çº¦å¤±è´¥", e);
        }
    }
    
    /**
     * å¤„ç†è‡ªåŠ¨é€€æ¬¾
     */
    private void processAutoRefund(BookingEntity booking) {
        // TODO: å®ç°è‡ªåŠ¨é€€æ¬¾é€»è¾‘
        log.info("è§¦å‘è‡ªåŠ¨é€€æ¬¾ï¼šé¢„çº¦ID={}", booking.getBookingId());
    }
}
```

## ğŸ¨ å‰ç«¯ä»£ç è°ƒæ•´

### 1. APIæ¥å£è·¯å¾„ç»Ÿä¸€

**order-api.js**

```javascript
export const orderApi = {
  /**
   * åˆ›å»ºè®¢å•
   */
  createOrder: (data) => {
    return postRequest('/app/home/order/create', data); // ä¿®æ­£è·¯å¾„
  },
  
  /**
   * æŸ¥è¯¢è®¢å•è¯¦æƒ…
   */
  getOrderDetail: (orderNo) => {
    return getRequest(`/app/home/order/detail/${orderNo}`);
  },
  
  /**
   * å–æ¶ˆè®¢å•
   */
  cancelOrder: (orderNo, reason) => {
    return postRequest('/app/home/order/cancel', { orderNo, reason });
  }
};
```

### 2. è®¢å•åˆ›å»ºè¡¨å•éªŒè¯

**OrderCreate.vue**

```javascript
// è¡¨å•éªŒè¯è§„åˆ™
const rules = {
  clubCode: [
    { required: true, message: 'è¯·é€‰æ‹©ä¿±ä¹éƒ¨', trigger: 'change' }
  ],
  coachNo: [
    { required: true, message: 'è¯·é€‰æ‹©æ•™ç»ƒ', trigger: 'change' }
  ],
  courseCode: [
    { required: true, message: 'è¯·é€‰æ‹©è¯¾ç¨‹', trigger: 'change' }
  ],
  times: [
    { required: true, type: 'array', min: 1, message: 'è¯·é€‰æ‹©é¢„çº¦æ—¶é—´', trigger: 'change' }
  ],
  totalAmount: [
    { required: true, message: 'é‡‘é¢ä¸èƒ½ä¸ºç©º', trigger: 'change' },
    { type: 'number', min: 0.01, message: 'é‡‘é¢å¿…é¡»å¤§äº0', trigger: 'change' }
  ]
};

// å®æ—¶æ£€æŸ¥æ•™ç»ƒå¯ç”¨æ€§
const checkCoachAvailability = async (coachId, date, timeSlots) => {
  try {
    const response = await scheduleApi.checkCoachAvailability({
      coachId,
      date,
      timeSlots
    });
    return response.data;
  } catch (error) {
    console.error('æ£€æŸ¥æ•™ç»ƒå¯ç”¨æ€§å¤±è´¥:', error);
    return false;
  }
};

// åˆ›å»ºè®¢å•
const createOrder = async (formData) => {
  try {
    loading.value = true;
    
    // 1. æœ€åä¸€æ¬¡å¯ç”¨æ€§æ£€æŸ¥
    for (const timeInfo of formData.times) {
      const available = await checkCoachAvailability(
        formData.coachNo, 
        timeInfo.date, 
        timeInfo.timeSlots
      );
      
      if (!available) {
        message.error(`${timeInfo.date} çš„æ—¶é—´æ®µå·²è¢«é¢„çº¦ï¼Œè¯·é‡æ–°é€‰æ‹©`);
        return;
      }
    }
    
    // 2. åˆ›å»ºè®¢å•
    const response = await orderApi.createOrder(formData);
    
    if (response.code === 0) {
      message.success('è®¢å•åˆ›å»ºæˆåŠŸ');
      
      // 3. è·³è½¬åˆ°æ”¯ä»˜é¡µé¢
      router.push({
        path: '/payment',
        query: {
          orderNo: response.data.orderNo,
          amount: formData.totalAmount
        }
      });
    } else {
      message.error(response.msg || 'åˆ›å»ºè®¢å•å¤±è´¥');
    }
    
  } catch (error) {
    console.error('åˆ›å»ºè®¢å•å¤±è´¥:', error);
    message.error('åˆ›å»ºè®¢å•å¤±è´¥ï¼Œè¯·é‡è¯•');
  } finally {
    loading.value = false;
  }
};
```

### 3. æ”¯ä»˜å€’è®¡æ—¶ç»„ä»¶

**PaymentCountdown.vue**

```javascript
<template>
  <div class="payment-countdown">
    <a-alert 
      :message="`è¯·åœ¨ ${formatTime(countdown)} å†…å®Œæˆæ”¯ä»˜`"
      type="warning" 
      show-icon 
      :closable="false"
    />
  </div>
</template>

<script setup>
import { ref, onMounted, onUnmounted } from 'vue';

const props = defineProps({
  expireTime: {
    type: String,
    required: true
  }
});

const countdown = ref(0);
let timer = null;

const updateCountdown = () => {
  const now = new Date().getTime();
  const expire = new Date(props.expireTime).getTime();
  const diff = expire - now;
  
  if (diff <= 0) {
    countdown.value = 0;
    clearInterval(timer);
    // è§¦å‘è®¢å•è¿‡æœŸäº‹ä»¶
    emit('expired');
  } else {
    countdown.value = Math.floor(diff / 1000);
  }
};

const formatTime = (seconds) => {
  const minutes = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${minutes}:${secs.toString().padStart(2, '0')}`;
};

onMounted(() => {
  updateCountdown();
  timer = setInterval(updateCountdown, 1000);
});

onUnmounted(() => {
  if (timer) {
    clearInterval(timer);
  }
});

const emit = defineEmits(['expired']);
</script>
```

## ğŸ—‘ éœ€è¦ç§»é™¤çš„æ— ç”¨ä»£ç 

### 1. è®¢å•æ˜ç»†è¡¨ç›¸å…³ä»£ç 

```java
// åˆ é™¤ä»¥ä¸‹æ–‡ä»¶å’Œç›¸å…³å¼•ç”¨ï¼š
// - OrderItemEntity.java
// - OrderItemDao.java  
// - OrderItemService.java
// - OrderItemController.java
// - æ‰€æœ‰ä¸ m_order_item è¡¨ç›¸å…³çš„ SQL å’Œ Mapper
```

### 2. ç®€åŒ–é¢„çº¦çŠ¶æ€å¤„ç†

```java
// BookingService.java ä¸­åˆ é™¤å¤æ‚çš„çŠ¶æ€è½¬æ¢é€»è¾‘
// ç§»é™¤ä»¥ä¸‹æ–¹æ³•ï¼š
// - updateBookingToInProgress()
// - updateBookingToCompleted() 
// - å¤æ‚çš„çŠ¶æ€éªŒè¯é€»è¾‘

// ä¿ç•™æ ¸å¿ƒæ–¹æ³•ï¼š
// - createBooking()
// - cancelBooking() 
// - updateBookingStatus()
```

### 3. ç§»é™¤å†—ä½™çš„è¯¾ç¨‹çŠ¶æ€ç®¡ç†

```java
// ScheduleService.java ä¸­åˆ é™¤ï¼š
// - å¤æ‚çš„è¯¾ç¨‹çŠ¶æ€è‡ªåŠ¨æµè½¬é€»è¾‘
// - é¢„çº¦çŠ¶æ€åˆ°è¯¾ç¨‹çŠ¶æ€çš„å¤æ‚æ˜ å°„
// - å¹¶è¡ŒçŠ¶æ€ç®¡ç†ä»£ç 
```

## ğŸ“ æ•°æ®è¿ç§»è„šæœ¬

### 1. ç°æœ‰æ•°æ®çŠ¶æ€æ˜ å°„

```sql
-- è®¢å•çŠ¶æ€ä¿æŒä¸å˜ï¼ˆå·²ç»ç¬¦åˆæ–°è®¾è®¡ï¼‰
-- è®¢å•çŠ¶æ€ï¼š1-å¾…æ”¯ä»˜ã€2-å·²æ”¯ä»˜ã€3-å·²æ ¸é”€ã€4-å·²å–æ¶ˆã€5-å·²é€€æ¬¾

-- é¢„çº¦çŠ¶æ€æ˜ å°„
UPDATE m_booking SET booking_status = CASE booking_status
    WHEN 1 THEN 1  -- å¾…ç¡®è®¤ -> å·²é¢„çº¦
    WHEN 2 THEN 1  -- å·²ç¡®è®¤ -> å·²é¢„çº¦  
    WHEN 3 THEN 1  -- è¿›è¡Œä¸­ -> å·²é¢„çº¦
    WHEN 4 THEN 2  -- å·²å®Œæˆ -> å·²æ ¸é”€
    WHEN 5 THEN 3  -- å·²å–æ¶ˆ -> å·²å–æ¶ˆ
    WHEN 6 THEN 3  -- æœªåˆ°åœº -> å·²å–æ¶ˆ
    ELSE booking_status
END;

-- è¯¾ç¨‹çŠ¶æ€æ˜ å°„
UPDATE m_lesson_schedule SET lesson_status = CASE lesson_status
    WHEN 1 THEN 1  -- å¾…ä¸Šè¯¾ -> å¾…ä¸Šè¯¾
    WHEN 2 THEN 1  -- è¿›è¡Œä¸­ -> å¾…ä¸Šè¯¾
    WHEN 3 THEN 2  -- å·²å®Œæˆ -> å·²ä¸Šè¯¾  
    WHEN 4 THEN 3  -- å·²å–æ¶ˆ -> å·²å–æ¶ˆ
    ELSE lesson_status
END;
```

### 2. ä¸ºç°æœ‰å·²æ”¯ä»˜è®¢å•åˆ›å»ºèµ„æºå ç”¨è®°å½•

```sql
-- ä¸ºæ‰€æœ‰å·²æ”¯ä»˜çš„è®¢å•åˆ›å»ºèµ„æºå ç”¨è®°å½•
INSERT INTO m_resource_schedule (
    club_id, resource_type, resource_id, schedule_date, 
    start_time, end_time, status, title, description,
    order_no, created_by, create_time
)
SELECT 
    b.club_id,
    2 as resource_type, -- æ•™ç»ƒ
    b.coach_id as resource_id,
    DATE(b.start_time) as schedule_date,
    TIME(b.start_time) as start_time,
    TIME(b.end_time) as end_time,
    6 as status, -- å·²ç¡®è®¤é¢„çº¦
    'å·²ç¡®è®¤é¢„çº¦' as title,
    CONCAT('å†å²æ•°æ®è¿ç§»-é¢„çº¦ID:', b.booking_id) as description,
    o.order_no,
    'migration' as created_by,
    NOW() as create_time
FROM m_booking b
JOIN m_order o ON b.order_id = o.order_id
WHERE o.order_status >= 2 -- å·²æ”¯ä»˜åŠä»¥ä¸ŠçŠ¶æ€
  AND b.booking_status = 1; -- å·²é¢„çº¦çŠ¶æ€
```

## ğŸ” æµ‹è¯•éªŒè¯æ–¹æ¡ˆ

### 1. å•å…ƒæµ‹è¯•

```java
@SpringBootTest
public class OrderCreateServiceTest {
    
    @Test
    public void testCreateOrder_Success() {
        // æµ‹è¯•æ­£å¸¸è®¢å•åˆ›å»ºæµç¨‹
    }
    
    @Test
    public void testCreateOrder_CoachNotAvailable() {
        // æµ‹è¯•æ•™ç»ƒæ—¶é—´å†²çªåœºæ™¯
    }
    
    @Test
    public void testPaymentSuccess_UpdateStatus() {
        // æµ‹è¯•æ”¯ä»˜æˆåŠŸåçŠ¶æ€æ›´æ–°
    }
    
    @Test
    public void testExpiredOrderCleanup() {
        // æµ‹è¯•è¿‡æœŸè®¢å•æ¸…ç†
    }
}
```

### 2. é›†æˆæµ‹è¯•

```java
@SpringBootTest
@Transactional
public class OrderFlowIntegrationTest {
    
    @Test
    public void testCompleteOrderFlow() {
        // 1. åˆ›å»ºè®¢å•
        // 2. æ£€æŸ¥èµ„æºå ç”¨
        // 3. æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸ
        // 4. éªŒè¯é¢„çº¦å’Œè¯¾ç¨‹è®°å½•åˆ›å»º
        // 5. éªŒè¯èµ„æºå ç”¨çŠ¶æ€æ›´æ–°
    }
}
```

### 3. å‹åŠ›æµ‹è¯•

- **å¹¶å‘è®¢å•åˆ›å»º**ï¼šæµ‹è¯•åŒä¸€æ—¶é—´æ®µå¤šäººé¢„çº¦çš„å¤„ç†
- **æ”¯ä»˜å›è°ƒå¹¶å‘**ï¼šæµ‹è¯•æ”¯ä»˜æˆåŠŸå›è°ƒçš„å¹¶å‘å¤„ç†
- **å®šæ—¶ä»»åŠ¡æ€§èƒ½**ï¼šæµ‹è¯•å¤§é‡è¿‡æœŸè®¢å•çš„æ¸…ç†æ€§èƒ½

## ğŸ“… å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼ˆ1å‘¨ï¼‰ï¼šåŸºç¡€æ¶æ„
- [x] æ•°æ®åº“ç»“æ„è°ƒæ•´
- [ ] ResourceScheduleService å¼€å‘
- [ ] æ ¸å¿ƒä¸šåŠ¡é€»è¾‘é‡æ„

### ç¬¬äºŒé˜¶æ®µï¼ˆ1å‘¨ï¼‰ï¼šè®¢å•æµç¨‹
- [ ] HomeService.createOrder() å®Œæ•´å®ç°  
- [ ] PaymentService æ”¯ä»˜å›è°ƒå¤„ç†
- [ ] å®šæ—¶ä»»åŠ¡å¼€å‘

### ç¬¬ä¸‰é˜¶æ®µï¼ˆ1å‘¨ï¼‰ï¼šå‰ç«¯è°ƒæ•´
- [ ] APIæ¥å£è·¯å¾„ç»Ÿä¸€
- [ ] è®¢å•åˆ›å»ºé¡µé¢è°ƒæ•´
- [ ] æ”¯ä»˜å€’è®¡æ—¶åŠŸèƒ½

### ç¬¬å››é˜¶æ®µï¼ˆ1å‘¨ï¼‰ï¼šæµ‹è¯•éƒ¨ç½²
- [ ] å•å…ƒæµ‹è¯•ç¼–å†™
- [ ] é›†æˆæµ‹è¯•éªŒè¯
- [ ] æ•°æ®è¿ç§»æ‰§è¡Œ
- [ ] ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

## âš  é£é™©æ§åˆ¶

### 1. æ•°æ®ä¸€è‡´æ€§é£é™©
- **åº”å¯¹**ï¼šä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ç¡®ä¿åŸå­æ€§
- **å›æ»š**ï¼šä¿ç•™åŸè¡¨ç»“æ„ï¼Œæ”¯æŒå¿«é€Ÿå›æ»š

### 2. å¹¶å‘å†²çªé£é™©  
- **åº”å¯¹**ï¼šæ•°æ®åº“å”¯ä¸€çº¦æŸ + ä¹è§‚é”
- **ç›‘æ§**ï¼šæ·»åŠ å¹¶å‘å†²çªç›‘æ§å‘Šè­¦

### 3. æ”¯ä»˜å›è°ƒé£é™©
- **åº”å¯¹**ï¼šå¹‚ç­‰æ€§å¤„ç† + é‡è¯•æœºåˆ¶
- **å…œåº•**ï¼šäººå·¥å¤„ç†å¼‚å¸¸è®¢å•çš„å·¥å…·

### 4. å®šæ—¶ä»»åŠ¡é£é™©
- **åº”å¯¹**ï¼šä»»åŠ¡æ‰§è¡Œæ—¥å¿— + å¼‚å¸¸é€šçŸ¥
- **ç›‘æ§**ï¼šä»»åŠ¡æ‰§è¡Œæ—¶é—´å’ŒæˆåŠŸç‡ç›‘æ§

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### 1. ä¸šåŠ¡æŒ‡æ ‡
- è®¢å•åˆ›å»ºæˆåŠŸç‡
- æ”¯ä»˜æˆåŠŸç‡  
- èµ„æºå†²çªç‡
- è®¢å•è¿‡æœŸç‡

### 2. æŠ€æœ¯æŒ‡æ ‡
- APIå“åº”æ—¶é—´
- æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½
- å®šæ—¶ä»»åŠ¡æ‰§è¡Œæ—¶é—´
- ç³»ç»Ÿå¼‚å¸¸ç‡

## ğŸ“– æ€»ç»“

æœ¬æ”¹é€ æ–¹æ¡ˆé€šè¿‡å¼•å…¥èµ„æºæ—¶é—´è¡¨ç®¡ç†ï¼Œå®ç°äº†æ›´ç¬¦åˆå®é™…ä¸šåŠ¡åœºæ™¯çš„è®¢å•æµç¨‹ï¼š

1. **ä¸šåŠ¡æµç¨‹ä¼˜åŒ–**ï¼šå¾…æ”¯ä»˜ä¸å ç”¨å®é™…é¢„çº¦èµ„æºï¼Œé¿å…èµ„æºæµªè´¹
2. **æ•°æ®ç»“æ„ç®€åŒ–**ï¼šåˆå¹¶è®¢å•æ˜ç»†åˆ°è®¢å•ä¸»è¡¨ï¼Œå‡å°‘å¤æ‚å…³è”
3. **çŠ¶æ€ç®¡ç†æ¸…æ™°**ï¼šç®€åŒ–çŠ¶æ€å®šä¹‰ï¼Œæ˜ç¡®çŠ¶æ€æµè½¬å…³ç³»  
4. **èµ„æºç®¡ç†ç»Ÿä¸€**ï¼šé€šè¿‡èµ„æºæ—¶é—´è¡¨ç»Ÿä¸€ç®¡ç†æ•™ç»ƒã€é©¬åŒ¹ç­‰èµ„æº
5. **è‡ªåŠ¨åŒ–å¤„ç†**ï¼šæ”¯æŒè¿‡æœŸè®¢å•å’Œé¢„çº¦çš„è‡ªåŠ¨å¤„ç†

æ”¹é€ åçš„ç³»ç»Ÿå°†æ›´åŠ ç¨³å®šã€é«˜æ•ˆï¼Œç”¨æˆ·ä½“éªŒä¹Ÿä¼šæ˜¾è‘—æå‡ã€‚